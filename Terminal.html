<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revolutionary Trading Terminal v2.0</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ñ–∞–π–ª –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–≤—ã–º -->
    <script src="localization.js"></script>
    <script>
        // ==================== SETTINGS MANAGER v1.0 ====================
// –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è Blueprint FX Terminal
// ================================================================

const SettingsManager = (function() {
    'use strict';
    
    // –ö–ª—é—á –¥–ª—è localStorage
    const STORAGE_KEY = 'blueprint_fx_settings';
    
    // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const DEFAULT_SETTINGS = {
        // –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
        terminal: {
            language: 'en',
            lastSymbol: 'EURUSD',
            lastTimeframe: 'H1',
            lastOrderType: 'market',
            defaultVolume: 0.01,
            defaultSL: null,
            defaultTP: null,
            slUnit: 'pips',
            tpUnit: 'pips'
        },
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ä—Ç–∞
        chart: {
            showGrid: true,
            showPriceLine: true,
            candleWidth: 10,
            visibleCandles: 100,
            scrollOffset: 0,
            theme: 'cyberpunk'
        },
        
        // –ü–æ–∑–∏—Ü–∏–∏ –æ–∫–æ–Ω
        windows: {
            quickTrade: {
                visible: false,
                position: { x: null, y: null },
                minimized: false,
                expanded: false,
                settings: {
                    volume: 0.01,
                    sl: 10,
                    tp: 30,
                    trailing: false,
                    trailingProfit: 10,
                    trailingDistance: 5,
                    breakeven: false,
                    breakevenProfit: 5,
                    orderType: 'market'
                }
            },
            themeCustomizer: {
                position: { x: null, y: null }
            }
        },
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ BPFX
        bpfx: {
            sensitivity: 50,
            channelWidth: 2.5,
            lookback: 100,
            glowEffect: true,
            showSignals: true,
            channelFill: true,
            showTPSL: true,
            slPoints: 20,
            tp1Ratio: 1,
            tp2Ratio: 2,
            tp3Ratio: 3
        },
        
        // –ö–∞—Å—Ç–æ–º–Ω–∞—è —Ç–µ–º–∞
        customTheme: null,
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–Ω–µ–ª–µ–π
        panels: {
            positionsHeight: 250,
            rightPanelTab: 'trading',
            positionsPanelTab: 'positions'
        },
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        automation: {
            presetTrailing: false,
            presetTrailingProfit: 10,
            presetTrailingDistance: 5,
            presetBreakeven: false,
            presetBreakevenProfit: 5
        },
        
        // –ò—Å—Ç–æ—Ä–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        history: {
            lastDateFrom: null,
            lastDateTo: null,
            lastFilter: 'all'
        }
    };
    
    let settings = {};
    let saveTimeout = null;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
        loadSettings();
        setupAutoSave();
        console.log('‚öôÔ∏è Settings Manager initialized');
        return settings;
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ localStorage
    function loadSettings() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const parsed = JSON.parse(stored);
                settings = deepMerge(DEFAULT_SETTINGS, parsed);
                console.log('‚úÖ Settings loaded from localStorage');
            } else {
                settings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
                console.log('üìù Using default settings');
            }
        } catch (error) {
            console.error('‚ùå Error loading settings:', error);
            settings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ localStorage
    function saveSettings() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
            console.log('üíæ Settings saved');
        } catch (error) {
            console.error('‚ùå Error saving settings:', error);
        }
    }
    
    // –û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (debounce)
    function saveDebounced() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveSettings, 500);
    }
    
    // –ì–ª—É–±–æ–∫–æ–µ —Å–ª–∏—è–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
    function deepMerge(target, source) {
        const result = Object.assign({}, target);
        
        for (const key in source) {
            if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                if (target[key] && typeof target[key] === 'object') {
                    result[key] = deepMerge(target[key], source[key]);
                } else {
                    result[key] = source[key];
                }
            } else {
                result[key] = source[key];
            }
        }
        
        return result;
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    function get(path, defaultValue = null) {
        const keys = path.split('.');
        let value = settings;
        
        for (const key of keys) {
            if (value && typeof value === 'object' && key in value) {
                value = value[key];
            } else {
                return defaultValue;
            }
        }
        
        return value;
    }
    
    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    function set(path, value) {
        const keys = path.split('.');
        let target = settings;
        
        for (let i = 0; i < keys.length - 1; i++) {
            const key = keys[i];
            if (!(key in target) || typeof target[key] !== 'object') {
                target[key] = {};
            }
            target = target[key];
        }
        
        const lastKey = keys[keys.length - 1];
        target[lastKey] = value;
        
        saveDebounced();
        
        // –í—ã–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
        window.dispatchEvent(new CustomEvent('settingsChanged', {
            detail: { path, value }
        }));
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    function getAll() {
        return JSON.parse(JSON.stringify(settings));
    }
    
    // –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º
    function reset(path = null) {
        if (path) {
            const value = get(path, null, DEFAULT_SETTINGS);
            set(path, value);
        } else {
            settings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
            saveSettings();
            window.location.reload();
        }
    }
    
    // –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
    function exportSettings() {
        const data = JSON.stringify(settings, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `blueprint_settings_${new Date().getTime()}.json`;
        a.click();
        
        URL.revokeObjectURL(url);
    }
    
    // –ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
    function importSettings(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = (event) => {
                try {
                    const imported = JSON.parse(event.target.result);
                    settings = deepMerge(DEFAULT_SETTINGS, imported);
                    saveSettings();
                    window.location.reload();
                    resolve();
                } catch (error) {
                    reject(error);
                }
            };
            
            reader.onerror = reject;
            reader.readAsText(file);
        });
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    function setupAutoSave() {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', saveSettings);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(saveSettings, 30000);
    }
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ UI
    function applyToUI() {
        // –Ø–∑—ã–∫
        if (typeof setLanguage === 'function') {
            setLanguage(settings.terminal.language);
        }
        
        // –¢–µ–º–∞
        if (settings.chart.theme && typeof changeTheme === 'function') {
            changeTheme(settings.chart.theme);
        }
        
        // –ö–∞—Å—Ç–æ–º–Ω–∞—è —Ç–µ–º–∞
        if (settings.customTheme) {
            for (const [key, value] of Object.entries(settings.customTheme)) {
                document.documentElement.style.setProperty(key, value);
            }
        }
        
        // –°–∏–º–≤–æ–ª –∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º
        const symbolSelect = document.getElementById('symbolSelect');
        if (symbolSelect && settings.terminal.lastSymbol) {
            symbolSelect.value = settings.terminal.lastSymbol;
        }
        
        // –û–±—ä–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const lotSize = document.getElementById('lotSize');
        if (lotSize && settings.terminal.defaultVolume) {
            lotSize.value = settings.terminal.defaultVolume;
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ä—Ç–∞
        const showGrid = document.getElementById('showGrid');
        if (showGrid) {
            showGrid.checked = settings.chart.showGrid;
        }
        
        const showPriceLine = document.getElementById('showPriceLine');
        if (showPriceLine) {
            showPriceLine.checked = settings.chart.showPriceLine;
        }
        
        // Quick Trade –æ–∫–Ω–æ
        if (settings.windows.quickTrade.visible) {
            const qtwWidget = document.getElementById('quickTradeWidget');
            if (qtwWidget) {
                qtwWidget.style.display = 'block';
                
                if (settings.windows.quickTrade.position.x !== null) {
                    qtwWidget.style.left = settings.windows.quickTrade.position.x + 'px';
                    qtwWidget.style.top = settings.windows.quickTrade.position.y + 'px';
                }
                
                if (settings.windows.quickTrade.minimized) {
                    qtwWidget.classList.add('minimized');
                }
            }
        }
        
        // BPFX –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        applyBPFXSettings();
        
        // –í—ã—Å–æ—Ç–∞ –ø–∞–Ω–µ–ª–∏ –ø–æ–∑–∏—Ü–∏–π
        const positionsPanel = document.querySelector('.positions-panel');
        if (positionsPanel && settings.panels.positionsHeight) {
            positionsPanel.style.height = settings.panels.positionsHeight + 'px';
        }
    }
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ BPFX
    function applyBPFXSettings() {
        const bpfx = settings.bpfx;
        
        if (document.getElementById('bpfxSensitivity')) {
            document.getElementById('bpfxSensitivity').value = bpfx.sensitivity;
            document.getElementById('bpfxSensitivityValue').textContent = bpfx.sensitivity;
            
            document.getElementById('bpfxChannelWidth').value = bpfx.channelWidth;
            document.getElementById('bpfxChannelWidthValue').textContent = bpfx.channelWidth;
            
            document.getElementById('bpfxLookback').value = bpfx.lookback;
            document.getElementById('bpfxLookbackValue').textContent = bpfx.lookback;
            
            document.getElementById('bpfxGlowEffect').checked = bpfx.glowEffect;
            document.getElementById('bpfxShowSignals').checked = bpfx.showSignals;
            document.getElementById('bpfxChannelFill').checked = bpfx.channelFill;
            document.getElementById('bpfxShowTPSL').checked = bpfx.showTPSL;
            
            document.getElementById('bpfxSLPoints').value = bpfx.slPoints;
            document.getElementById('bpfxSLPointsValue').textContent = bpfx.slPoints;
            
            document.getElementById('bpfxTP1').value = bpfx.tp1Ratio;
            document.getElementById('bpfxTP1Value').textContent = bpfx.tp1Ratio.toFixed(1);
            
            document.getElementById('bpfxTP2').value = bpfx.tp2Ratio;
            document.getElementById('bpfxTP2Value').textContent = bpfx.tp2Ratio.toFixed(1);
            
            document.getElementById('bpfxTP3').value = bpfx.tp3Ratio;
            document.getElementById('bpfxTP3Value').textContent = bpfx.tp3Ratio.toFixed(1);
        }
    }
    
    // –ü—É–±–ª–∏—á–Ω—ã–π API
    return {
        init,
        get,
        set,
        getAll,
        reset,
        exportSettings,
        importSettings,
        applyToUI,
        save: saveSettings
    };
})();

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        SettingsManager.init();
        setTimeout(() => SettingsManager.applyToUI(), 100);
    });
} else {
    SettingsManager.init();
    setTimeout(() => SettingsManager.applyToUI(), 100);
}

// –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –≥–ª–æ–±–∞–ª—å–Ω–æ
window.SettingsManager = SettingsManager;
    </script>
       
    <style>
        /* –ö—É—Ä—Å–æ—Ä—ã –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
button, .btn-buy, .btn-sell, .tool-btn, .tf-btn, .panel-tab, 
.control-btn, .action-btn, .quick-btn, .qtw-btn, .tc-tab,
.theme-option, .positions-panel-tab, select, input[type="checkbox"] {
    cursor: pointer !important;
    transition: all 0.3s;
}

/* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫—É—Ä—Å–æ—Ä –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã */
.theme-cyberpunk button:hover,
.theme-cyberpunk .tool-btn:hover {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><circle cx="12" cy="12" r="10" fill="none" stroke="%2300ffff" stroke-width="2"/><circle cx="12" cy="12" r="3" fill="%23ff00ff"/></svg>') 12 12, pointer;
}

.theme-matrix button:hover {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><rect x="4" y="4" width="16" height="16" fill="none" stroke="%2300ff00" stroke-width="2"/><circle cx="12" cy="12" r="2" fill="%2300ff00"/></svg>') 12 12, pointer;
}

.theme-neon button:hover {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><polygon points="12,2 14,8 20,9 15,13 17,20 12,16 7,20 9,13 4,9 10,8" fill="%23ff00ff" opacity="0.8"/></svg>') 12 12, pointer;
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è –∏–Ω–ø—É—Ç–æ–≤ */
input[type="text"], input[type="number"], textarea, select {
    cursor: text;
}

input[type="text"]:hover, input[type="number"]:hover {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><line x1="10" y1="3" x2="10" y2="17" stroke="%2300ffff" stroke-width="2"/></svg>') 10 10, text;
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è —Ä–µ—Å–∞–π–∑–∞ */
.panel-resizer, .axis-resize-handle {
    cursor: ns-resize !important;
}

.axis-resize-handle.x-axis {
    cursor: ew-resize !important;
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è */
.dialog-close, .qtw-close, .tc-close-btn {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><line x1="5" y1="5" x2="15" y2="15" stroke="%23ff0000" stroke-width="3"/><line x1="15" y1="5" x2="5" y2="15" stroke="%23ff0000" stroke-width="3"/></svg>') 10 10, pointer !important;
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
.qtw-header, .tc-header, .dialog-header {
    cursor: move !important;
}

.qtw-header:active, .tc-header:active {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M12,2 L12,22 M2,12 L22,12" stroke="%2300ffff" stroke-width="2"/><circle cx="12" cy="12" r="3" fill="%23ff00ff"/></svg>') 12 12, grabbing !important;
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è disabled —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
button:disabled, input:disabled, select:disabled {
    cursor: not-allowed !important;
    opacity: 0.5;
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è —Å—Å—ã–ª–æ–∫ */
a, .link {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path d="M10,3 L17,10 L10,17 L10,13 L3,13 L3,7 L10,7 Z" fill="%2300ffff"/></svg>') 10 10, pointer;
}
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #141824;
            --bg-panel: rgba(20, 24, 36, 0.95);
            --accent-primary: #00ffff;
            --accent-secondary: #ff00ff;
            --accent-tertiary: #8b5cf6;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: rgba(139, 92, 246, 0.3);
            --shadow-glow: 0 0 20px rgba(0, 255, 255, 0.3);
            --candle-bull: #00ffff;
            --candle-bear: #ff00ff;
            --candle-wick: #ffffff;
        }

        /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —è–∑—ã–∫–æ–≤ */
        .language-switcher {
            display: flex;
            gap: 8px;
            align-items: center;
            margin: 0 15px;
        }

        .lang-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            
            letter-spacing: 1px;
        }

        .lang-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
        }

        .lang-btn.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(0, 255, 255, 0.1));
            color: var(--text-primary);
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
        }

        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∞—à–∏ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
    background: var(--bg-primary);
    color: var(--text-primary);
    height: 100vh;
    overflow: hidden;
    position: relative;
    display: grid; /* –ó–ê–ú–ï–ù–ê */
    grid-template-rows: auto 1fr auto; /* –®–∞–ø–∫–∞ (auto), –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å (1fr), –°—Ç–∞—Ç—É—Å-–±–∞—Ä (auto) */
}

        /* Animated Background */
        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            opacity: 0.05;
            background: 
                radial-gradient(circle at 20% 50%, var(--accent-primary) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, var(--accent-secondary) 0%, transparent 50%);
            animation: bgPulse 10s ease-in-out infinite;
        }

        @keyframes bgPulse {
            0%, 100% { opacity: 0.05; }
            50% { opacity: 0.1; }
        }

        /* Header */
        .header {
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-stats {
            display: flex;
            gap: 30px;
        }
        

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
           
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-primary);
        }

       .main-container {
    display: grid; /* –ó–ê–ú–ï–ù–ê */
    grid-template-columns: auto 1fr auto; /* –õ–µ–≤—ã–π —Å–∞–π–¥–±–∞—Ä, –¢–æ—Ä–≥–æ–≤–∞—è –∑–æ–Ω–∞, –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å */
    overflow: hidden;
}

        /* Left Sidebar */
        .sidebar-left {
            width: 50px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            gap: 10px;
            
        }

        .tool-btn {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(0, 255, 255, 0.1));
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 16px;
        }

        .tool-btn:hover {
            transform: scale(1.1);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        .tool-btn.active {
            background: linear-gradient(135deg, var(--accent-tertiary), var(--accent-primary));
            color: var(--text-primary);
            box-shadow: 0 0 20px var(--accent-primary);
        }

        .tool-separator {
            width: 30px;
            height: 1px;
            background: var(--border);
            margin: 5px 0;
        }

        /* Central Trading Area */
       .trading-area {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 140px); /* –í—ã—á–∏—Ç–∞–µ–º –≤—ã—Å–æ—Ç—É header –∏ status bar */
    overflow: hidden;
}

        .chart-container {
    flex: 1 1 auto; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
    min-height: 300px;
    display: flex;
    flex-direction: column;
    background: var(--bg-primary);
    overflow: hidden;
}
        .chart-header {
            background: var(--bg-secondary);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .symbol-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .symbol-select {
            background: var(--bg-panel);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .price-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .current-price {
            font-size: 18px;
            font-weight: bold;
        }

        .price-change {
            font-size: 14px;
        }

        .price-up { color: var(--success); }
        .price-down { color: var(--danger); }

        .timeframe-selector {
            display: flex;
            gap: 5px;
        }

        .tf-btn {
            padding: 5px 12px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            border-radius: 4px;
        }

        .tf-btn:hover, .tf-btn.active {
            background: var(--accent-tertiary);
            color: white;
            border-color: var(--accent-tertiary);
        }

        .chart-main {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: var(--bg-primary);
}

        #tradingChart {
            width: 100%;
            height: 100%;
        }

        /* Axis resize handles */
        .axis-resize-handle {
            position: absolute;
            background: transparent;
            z-index: 50;
            transition: background 0.2s;
        }
        
        .axis-resize-handle:hover {
            background: rgba(0, 255, 255, 0.1);
        }
        
        .axis-resize-handle.y-axis {
            right: 0;
            top: 0;
            bottom: 30px;
            width: 60px;
            cursor: ns-resize;
        }
        
        .axis-resize-handle.x-axis {
            bottom: 0;
            left: 0;
            right: 60px;
            height: 30px;
            cursor: ew-resize;
        }

        /* Right Panel */
        .panel-right {
            width: 340px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
           
        }

        .panel-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .panel-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .panel-tab.active {
            color: var(--accent-primary);
        }

        .panel-tab.active:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        }

       .panel-content {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    overflow-x: hidden; /* –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ - –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
    max-height: calc(100vh - 140px);
    display: flex;
    flex-direction: column;
}

        .tab-section {
    display: none;
    flex: 1;
    overflow-y: auto; /* –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ - –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ü–∏–∏ */
}

        .tab-section.active {
    display: flex;
    flex-direction: column;
}
        /* Input Groups */
        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            
            letter-spacing: 1px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
        }

        .input-unit-toggle {
            display: flex;
            gap: 5px;
        }

        .unit-btn {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }

        .unit-btn.active {
            background: var(--accent-tertiary);
            color: white;
            border-color: var(--accent-tertiary);
        }

        /* Quick Amounts */
        .quick-amounts {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .quick-btn {
            flex: 1;
            padding: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }

        .quick-btn:hover {
            background: var(--accent-tertiary);
            color: white;
            transform: translateY(-2px);
        }

        /* Risk Management Section */
        .risk-management {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .risk-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            display: inline-block;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            transition: 0.4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background: var(--text-secondary);
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: var(--accent-tertiary);
            border-color: var(--accent-tertiary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
            background: white;
        }

        .risk-inputs {
            display: none;
            gap: 10px;
        }

        .risk-inputs.active {
            display: flex;
        }

        .risk-field {
            flex: 1;
        }

        .risk-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .risk-input {
            width: 100%;
            padding: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 14px;
        }

        .calculated-values {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .calc-value {
            color: var(--accent-primary);
            font-weight: bold;
        }

        /* Trade Buttons */
        .trade-buttons {
    display: flex;
    gap: 10px;
    margin-top: auto; /* –ò–∑–º–µ–Ω–∏—Ç—å —Å 25px –Ω–∞ auto - –ø—Ä–∏–∂–∏–º–∞–µ—Ç –∫ –Ω–∏–∑—É */
    padding-top: 15px; /* –î–æ–±–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
    flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å –∫–Ω–æ–ø–∫–∏ */
    width: 100%; 
}

        .btn-buy, .btn-sell {
    flex: 1;
    padding: 15px 10px; /* –ò–∑–º–µ–Ω–∏—Ç—å —Å 15px –Ω–∞ 15px 10px - —É–º–µ–Ω—å—à–∏—Ç—å –±–æ–∫–æ–≤—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    
    letter-spacing: 1px;
    transition: all 0.3s;
    min-width: 0; /* –î–æ–±–∞–≤–∏—Ç—å - –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∞–º —Å–∂–∏–º–∞—Ç—å—Å—è */
    overflow: hidden; /* –î–æ–±–∞–≤–∏—Ç—å - –æ–±—Ä–µ–∑–∞–µ—Ç —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è */
}

        .btn-buy {
            background: linear-gradient(135deg, var(--success), #16a34a);
            color: white;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .btn-sell {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-buy:hover, .btn-sell:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
        }

       /* Bottom Positions Panel */
.positions-panel {
    flex: 0 0 280px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ 280px */
    min-height: 150px;
    max-height: 60vh;
    background: var(--bg-panel);
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

        .positions-header {
            background: var(--bg-secondary);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .positions-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .positions-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 5px 12px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: var(--accent-tertiary);
            color: white;
            border-color: var(--accent-tertiary);
        }

      .positions-table-container {
    flex: 1;
    overflow-x: auto;
    overflow-y: auto;
}

        .positions-table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .positions-table th:nth-child(1) { width: 80px; }  /* Symbol */
.positions-table th:nth-child(2) { width: 60px; }  /* Type */
.positions-table th:nth-child(3) { width: 70px; }  /* Volume */
.positions-table th:nth-child(4) { width: 90px; }  /* Open Price */
.positions-table th:nth-child(5) { width: 90px; }  /* Current Price */
.positions-table th:nth-child(6) { width: 80px; }  /* S/L */
.positions-table th:nth-child(7) { width: 80px; }  /* T/P */
.positions-table th:nth-child(8) { width: 90px; }  /* Profit */
.positions-table th:nth-child(9) { width: 80px; }  /* Trailing */
.positions-table th:nth-child(10) { width: 80px; } /* Breakeven */
.positions-table th:nth-child(11) { width: 200px; } /* Actions */

.positions-table td:nth-child(1) { width: 80px; }  
.positions-table td:nth-child(2) { width: 60px; }  
.positions-table td:nth-child(3) { width: 70px; }  
.positions-table td:nth-child(4) { width: 90px; }  
.positions-table td:nth-child(5) { width: 90px; }  
.positions-table td:nth-child(6) { width: 80px; }  
.positions-table td:nth-child(7) { width: 80px; }  
.positions-table td:nth-child(8) { width: 90px; text-align: right; }  /* –ü—Ä–∏–±—ã–ª—å –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */
.positions-table td:nth-child(9) { width: 80px; }  
.positions-table td:nth-child(10) { width: 80px; } 
.positions-table td:nth-child(11) { width: 200px; } 

/* –¢–∞–∫–∂–µ –¥–ª—è footer —Ç–∞–±–ª–∏—Ü—ã: */
.positions-table tfoot td {
    width: auto !important;
}

        .positions-table th {
            background: var(--bg-secondary);
            padding: 10px;
            text-align: left;
            font-size: 12px;
            color: var(--text-secondary);
            
            letter-spacing: 1px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .positions-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 13px;
        }

        .positions-table tr:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .positions-table tr.selected {
            background: rgba(0, 255, 255, 0.1);
            border-left: 3px solid var(--accent-primary);
        }

        .position-symbol {
            font-weight: bold;
            color: var(--accent-primary);
        }

        .position-type-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .position-type-badge.buy {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .position-type-badge.sell {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .profit-value {
            font-weight: bold;
        }

        .profit-value.positive {
            color: var(--success);
        }

        .profit-value.negative {
            color: var(--danger);
        }

        .position-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 4px 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: var(--accent-tertiary);
            color: white;
        }

        /* Position Settings Dialog */
        .position-settings-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-panel);
            border: 1px solid var(--accent-primary);
            border-radius: 15px;
            padding: 25px;
            z-index: 2000;
            min-width: 500px;
            display: none;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.3);
        }

        .position-settings-dialog.active {
            display: block;
        }

        .dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .dialog-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .dialog-close {
            width: 30px;
            height: 30px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .dialog-close:hover {
            background: var(--danger);
            color: white;
        }

        .dialog-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .setting-section {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
        }

        .setting-title {
            font-size: 14px;
            color: var(--accent-primary);
            margin-bottom: 10px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .setting-value-input {
            width: 120px;
            padding: 6px 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 6px;
            text-align: right;
        }

        .apply-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .apply-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 255, 0.4);
        }

        


        .info-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

        .info-label {
            color: var(--text-secondary);
        }

        .info-value {
            color: var(--text-primary);
            font-weight: bold;
        }

        /* Drawing Tools Panel */
        .drawing-tools-panel {
            position: absolute;
            top: 60px;
            left: 60px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px;
            display: none;
            z-index: 200;
            flex-direction: column;
            gap: 10px;
        }

        .drawing-tools-panel.active {
            display: flex;
        }

        .drawing-color-picker {
            display: flex;
            gap: 5px;
        }

        .color-option {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .color-option:hover {
            transform: scale(1.2);
        }

        .color-option.selected {
            box-shadow: 0 0 0 2px var(--accent-primary);
        }

        /* Text Input for Drawing */
        .text-input-overlay {
            position: absolute;
            background: var(--bg-panel);
            border: 1px solid var(--accent-primary);
            border-radius: 8px;
            padding: 10px;
            display: none;
            z-index: 300;
        }

        .text-input-overlay.active {
            display: block;
        }

        .text-input-field {
            padding: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 6px;
            width: 200px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            background: var(--bg-panel);
            border: 1px solid var(--accent-primary);
            border-radius: 8px;
            box-shadow: 0 0 20px var(--accent-primary);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-color: var(--success);
            box-shadow: 0 0 20px var(--success);
        }

        .notification.error {
            border-color: var(--danger);
            box-shadow: 0 0 20px var(--danger);
        }

        /* Loader */
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        .loader.active {
            display: block;
        }

        .loader-ring {
            width: 60px;
            height: 60px;
            border: 3px solid transparent;
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

        /* Status Bar */
        .status-bar {
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--success);
        }

        .status-dot.disconnected {
            background: var(--danger);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        .status-info {
            display: flex;
            gap: 20px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Theme Variations for Candles */
        .theme-matrix {
            --candle-bull: #00ff00;
            --candle-bear: #ff0000;
            --candle-wick: #00ff00;
        }

        .theme-dark {
            --candle-bull: #4caf50;
            --candle-bear: #f44336;
            --candle-wick: #888888;
        }

        .theme-light {
            --candle-bull: #4caf50;
            --candle-bear: #f44336;
            --candle-wick: #333333;
        }

        .theme-ocean {
            --candle-bull: #00e5ff;
            --candle-bear: #ff1744;
            --candle-wick: #80deea;
        }

        .theme-sunset {
            --candle-bull: #ffeb3b;
            --candle-bear: #ff5722;
            --candle-wick: #ffa726;
        }

        .theme-neon {
            --candle-bull: #00ff00;
            --candle-bear: #ff0080;
            --candle-wick: #ff00ff;
        }

        .theme-royal {
            --candle-bull: #ffd700;
            --candle-bear: #dc143c;
            --candle-wick: #daa520;
        }
.demo-badge {
    background-color: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: bold;
    border: 1px solid #f59e0b;
    
    letter-spacing: 1px;
}
/* Styles for Positions Summary Footer */
.positions-table tfoot {
    background: var(--bg-secondary);
    font-weight: bold;
}

.summary-row td {
    border-top: 2px solid var(--accent-primary);
    padding: 12px 10px;
    font-size: 14px;
    color: var(--text-primary);
}

#totalProfit {
    font-size: 15px;
}
/* Resizable panels */
.chart-container {
    min-height: 200px;
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg-primary);
}

.positions-panel {
    min-height: 150px;
    max-height: 50vh;
    height: 250px; /* –ù–∞—á–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
    background: var(--bg-panel);
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    resize: vertical;
    overflow: auto;
}

/* Panel Resizer */
.panel-resizer {
    height: 4px;
    background: var(--border);
    cursor: ns-resize;
    flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞–µ—Ç—Å—è */
}
.panel-resizer:hover {
    background: var(--accent-primary);
}

.panel-resizer:active {
    background: var(--accent-secondary);
}
.order-type-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.order-type-btn {
    flex: 1;
    padding: 10px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 14px;
}

.order-type-btn:hover {
    background: var(--accent-tertiary);
    color: white;
    transform: translateY(-2px);
}

.order-type-btn.active {
    background: var(--accent-tertiary);
    color: white;
    border-color: var(--accent-tertiary);
    box-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
}

.limit-price-info {
    margin-top: 10px;
    font-size: 12px;
    color: var(--text-secondary);
    text-align: center;
}

#limitPriceDistance {
    color: var(--accent-primary);
    font-weight: bold;
}

.btn-buy.limit-order {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
}

.btn-sell.limit-order {
    background: linear-gradient(135deg, #f97316, #ea580c);
}
/* Positions Panel Tabs */
.positions-panel-tabs {
    display: flex;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
}

.positions-panel-tab {
    padding: 10px 20px;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 13px;
    font-weight: bold;
    
    letter-spacing: 1px;
    position: relative;
    transition: all 0.3s;
}

.positions-panel-tab.active {
    color: var(--accent-primary);
}

.positions-panel-tab.active:after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: var(--accent-primary);
}

.positions-panel-tab-content {
    display: none;
    flex: 1;
    overflow: hidden;
    flex-direction: column;
}

.positions-panel-tab-content.active {
    display: flex;
}

.pending-orders-badge {
    background: var(--accent-tertiary);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 11px;
    margin-left: 5px;
}
    </style>
</head>
<body>
    <div class="bg-animation"></div>

 <div class="header">
    <div class="logo-container" style="display: flex; align-items: center; gap: 15px;">
        <div class="logo">BluePrint (beta 1.05 )</div>
        <span id="accountMode"></span>
    </div>
    <div class="header-stats">
    <div class="stat-item">
        <span class="stat-label" data-i18n="header.balance">Balance</span>
        <span class="stat-value" id="balance">$10,000.00</span>
    </div>
    <div class="stat-item">
        <span class="stat-label" data-i18n="header.equity">Equity</span>
        <span class="stat-value" id="equity">$10,000.00</span>
    </div>
    <div class="stat-item">
        <span class="stat-label" data-i18n="header.margin">Margin</span>
        <span class="stat-value" id="margin">$0.00</span>
    </div>
    <div class="stat-item">
        <span class="stat-label" data-i18n="header.freeMargin">Free Margin</span>
        <span class="stat-value" id="freeMargin">$10,000.00</span>
    </div>
    <div class="stat-item">
        <span class="stat-label" data-i18n="header.marginLevel">Margin Level</span>
        <span class="stat-value" id="marginLevel">0.00%</span>
    </div>
</div>

<!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ -->
<div class="language-switcher" style="display: flex; gap: 10px; align-items: center; margin-right: 15px;">
    <button onclick="setLanguage('en')" class="lang-btn" id="lang-en" style="padding: 5px 10px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--border); color: var(--text-primary); border-radius: 5px; cursor: pointer; font-size: 12px; transition: all 0.3s;">EN</button>
    <button onclick="setLanguage('ru')" class="lang-btn" id="lang-ru" style="padding: 5px 10px; background: transparent; border: 1px solid var(--border); color: var(--text-secondary); border-radius: 5px; cursor: pointer; font-size: 12px; transition: all 0.3s;">RU</button>
</div>


</div>

   <!-- Main Container -->
<div class="main-container">
    <!-- Left Sidebar -->
    <div class="sidebar-left">
        <button class="tool-btn active" title="Cursor" onclick="selectTool('cursor')">‚Üñ</button>
        <button class="tool-btn" title="Crosshair" onclick="selectTool('crosshair')">‚úö</button>
        <div class="tool-separator"></div>
        <button class="tool-btn" title="Line" onclick="selectDrawingTool('line')">‚ï±</button>
        <button class="tool-btn" title="Horizontal Line" onclick="selectDrawingTool('horizontal')">‚îÄ</button>
        <button class="tool-btn" title="Rectangle" onclick="selectDrawingTool('rectangle')">‚ñ≠</button>
        <button class="tool-btn" title="Text" onclick="selectDrawingTool('text')">T</button>
        <button class="tool-btn" title="Clear All" onclick="clearAllDrawings()">üóë</button>
        <div class="tool-separator"></div>
        <button class="tool-btn" title="Indicators" onclick="toggleIndicators()" style="font-size: 12px; font-weight: bold;">üî•</button>
        <div class="tool-separator"></div>
<button class="tool-btn" title="Quick Trade" onclick="showQuickTrade()" style="font-size: 12px; font-weight: bold; color: var(--accent-primary);">‚ö°</button>
        <button class="tool-btn" title="Buy Limit" onclick="startPendingOrder('buy_limit')" style="color: var(--success); font-size: 11px; font-weight: bold;">BL</button>
        <button class="tool-btn" title="Sell Limit" onclick="startPendingOrder('sell_limit')" style="color: var(--danger); font-size: 11px; font-weight: bold;">SL</button>
    </div>

        <!-- Central Trading Area -->
        <div class="trading-area">
            <!-- Chart Container -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="symbol-selector">
                        <select class="symbol-select" id="symbolSelect" onchange="changeSymbol()">
    <option value="EURUSD">EUR/USD</option>
    <option value="GBPUSD">GBP/USD</option>
    <option value="XAUUSD">XAU/USD (Gold)</option>
    <option value="BTCUSD">BTC/USD</option>
</select>
                        <div class="price-display">
                            <span class="current-price price-up" id="currentPrice">-</span>
                            <span class="price-change price-up" id="priceChange">-</span>
                        </div>
                    </div>
                    <div class="timeframe-selector">
                        <button class="tf-btn" onclick="changeTimeframe('M1')">M1</button>
                        <button class="tf-btn" onclick="changeTimeframe('M5')">M5</button>
                        <button class="tf-btn" onclick="changeTimeframe('M15')">M15</button>
                        <button class="tf-btn" onclick="changeTimeframe('M30')">M30</button>
                        <button class="tf-btn active" onclick="changeTimeframe('H1')">H1</button>
                        <button class="tf-btn" onclick="changeTimeframe('H4')">H4</button>
                        <button class="tf-btn" onclick="changeTimeframe('D1')">D1</button>
                        <button class="tf-btn" onclick="changeTimeframe('W1')">W1</button>
                        <button class="tf-btn" onclick="changeTimeframe('MN')">MN</button>
                    </div>
                </div>
                <div class="chart-main">
                    <canvas id="tradingChart"></canvas>
                    
                    <!-- Axis resize handles -->
                    <div class="axis-resize-handle y-axis" id="yAxisHandle"></div>
                    <div class="axis-resize-handle x-axis" id="xAxisHandle"></div>
                    
                    <!-- Chart Info Overlay -->
                    <div class="chart-info-overlay">
                        <div class="info-row">
                            <span class="info-label">Open:</span>
                            <span class="info-value" id="ohlcOpen">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">High:</span>
                            <span class="info-value" id="ohlcHigh">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Low:</span>
                            <span class="info-value" id="ohlcLow">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Close:</span>
                            <span class="info-value" id="ohlcClose">-</span>
                        </div>
                    </div>
                    
                    <!-- Drawing Tools Panel -->
                    <div class="drawing-tools-panel" id="drawingToolsPanel">
                        <div class="drawing-color-picker">
                            <div class="color-option selected" style="background: var(--accent-primary)" onclick="selectDrawingColor('var(--accent-primary)')"></div>
                            <div class="color-option" style="background: var(--success)" onclick="selectDrawingColor('var(--success)')"></div>
                            <div class="color-option" style="background: var(--danger)" onclick="selectDrawingColor('var(--danger)')"></div>
                            <div class="color-option" style="background: var(--warning)" onclick="selectDrawingColor('var(--warning)')"></div>
                            <div class="color-option" style="background: white" onclick="selectDrawingColor('white')"></div>
                        </div>
                    </div>
                    <!-- Indicators Panel -->
<div class="indicators-panel" id="indicatorsPanel" style="position: absolute; top: 60px; left: 60px; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; padding: 15px; display: none; z-index: 200; min-width: 250px;">
    <div style="font-size: 14px; font-weight: bold; color: var(--accent-primary); margin-bottom: 15px;">Indicators</div>
    
    <div class="indicator-item" style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;" onclick="addIndicator('bpfx')" 
         onmouseover="this.style.background='var(--accent-tertiary)'" 
         onmouseout="this.style.background='var(--bg-secondary)'">
        <div style="font-size: 13px; font-weight: bold;">BPFX Buy/Sell</div>
        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">Forex Traring BluePrint custom</div>
    </div>
    
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">Active Indicators:</div>
        <div id="activeIndicatorsList"></div>
    </div>
</div>
<!-- Indicator iframe container -->
<div id="indicatorContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;"></div>
                    <!-- Text Input Overlay -->
                    <div class="text-input-overlay" id="textInputOverlay">
                        <input type="text" class="text-input-field" id="textInputField" placeholder="Enter text..." />
                    </div>
                    
                    <div class="loader" id="chartLoader">
                        <div class="loader-ring"></div>
                    </div>
                </div>
            </div>
<!-- Panel Resizer -->
<div class="panel-resizer" id="panelResizer"></div>
<!-- Bottom Positions Panel -->
<div class="positions-panel">
    <div class="positions-panel-tabs">
    <button class="positions-panel-tab active" onclick="switchPositionsTab('positions')">
        Open Positions
        <span id="positionsCount" class="pending-orders-badge" style="display: none;">0</span>
    </button>
    <button class="positions-panel-tab" onclick="switchPositionsTab('pending')">
        Pending Orders
        <span id="pendingOrdersCount" class="pending-orders-badge" style="display: none;">0</span>
    </button>
    <button class="positions-panel-tab" onclick="openHistory()" 
    ">
         History
    </button>
</div>

    <!-- Open Positions Tab -->
    <div class="positions-panel-tab-content active" id="positions-tab">
        <div class="positions-header">
            <div class="positions-title">Open Positions</div>
            <div class="positions-controls">
                <button class="control-btn" onclick="closeAllPositions()">Close All</button>
                
                <button class="control-btn" onclick="closeAllProfitable()">Close Profitable</button>
                <button class="control-btn" onclick="closeAllLosing()">Close Losing</button>
            </div>
        </div>
        <div class="positions-table-container">
            <table class="positions-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Type</th>
                        <th>Volume</th>
                        <th>Open Price</th>
                        <th>Current Price</th>
                        <th>S/L ($)</th>
                        <th>T/P ($)</th>
                        <th>Profit ($)</th>
                        <th>Trailing</th>
                        <th>Breakeven</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tfoot id="positionsTableFooter">
                    <tr class="summary-row">
                        <td colspan="2">Total:</td>
                        <td id="totalVolume">0.00</td>
                        <td colspan="4"></td>
                        <td id="totalProfit">$0.00</td>
                        <td colspan="3"></td>
                    </tr>
                </tfoot>
                <tbody id="positionsTableBody">
                    <tr>
                        <td colspan="11" style="text-align: center; color: var(--text-secondary); padding: 40px;">
                            No open positions
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pending Orders Tab -->
    <div class="positions-panel-tab-content" id="pending-tab">
        <div class="positions-header">
            <div class="positions-title">Limit Orders</div>
            <div class="positions-controls">
                <button class="control-btn" onclick="cancelAllPendingOrders()">Cancel All</button>
            </div>
        </div>
        <div class="positions-table-container">
            <table class="positions-table">
                <thead>
                    <tr>
                        <th>Ticket</th>
                        <th>Symbol</th>
                        <th>Type</th>
                        <th>Volume</th>
                        <th>Price</th>
                        <th>Distance</th>
                        <th>S/L</th>
                        <th>T/P</th>
                        <th>Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="pendingOrdersTableBody">
                    <tr>
                        <td colspan="10" style="text-align: center; color: var(--text-secondary); padding: 40px;">
                            No pending orders
                        </td>
                    </tr>
                </tbody>
                <tfoot id="pendingOrdersTableFooter" style="display: none;">
                    <tr class="summary-row">
                        <td colspan="3" id="totalPendingOrders">Total: 0 Orders</td>
                        <td id="totalPendingVolume">0.00</td>
                        <td colspan="6"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
</div>

<!-- Right Panel -->
        <div class="panel-right">
            <div class="panel-tabs">
                <button class="panel-tab active" onclick="switchTab('trading')">Trading</button>
                <button class="panel-tab" onclick="switchTab('settings')">Settings</button>
            </div>

            <div class="panel-content">
                <!-- Trading Tab -->
                <div class="tab-section active" id="trading-tab">
                    <!-- Risk Management Toggle -->
                    <div class="risk-management">
                        <div class="risk-toggle">
                            <label class="toggle-switch">
                                <input type="checkbox" id="riskModeToggle" onchange="toggleRiskMode()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Risk Management Mode</span>
                        </div>
                        <div class="risk-inputs" id="riskInputs">
                            <div class="risk-field">
                                <div class="risk-label">Risk %</div>
                                <input type="number" class="risk-input" id="riskPercent" value="1" min="0.1" max="100" step="0.1">
                            </div>
                            <div class="risk-field">
                                <div class="risk-label">Reward Ratio</div>
                                <input type="number" class="risk-input" id="rewardRatio" value="3" min="0.1" max="10" step="0.1">
                            </div>
                        </div>
                        <div class="calculated-values" id="calculatedValues" style="display: none;">
                            <div class="calc-row">
                                <span>Risk Amount:</span>
                                <span class="calc-value" id="calcRiskAmount">$0.00</span>
                            </div>
                            <div class="calc-row">
                                <span>Potential Profit:</span>
                                <span class="calc-value" id="calcProfit">$0.00</span>
                            </div>
                            <div class="calc-row">
                                <span>Calculated Volume:</span>
                                <span class="calc-value" id="calcVolume">0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Volume Input -->
                    <div class="input-group" id="volumeGroup">
                        <div class="input-label">Volume (Lots)</div>
                        <div class="input-row">
                            <input type="number" class="input-field" value="0.01" step="0.01" min="0.01" max="100" id="lotSize">
                        </div>
                        <div class="quick-amounts">
                            <button class="quick-btn" onclick="setLot(0.01)">0.01</button>
                            <button class="quick-btn" onclick="setLot(0.05)">0.05</button>
                            <button class="quick-btn" onclick="setLot(0.10)">0.10</button>
                            <button class="quick-btn" onclick="setLot(0.50)">0.50</button>
                            <button class="quick-btn" onclick="setLot(1.00)">1.00</button>
                        </div>
                    </div>

                    <!-- Stop Loss Input -->
                    <div class="input-group">
                        <div class="input-label">Stop Loss</div>
                        <div class="input-row">
                            <input type="number" class="input-field" placeholder="Optional" id="stopLoss">
                            <div class="input-unit-toggle">
                                <button class="unit-btn active" id="slUnitPips" onclick="toggleSLUnit('pips')">Pips</button>
                                <button class="unit-btn" id="slUnitDollar" onclick="toggleSLUnit('dollar')">$</button>
                            </div>
                        </div>
                    </div>

                    <!-- Take Profit Input -->
                    <div class="input-group">
                        <div class="input-label">Take Profit</div>
                        <div class="input-row">
                            <input type="number" class="input-field" placeholder="Optional" id="takeProfit">
                            <div class="input-unit-toggle">
                                <button class="unit-btn active" id="tpUnitPips" onclick="toggleTPUnit('pips')">Pips</button>
                                <button class="unit-btn" id="tpUnitDollar" onclick="toggleTPUnit('dollar')">$</button>
                            </div>
                        </div>
                    </div>

                    <!-- Order Type Selection -->
<div class="input-group">
    <div class="input-label">Order Type</div>
    <div class="order-type-selector">
        <button class="order-type-btn active" id="marketOrderBtn" onclick="selectOrderType('market')">
            Market Order
        </button>
        <button class="order-type-btn" id="limitOrderBtn" onclick="selectOrderType('limit')">
            Limit Order
        </button>
    </div>
</div>

<!-- Limit Price Input (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤) -->
<div class="input-group" id="limitPriceGroup" style="display: none;">
    <div class="input-label">Limit Price</div>
    <div class="input-row">
        <input type="number" class="input-field" id="limitPrice" step="0.00001">
        <button class="quick-btn" onclick="setLimitPriceFromCurrent('bid')">Bid</button>
        <button class="quick-btn" onclick="setLimitPriceFromCurrent('ask')">Ask</button>
    </div>
    <div class="limit-price-info">
        <span id="limitPriceDistance">-</span> pips from current price
    </div>
</div>

<!-- Automation Settings -->
<div class="risk-management" style="margin-top: 15px;">
    <div class="setting-title" style="color: var(--accent-primary); margin-bottom: 10px;">Automation Settings</div>
    
    <!-- Trailing Stop -->
    <div class="risk-toggle">
        <label class="toggle-switch">
            <input type="checkbox" id="presetTrailing" onchange="togglePresetTrailing()">
            <span class="toggle-slider"></span>
        </label>
        <span>Trailing Stop</span>
    </div>
    <div class="risk-inputs" id="trailingInputs" style="display: none; margin-bottom: 10px;">
        <div class="risk-field">
            <div class="risk-label">Activation ($)</div>
            <input type="number" class="risk-input" id="presetTrailingProfit" value="10" min="1">
        </div>
        <div class="risk-field">
            <div class="risk-label">Distance ($)</div>
            <input type="number" class="risk-input" id="presetTrailingDistance" value="5" min="1">
        </div>
    </div>
    
    <!-- Breakeven -->
    <div class="risk-toggle">
        <label class="toggle-switch">
            <input type="checkbox" id="presetBreakeven" onchange="togglePresetBreakeven()">
            <span class="toggle-slider"></span>
        </label>
        <span>Auto Breakeven</span>
    </div>
    <div class="risk-inputs" id="breakevenInputs" style="display: none;">
        <div class="risk-field">
            <div class="risk-label">Activation ($)</div>
            <input type="number" class="risk-input" id="presetBreakevenProfit" value="5" min="1">
        </div>
    </div>
</div>

<!-- –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ Buy/Sell -->
<div class="trade-buttons">
    <button class="btn-buy" id="buyButton" onclick="executeTrade('buy')">
        <span id="buyButtonText">BUY</span><br>
        <span style="font-size: 12px; font-weight: normal;" id="buyPrice">-</span>
    </button>
    <button class="btn-sell" id="sellButton" onclick="executeTrade('sell')">
        <span id="sellButtonText">SELL</span><br>
        <span style="font-size: 12px; font-weight: normal;" id="sellPrice">-</span>
    </button>
</div>
</div>
                <!-- Settings Tab -->
                <div class="tab-section" id="settings-tab">
                    <div class="setting-group">
                        <div class="setting-title">Theme</div>
                        <div class="theme-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <div class="theme-option active" onclick="changeTheme('cyberpunk')" style="padding: 15px; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center;">Cyberpunk</div>
                            <div class="theme-option" onclick="changeTheme('matrix')" style="padding: 15px; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center;">Matrix</div>
                            <div class="theme-option" onclick="changeTheme('dark')" style="padding: 15px; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center;">Dark</div>
                            <div class="theme-option" onclick="changeTheme('light')" style="padding: 15px; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center;">Light</div>
                            <div class="theme-option" onclick="changeTheme('ocean')" style="padding: 15px; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center;">Ocean</div>
                            <div class="theme-option" onclick="changeTheme('sunset')" style="padding: 15px; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center;">Sunset</div>
                            <div class="theme-option" onclick="changeTheme('neon')" style="padding: 15px; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center;">Neon</div>
                            <div class="theme-option" onclick="changeTheme('royal')" style="padding: 15px; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center;">Royal</div>
                        </div>
                    </div>
<div class="setting-group" style="margin-top: 20px;">
    <button onclick="openThemeCustomizer()" style="
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(0, 255, 255, 0.2));
        border: 2px solid var(--accent-primary);
        border-radius: 12px;
        color: var(--accent-primary);
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 2px;
        transition: all 0.3s;
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px rgba(139, 92, 246, 0.5)'" 
       onmouseout="this.style.transform=''; this.style.boxShadow=''">
        üé® CUSTOM THEME STUDIO
    </button>
</div>
                    <div class="setting-group">
                        <div class="setting-title">Chart Settings</div>
                        <div class="setting-row">
                            <span>Grid Lines</span>
                            <label class="toggle-switch">
                                <input type="checkbox" checked id="showGrid" onchange="updateChartSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-row">
                            <span>Price Line</span>
                            <label class="toggle-switch">
                                <input type="checkbox" checked id="showPriceLine" onchange="updateChartSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Position Settings Dialog -->
    <div class="position-settings-dialog" id="positionSettingsDialog">
        <div class="dialog-header">
            <div class="dialog-title" data-i18n="dialog.positionSettings">Position Settings</div>
            <button class="dialog-close" onclick="closePositionSettings()">‚úï</button>
        </div>
        <div class="dialog-content">
            <div class="setting-section">
                <div class="setting-title" data-i18n="dialog.stopLossTakeProfit">Stop Loss / Take Profit</div>
                <div class="setting-row">
                    <span data-i18n="dialog.stopLossDollar">Stop Loss ($)</span>
                    <input type="number" class="setting-value-input" id="dialogSL" data-i18n-placeholder="dialog.enterAmount" placeholder="Enter amount">
                </div>
                <div class="setting-row">
                    <span data-i18n="dialog.takeProfitDollar">Take Profit ($)</span>
                    <input type="number" class="setting-value-input" id="dialogTP" data-i18n-placeholder="dialog.enterAmount" placeholder="Enter amount">
                </div>
            </div>
            
            <div class="setting-section">
                <div class="setting-title" data-i18n="dialog.autoTrailing">Auto Trailing</div>
                <div class="setting-row">
                    <span data-i18n="dialog.enableTrailing">Enable Trailing</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dialogTrailing">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-row">
                    <span data-i18n="dialog.activationProfit">Activation Profit ($)</span>
                    <input type="number" class="setting-value-input" id="dialogTrailingProfit" value="10">
                </div>
                <div class="setting-row">
                    <span data-i18n="dialog.trailingDistance">Trailing Distance ($)</span>
                    <input type="number" class="setting-value-input" id="dialogTrailingDistance" value="5">
                </div>
            </div>
            
            <div class="setting-section">
                <div class="setting-title" data-i18n="dialog.autoBreakeven">Auto Breakeven</div>
                <div class="setting-row">
                    <span data-i18n="dialog.enableBreakeven">Enable Breakeven</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dialogBreakeven">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-row">
                    <span data-i18n="dialog.activationProfit">Activation Profit ($)</span>
                    <input type="number" class="setting-value-input" id="dialogBreakevenProfit" value="5">
                </div>
            </div>
            
            <div class="setting-section">
                <div class="setting-title" data-i18n="dialog.partialClose">Partial Close</div>
                <div class="setting-row">
                    <span data-i18n="dialog.close50AtProfit">Close 50% at profit ($)</span>
                    <input type="number" class="setting-value-input" id="dialogPartialClose" data-i18n-placeholder="dialog.disabled" placeholder="Disabled">
                </div>
            </div>
            
            <button class="apply-btn" onclick="applyPositionSettings()" data-i18n="dialog.apply">Apply Settings</button>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="connection-status">
            <div class="status-dot disconnected" id="connectionDot"></div>
            <span id="connectionText" data-i18n="status.disconnected">Disconnected</span>
        </div>
        <div class="status-info">
            <span><span data-i18n="status.spread">Spread</span>: <span id="currentSpread">-</span></span>
            <span><span data-i18n="status.serverTime">Server Time</span>: <span id="serverTime">00:00:00</span></span>
        </div>
    </div>

   <script>
    // Global Variables
    let hoveredDrawing = null;
    let ws = null;
    let positions = {};
    let dragStartPriceCenter = 0;
    let positionsData = [];
    let currentSymbol = 'EURUSD';
    let orderType = 'market'; // 'market' –∏–ª–∏ 'limit'
    let currentTimeframe = 'H1';
    let chartData = [];
    let selectedTool = 'cursor';
    let drawingTool = null;
    let drawingColor = 'var(--accent-primary)';
    let selectedPendingOrderTicket = null;
    let drawings = [];
    let currentDrawing = null;
    let isDrawing = false;
    let isConnected = false;
    let currentBid = 0;
    let currentAsk = 0;
    let currentSpread = 0;
    let balance = 10000;
    let slUnit = 'pips';
    let tpUnit = 'pips';
    let riskMode = false;
    let selectedPositionId = null;
    let lastUpdateTime = 0;
    let updateThrottle = 100;
    let positionsUpdateQueue = [];
    let isUpdatingPositions = false;
    // Broker settings
    const BROKER_SUFFIX = '+';  // –°—É—Ñ—Ñ–∏–∫—Å –±—Ä–æ–∫–µ—Ä–∞ –¥–ª—è —Å–∏–º–≤–æ–ª–æ–≤
    
    // Chart variables
let canvas, ctx;
let chartWidth, chartHeight;
let candleWidth = 10;
let candleSpacing = 2;
let visibleCandles = 100;
let scrollOffset = 0;
let maxScroll = 0;
let priceMin = 1.0;
let priceMax = 1.1;
let priceRange = 0.1;
let mouseX = 0, mouseY = 0;
let isDragging = false;
let dragStartX = 0;
let dragStartY = 0;
let dragStartOffset = 0;
let hoveredPosition = null;
let draggingLine = null;
let draggedPosition = null;
let dragOriginalValue = 0;
let chartPadding = 80;
let isResizingYAxis = false;
let isResizingXAxis = false;
let yAxisStartY = 0;
let xAxisStartX = 0;
let priceRangeStart = 0;
let candleWidthStart = 0;

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
let pendingOrderMode = false;
let pendingOrderType = null;
let pendingOrderPreview = null;
let pendingOrders = [];  
let pendingOrdersData = [];
let pendingOrderStep = 'price';
// Indicator Management System
let activeIndicators = {};
let indicatorsPanel = false;

function toggleIndicators() {
    indicatorsPanel = !indicatorsPanel;
    const panel = document.getElementById('indicatorsPanel');
    if (panel) {
        panel.style.display = indicatorsPanel ? 'block' : 'none';
    }
}

function addIndicator(type) {
    if (activeIndicators[type]) {
        showNotification('Indicator already active', 'warning');
        return;
    }
    
    // Create iframe for indicator
    const iframe = document.createElement('iframe');
    iframe.id = `indicator-${type}`;
    iframe.src = 'bpfx-indicator.html';
    iframe.style.position = 'absolute';
    iframe.style.top = '0';
    iframe.style.left = '0';
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';
    iframe.style.pointerEvents = 'none';
    iframe.style.background = 'transparent';
    
    // Add to container
    const container = document.getElementById('indicatorContainer');
    container.appendChild(iframe);
    
    // Wait for iframe to load
    iframe.onload = function() {
        // Send initial data to indicator
        updateIndicatorData(type);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—É
        iframe.contentWindow.postMessage({
            type: 'themeChange',
            theme: currentTheme
        }, '*');
    };
    
    activeIndicators[type] = {
        iframe: iframe,
        enabled: true
    };
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
    if (!document.getElementById(`bpfx-settings-btn-${type}`)) {
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        const settingsBtn = document.createElement('button');
        settingsBtn.id = `bpfx-settings-btn-${type}`; // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
        settingsBtn.className = 'indicator-settings-btn';
        settingsBtn.innerHTML = '‚öô BPFX Settings';
        settingsBtn.style.cssText = `
            margin-left: 10px;
            padding: 8px 15px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(0, 255, 255, 0.1));
            border: 1px solid rgba(0, 255, 255, 0.5);
            border-radius: 8px;
            color: #00ffff;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        `;

        settingsBtn.onclick = function() {
            document.getElementById('bpfxSettingsModal').style.display = 'block';
        };

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Ä—è–¥–æ–º —Å —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞–º–∏
        const timeframeContainer = document.querySelector('.timeframe-selector').parentElement;
        timeframeContainer.appendChild(settingsBtn);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–Ω–æ–ø–∫—É –≤ –æ–±—ä–µ–∫—Ç–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
        activeIndicators[type].settingsButton = settingsBtn;
    }
    
    updateActiveIndicatorsList();
    showNotification('BPFX indicator added', 'success');
    
    // Close panel
    toggleIndicators();
}

function removeIndicator(type) {
    if (!activeIndicators[type]) return;
    
    const indicator = activeIndicators[type];
    
    // –£–¥–∞–ª—è–µ–º iframe
    indicator.iframe.remove();
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
    if (indicator.settingsButton) {
        indicator.settingsButton.remove();
    }
    // –¢–∞–∫–∂–µ –ø—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å –ø–æ ID –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –ø–æ—Ç–µ—Ä—è–ª–∞—Å—å
    const settingsBtn = document.getElementById(`bpfx-settings-btn-${type}`);
    if (settingsBtn) {
        settingsBtn.remove();
    }
    
    delete activeIndicators[type];
    
    updateActiveIndicatorsList();
    showNotification('Indicator removed', 'info');
}
function updateActiveIndicatorsList() {
    const list = document.getElementById('activeIndicatorsList');
    if (!list) return;
    
    list.innerHTML = '';
    
    for (const [type, indicator] of Object.entries(activeIndicators)) {
        const item = document.createElement('div');
        item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 5px;';
        
        item.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <label class="toggle-switch" style="transform: scale(0.8);">
                    <input type="checkbox" ${indicator.enabled ? 'checked' : ''} onchange="toggleIndicatorVisibility('${type}', this.checked)">
                    <span class="toggle-slider"></span>
                </label>
                <span style="font-size: 12px;">BPFX</span>
            </div>
            <button onclick="window.removeIndicator('${type}')" style="background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Remove</button>
        `;
        
        list.appendChild(item);
    }
}

function toggleIndicatorVisibility(type, enabled) {
    if (!activeIndicators[type]) return;
    
    activeIndicators[type].enabled = enabled;
    activeIndicators[type].iframe.style.display = enabled ? 'block' : 'none';
}

function updateIndicatorData(type) {
    if (!activeIndicators[type] || !chartData || chartData.length === 0) return;
    
    const indicator = activeIndicators[type];
    
    // Send chart data to indicator
    indicator.iframe.contentWindow.postMessage({
        type: 'updateData',
        candles: chartData
    }, '*');
}

function updateAllIndicators() {
    for (const type of Object.keys(activeIndicators)) {
        updateIndicatorData(type);
    }
}

// Theme Definitions
const themes = {
    cyberpunk: {
        '--bg-primary': '#0a0e1a',
        '--bg-secondary': '#141824',
        '--bg-panel': 'rgba(20, 24, 36, 0.95)',
        '--accent-primary': '#00ffff',
        '--accent-secondary': '#ff00ff',
        '--accent-tertiary': '#8b5cf6',
        '--text-primary': '#ffffff',
        '--text-secondary': '#94a3b8',
        '--success': '#22c55e',
        '--danger': '#ef4444',
        '--warning': '#f59e0b',
        '--border': 'rgba(139, 92, 246, 0.3)',
        '--candle-bull': '#00ffff',
        '--candle-bear': '#ff00ff',
        '--candle-wick': '#ffffff'
    },
    matrix: {
        '--bg-primary': '#000000',
        '--bg-secondary': '#0a0a0a',
        '--bg-panel': 'rgba(0, 20, 0, 0.95)',
        '--accent-primary': '#00ff00',
        '--accent-secondary': '#00cc00',
        '--accent-tertiary': '#006600',
        '--text-primary': '#00ff00',
        '--text-secondary': '#008800',
        '--success': '#00ff00',
        '--danger': '#ff0000',
        '--warning': '#ffff00',
        '--border': 'rgba(0, 255, 0, 0.3)',
        '--candle-bull': '#00ff00',
        '--candle-bear': '#ff0000',
        '--candle-wick': '#00ff00'
    },
    dark: {
        '--bg-primary': '#1a1a1a',
        '--bg-secondary': '#2a2a2a',
        '--bg-panel': 'rgba(30, 30, 30, 0.95)',
        '--accent-primary': '#4a9eff',
        '--accent-secondary': '#ff6b6b',
        '--accent-tertiary': '#666666',
        '--text-primary': '#ffffff',
        '--text-secondary': '#bbbbbb',
        '--success': '#4caf50',
        '--danger': '#f44336',
        '--warning': '#ff9800',
        '--border': 'rgba(255, 255, 255, 0.1)',
        '--candle-bull': '#4caf50',
        '--candle-bear': '#f44336',
        '--candle-wick': '#888888'
    },
    light: {
        '--bg-primary': '#ffffff',
        '--bg-secondary': '#f5f5f5',
        '--bg-panel': 'rgba(255, 255, 255, 0.95)',
        '--accent-primary': '#2196f3',
        '--accent-secondary': '#ff4081',
        '--accent-tertiary': '#9c27b0',
        '--text-primary': '#333333',
        '--text-secondary': '#666666',
        '--success': '#4caf50',
        '--danger': '#f44336',
        '--warning': '#ff9800',
        '--border': 'rgba(0, 0, 0, 0.1)',
        '--candle-bull': '#4caf50',
        '--candle-bear': '#f44336',
        '--candle-wick': '#666666'
    },
    ocean: {
        '--bg-primary': '#001f3f',
        '--bg-secondary': '#003366',
        '--bg-panel': 'rgba(0, 51, 102, 0.95)',
        '--accent-primary': '#00bcd4',
        '--accent-secondary': '#00acc1',
        '--accent-tertiary': '#0097a7',
        '--text-primary': '#ffffff',
        '--text-secondary': '#b3e5fc',
        '--success': '#00e676',
        '--danger': '#ff5252',
        '--warning': '#ffc107',
        '--border': 'rgba(0, 188, 212, 0.3)',
        '--candle-bull': '#00e5ff',
        '--candle-bear': '#ff1744',
        '--candle-wick': '#80deea'
    },
    sunset: {
        '--bg-primary': '#1a0033',
        '--bg-secondary': '#330066',
        '--bg-panel': 'rgba(51, 0, 102, 0.95)',
        '--accent-primary': '#ff6b6b',
        '--accent-secondary': '#ffa500',
        '--accent-tertiary': '#ff1744',
        '--text-primary': '#ffffff',
        '--text-secondary': '#ffccbc',
        '--success': '#76ff03',
        '--danger': '#ff1744',
        '--warning': '#ffab00',
        '--border': 'rgba(255, 107, 107, 0.3)',
        '--candle-bull': '#ffeb3b',
        '--candle-bear': '#ff5722',
        '--candle-wick': '#ffa726'
    },
    neon: {
        '--bg-primary': '#0a0a0a',
        '--bg-secondary': '#1a1a1a',
        '--bg-panel': 'rgba(26, 26, 26, 0.95)',
        '--accent-primary': '#ff00ff',
        '--accent-secondary': '#00ffff',
        '--accent-tertiary': '#9900ff',
        '--text-primary': '#ffffff',
        '--text-secondary': '#cccccc',
        '--success': '#00ff00',
        '--danger': '#ff0066',
        '--warning': '#ff9900',
        '--border': 'rgba(255, 0, 255, 0.3)',
        '--candle-bull': '#00ff00',
        '--candle-bear': '#ff0080',
        '--candle-wick': '#ff00ff'
    },
    royal: {
        '--bg-primary': '#1a0033',
        '--bg-secondary': '#2d004d',
        '--bg-panel': 'rgba(45, 0, 77, 0.95)',
        '--accent-primary': '#ffd700',
        '--accent-secondary': '#ff69b4',
        '--accent-tertiary': '#9370db',
        '--text-primary': '#ffffff',
        '--text-secondary': '#dda0dd',
        '--success': '#32cd32',
        '--danger': '#dc143c',
        '--warning': '#ffa500',
        '--border': 'rgba(255, 215, 0, 0.3)',
        '--candle-bull': '#ffd700',
        '--candle-bear': '#dc143c',
        '--candle-wick': '#daa520'
    }
};

let currentTheme = localStorage.getItem('currentTheme') || 'cyberpunk';

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è preset –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
function togglePresetTrailing() {
    const isChecked = document.getElementById('presetTrailing').checked;
    const trailingInputs = document.getElementById('trailingInputs');
    
    if (isChecked) {
        trailingInputs.style.display = 'flex';
    } else {
        trailingInputs.style.display = 'none';
    }
}

function togglePresetBreakeven() {
    const isChecked = document.getElementById('presetBreakeven').checked;
    const breakevenInputs = document.getElementById('breakevenInputs');
    
    if (isChecked) {
        breakevenInputs.style.display = 'flex';
    } else {
        breakevenInputs.style.display = 'none';
    }
}
        // Initialize WebSocket
        function initWebSocket() {
            try {
                ws = new WebSocket('ws://127.0.0.1:8080');
                
                ws.onopen = () => {
                    isConnected = true;
                    updateConnectionStatus(true);
                    showNotification('Connected to server', 'success');
                    
                    // Request initial data
                    ws.send(JSON.stringify({
                        type: 'request',
                        data: 'initial'
                    }));
                    
                    // Subscribe to current symbol
                    ws.send(JSON.stringify({
                        type: 'subscribe',
                        symbol: getBrokerSymbol(currentSymbol)
                    }));
                    
                    // Request chart data
                    requestChartData();
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    showNotification('Connection error', 'error');
                };
                
                ws.onclose = () => {
                    isConnected = false;
                    updateConnectionStatus(false);
                    showNotification('Disconnected from server', 'error');
                    setTimeout(initWebSocket, 5000); // Auto-reconnect
                };
            } catch (error) {
                console.error('Failed to connect:', error);
                updateConnectionStatus(false);
                setTimeout(initWebSocket, 5000);
            }
        }
function updateAllIndicators() {
    for (const type of Object.keys(activeIndicators)) {
        updateIndicatorData(type);
    }
}

       function handleServerMessage(data) {
    switch(data.type) {
        case 'tick':
            updatePrice(data);
            updateLastCandle(data);
            break;
        case 'account':
            updateAccount(data);
            break;
        case 'positions':
            queuePositionsUpdate(data.positions);
            break;
        case 'pending_orders':  // –î–û–ë–ê–í–ò–¢–¨ –≠–¢–û–¢ CASE
            updatePendingOrders(data.orders);
            break;
        case 'execution':
            handleExecution(data);
            break;
        case 'chart':
            updateChart(data.candles);
            break;
        case 'notification':
            showNotification(data.message, data.level || 'info');
            break;
        case 'error':
            showNotification(data.message, 'error');
            break;
    }
}

        // Queue positions update to avoid flickering
        function queuePositionsUpdate(newPositions) {
            positionsUpdateQueue.push(newPositions);
            if (!isUpdatingPositions) {
                processPositionsQueue();
            }
        }

        // Process positions queue with batching
        async function processPositionsQueue() {
            if (positionsUpdateQueue.length === 0) {
                isUpdatingPositions = false;
                return;
            }
            
            isUpdatingPositions = true;
            const positions = positionsUpdateQueue.shift();
            
            // Clear remaining queue and use only latest data
            if (positionsUpdateQueue.length > 0) {
                positionsUpdateQueue = [positionsUpdateQueue[positionsUpdateQueue.length - 1]];
            }
            
            updatePositions(positions);
            
            // Throttle updates
            setTimeout(() => {
                processPositionsQueue();
            }, updateThrottle);
        }

        // Update prices
        function updatePrice(data) {
            if (data.symbol === currentSymbol) {
                currentBid = data.bid;
                currentAsk = data.ask;
                currentSpread = data.spread;
                
                const price = document.getElementById('currentPrice');
                const change = document.getElementById('priceChange');
                const buyPrice = document.getElementById('buyPrice');
                const sellPrice = document.getElementById('sellPrice');
                const spread = document.getElementById('currentSpread');
                
                price.textContent = formatPrice(data.bid);
                buyPrice.textContent = formatPrice(data.ask);
                sellPrice.textContent = formatPrice(data.bid);
                spread.textContent = data.spread.toFixed(1);
                
                // Calculate change
                if (data.open) {
                    const changePercent = ((data.bid - data.open) / data.open * 100).toFixed(2);
                    change.textContent = (changePercent >= 0 ? '+' : '') + changePercent + '%';
                    
                    price.className = changePercent >= 0 ? 'current-price price-up' : 'current-price price-down';
                    change.className = changePercent >= 0 ? 'price-change price-up' : 'price-change price-down';
                }
                
                // Update risk calculations if in risk mode
                if (riskMode) {
                    calculateRiskValues();
                }
                
                // Redraw chart
                drawChart();
            }
        }

        // Format price based on symbol
        function formatPrice(price) {
            if (!price && price !== 0) return '-';
            
            if (currentSymbol.includes('JPY')) {
                return price.toFixed(3);
            } else if (currentSymbol.includes('BTC')) {
                return price.toFixed(2);
            } else if (currentSymbol.includes('XAU')) {
                return price.toFixed(2);
            } else {
                return price.toFixed(5);
            }
        }

        // Update account info
        function updateAccount(data) {
    balance = data.balance;
    document.getElementById('balance').textContent = '$' + data.balance.toFixed(2);
    document.getElementById('equity').textContent = '$' + data.equity.toFixed(2);
    document.getElementById('margin').textContent = '$' + data.margin.toFixed(2);
    document.getElementById('freeMargin').textContent = '$' + data.freeMargin.toFixed(2);
    document.getElementById('marginLevel').textContent = data.marginLevel.toFixed(2) + '%';

    // --- –î–û–ë–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
    const accountModeEl = document.getElementById('accountMode');
    if (data.server && data.server.toLowerCase().includes('demo')) {
        // –ï—Å–ª–∏ –≤ –∏–º–µ–Ω–∏ —Å–µ—Ä–≤–µ—Ä–∞ –µ—Å—Ç—å —Å–ª–æ–≤–æ "demo", –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–Ω–∞—á–æ–∫
        accountModeEl.innerHTML = '<span class="demo-badge">DEMO</span>';
    } else {
        // –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ, –æ—Å—Ç–∞–≤–ª—è–µ–º —ç—Ç–æ –º–µ—Å—Ç–æ –ø—É—Å—Ç—ã–º
        accountModeEl.innerHTML = '';
    }
    // --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ù–û–ô –õ–û–ì–ò–ö–ò ---
}

        // Update positions with smooth rendering
// Update positions with smooth rendering
function updatePositions(positionsArray) {
    positionsData = positionsArray || [];
    const posCountBadge = document.getElementById('positionsCount');
if (posCountBadge) {
    if (positionsData.length > 0) {
        posCountBadge.textContent = positionsData.length;
        posCountBadge.style.display = 'inline-block';
    } else {
        posCountBadge.style.display = 'none';
    }
}
    const tbody = document.getElementById('positionsTableBody');
    const tfoot = document.getElementById('positionsTableFooter'); 

    if (positionsData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" style="text-align: center; color: var(--text-secondary); padding: 40px;">
                    No open positions
                </td>
            </tr>
        `;
        tfoot.style.display = 'none'; 
        return;
    }
    
    tfoot.style.display = 'table-footer-group'; 

    let totalPositions = positionsData.length;
    let totalVolume = 0;
    let totalProfit = 0;

    positionsData.forEach(pos => {
        totalVolume += pos.volume;
        // –ü–ï–†–ï–°–ß–ò–¢–´–í–ê–ï–ú PROFIT –ü–†–ê–í–ò–õ–¨–ù–û
        const realProfit = calculateDollarValueFromPriceDiff(
            pos.openPrice,
            pos.currentPrice || pos.openPrice,
            pos.volume,
            pos.symbol
        ) * (pos.type === 'buy' ? 
            (pos.currentPrice - pos.openPrice > 0 ? 1 : -1) : 
            (pos.openPrice - pos.currentPrice > 0 ? 1 : -1));
        
        pos.profit = realProfit; // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π profit
        totalProfit += realProfit;
    });

    const newHTML = positionsData.map(pos => {
        const profitClass = pos.profit >= 0 ? 'positive' : 'negative';
        const typeClass = pos.type === 'buy' ? 'buy' : 'sell';
        
        let slDisplay = '-';
        let tpDisplay = '-';
        
        if (pos.sl) {
            const slDollar = calculateDollarValueFromPriceDiff(pos.openPrice, pos.sl, pos.volume, pos.symbol);
            slDisplay = `$${slDollar.toFixed(2)}`;
        }
        
        if (pos.tp) {
            const tpDollar = calculateDollarValueFromPriceDiff(pos.openPrice, pos.tp, pos.volume, pos.symbol);
            tpDisplay = `$${tpDollar.toFixed(2)}`;
        }
        
        return `
            <tr data-position-id="${pos.id}" onclick="selectPosition(${pos.id})" 
                onmouseenter="highlightPosition(${pos.id})" 
                onmouseleave="unhighlightPosition()">
                <td class="position-symbol">${pos.symbol}</td>
                <td><span class="position-type-badge ${typeClass}">${pos.type.toUpperCase()}</span></td>
                <td>${pos.volume.toFixed(2)}</td>
                <td>${formatPrice(pos.openPrice)}</td>
                <td>${formatPrice(pos.currentPrice || pos.openPrice)}</td>
                <td>${slDisplay}</td>
                <td>${tpDisplay}</td>
                <td class="profit-value ${profitClass}">
                    ${pos.profit >= 0 ? '+' : ''}$${Math.abs(pos.profit).toFixed(2)}
                </td>
                <td>
                    <label class="toggle-switch" style="transform: scale(0.8);">
                        <input type="checkbox" id="trailing_${pos.id}" 
                               onchange="toggleTrailing(${pos.id}, this.checked)"
                               ${positions[pos.id]?.trailing ? 'checked' : ''}>
                        <span class="toggle-slider"></span>
                    </label>
                </td>
                <td>
                    <label class="toggle-switch" style="transform: scale(0.8);">
                        <input type="checkbox" id="breakeven_${pos.id}"
                               onchange="toggleBreakeven(${pos.id}, this.checked)"
                               ${positions[pos.id]?.breakeven ? 'checked' : ''}>
                        <span class="toggle-slider"></span>
                    </label>
                </td>
                <td>
                    <div class="position-actions">
                        <button class="action-btn" onclick="openPositionSettings(${pos.id}); event.stopPropagation();">${t('positions.settings')}</button>
                        <button class="action-btn" onclick="closeHalfPosition(${pos.id}); event.stopPropagation();">${t('positions.closeHalf')}</button>
                        <button class="action-btn" onclick="closePosition(${pos.id}); event.stopPropagation();">${t('positions.close')}</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    if (tbody.innerHTML !== newHTML) {
        tbody.innerHTML = newHTML;
    }
    
    const totalProfitEl = document.getElementById('totalProfit');
    document.getElementById('totalVolume').textContent = totalVolume.toFixed(2);
    totalProfitEl.textContent = `${totalProfit >= 0 ? '+' : ''}$${Math.abs(totalProfit).toFixed(2)}`;
    totalProfitEl.className = totalProfit >= 0 ? 'profit-value positive' : 'profit-value negative';
    
    const summaryRowFirstCell = tfoot.querySelector('.summary-row td:first-child');
    summaryRowFirstCell.textContent = `Total (${totalPositions} Pos.):`;
            
    positionsData.forEach(pos => {
        if (!positions[pos.id]) {
            positions[pos.id] = { trailing: false, breakeven: false, trailingProfit: 10, trailingDistance: 5, breakevenProfit: 5 };
        }
    });
    
    drawChart();
}
function updatePendingOrders(orders) {
    pendingOrdersData = orders || [];
    const pendingCountBadge = document.getElementById('pendingOrdersCount');
if (pendingCountBadge) {
    if (pendingOrdersData.length > 0) {
        pendingCountBadge.textContent = pendingOrdersData.length;
        pendingCountBadge.style.display = 'inline-block';
    } else {
        pendingCountBadge.style.display = 'none';
    }
}
    pendingOrders = orders || [];  // –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    const countBadge = document.getElementById('pendingOrdersCount');
    if (countBadge) {
        if (pendingOrdersData.length > 0) {
            countBadge.textContent = pendingOrdersData.length;
            countBadge.style.display = 'inline-block';
        } else 
        {
            countBadge.style.display = 'none';
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    const tbody = document.getElementById('pendingOrdersTableBody');
    if (tbody) {
        updatePendingOrdersTable();
    }
    
    drawChart();
}
function updatePendingOrdersTable() {
    const tbody = document.getElementById('pendingOrdersTableBody');
    const tfoot = document.getElementById('pendingOrdersTableFooter');
    
    if (!tbody) return;
    
    if (pendingOrdersData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" style="text-align: center; color: var(--text-secondary); padding: 40px;">
                    No pending orders
                </td>
            </tr>
        `;
        if (tfoot) tfoot.style.display = 'none';
        return;
    }
    
    if (tfoot) tfoot.style.display = 'table-footer-group';
    
    let totalVolume = 0;
    pendingOrdersData.forEach(order => {
        totalVolume += order.volume;
    });
    
    const newHTML = pendingOrdersData.map(order => {
        const isBuyLimit = order.type === 'buy_limit';
        let distance;
        if (order.symbol.includes('XAU') || order.symbol.includes('GOLD')) {
            distance = Math.abs(order.price - currentBid) / 0.1;
        } else if (order.symbol.includes('JPY')) {
            distance = Math.abs(order.price - currentBid) / 0.001;
        } else {
            distance = Math.abs(order.price - currentBid) / 0.00001;
        }
        const distanceText = order.price > currentBid ? `+${distance.toFixed(1)}` : `-${distance.toFixed(1)}`;
        
        return `
            <tr>
                <td>#${order.ticket}</td>
                <td class="position-symbol">${order.symbol}</td>
                <td><span class="position-type-badge ${isBuyLimit ? 'buy' : 'sell'}">${order.type.replace('_', ' ').toUpperCase()}</span></td>
                <td>${order.volume.toFixed(2)}</td>
                <td>${formatPrice(order.price)}</td>
                <td>${distanceText} pips</td>
                <td>${order.sl ? formatPrice(order.sl) : '-'}</td>
                <td>${order.tp ? formatPrice(order.tp) : '-'}</td>
                <td>${new Date(order.time_setup).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</td>
                <td>
                    <div class="position-actions">
                        <button class="action-btn" onclick="modifyPendingOrder(${order.ticket})">Modify</button>
                        <button class="action-btn" onclick="cancelPendingOrder(${order.ticket})">Cancel</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    tbody.innerHTML = newHTML;
    
    if (document.getElementById('totalPendingOrders')) {
        document.getElementById('totalPendingOrders').textContent = `Total: ${pendingOrdersData.length} Orders`;
    }
    if (document.getElementById('totalPendingVolume')) {
        document.getElementById('totalPendingVolume').textContent = totalVolume.toFixed(2);
    }
}
function cancelPendingOrder(ticket) {
    console.log('Cancel order called with ticket:', ticket, 'Type:', typeof ticket);
    
    if (!confirm(`Cancel order #${ticket}?`)) {
        console.log('User cancelled confirmation');
        return;
    }
    
    if (ws && ws.readyState === WebSocket.OPEN) {
        const message = {
            type: 'cancelOrder',
            ticket: parseInt(ticket)  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–æ
        };
        console.log('Sending message:', message);
        ws.send(JSON.stringify(message));
    } else {
        console.log('WebSocket not ready, state:', ws ? ws.readyState : 'null');
    }
}
function cancelAllPendingOrders() {
    if (!confirm('Cancel all pending orders?')) return;
    
    pendingOrdersData.forEach(order => {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'cancelOrder',
                ticket: order.ticket
            }));
        }
    });
}
function modifyPendingOrder(ticket) {
    const order = pendingOrdersData.find(o => o.ticket === ticket);
    if (!order) return;
    
    selectedPendingOrderTicket = ticket;
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –≤ –¥–∏–∞–ª–æ–≥–µ
    const dialog = document.getElementById('pendingOrderSettingsDialog');
    if (!dialog) {
        // –ï—Å–ª–∏ –¥–∏–∞–ª–æ–≥–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
        createPendingOrderDialog();
        return;
    }
    
    document.getElementById('dialogPendingPrice').value = order.price;
    document.getElementById('dialogPendingSL').value = order.sl || '';
    document.getElementById('dialogPendingTP').value = order.tp || '';
    
    dialog.classList.add('active');
}
function createPendingOrderDialog() {
    const dialogHTML = `
        <div class="position-settings-dialog" id="pendingOrderSettingsDialog">
            <div class="dialog-header">
                <div class="dialog-title">Modify Pending Order</div>
                <button class="dialog-close" onclick="closePendingOrderSettings()">‚úï</button>
            </div>
            <div class="dialog-content">
                <div class="setting-section">
                    <div class="setting-title">Order Settings</div>
                    <div class="setting-row">
                        <span>Price</span>
                        <input type="number" class="setting-value-input" id="dialogPendingPrice" step="0.00001">
                    </div>
                    <div class="setting-row">
                        <span>Stop Loss</span>
                        <input type="number" class="setting-value-input" id="dialogPendingSL" step="0.00001" placeholder="Optional">
                    </div>
                    <div class="setting-row">
                        <span>Take Profit</span>
                        <input type="number" class="setting-value-input" id="dialogPendingTP" step="0.00001" placeholder="Optional">
                    </div>
                </div>
                
                <div class="setting-section">
                    <div class="setting-title">Auto Settings (After Activation)</div>
                    <div class="setting-row">
                        <span>Enable Trailing</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="dialogPendingTrailing">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-row">
                        <span>Trailing Start ($)</span>
                        <input type="number" class="setting-value-input" id="dialogPendingTrailingProfit" value="10">
                    </div>
                    <div class="setting-row">
                        <span>Enable Breakeven</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="dialogPendingBreakeven">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-row">
                        <span>Breakeven at ($)</span>
                        <input type="number" class="setting-value-input" id="dialogPendingBreakevenProfit" value="5">
                    </div>
                </div>
                
                <button class="apply-btn" onclick="applyPendingOrderSettings()">Apply Changes</button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', dialogHTML);
    
    const dialog = document.getElementById('pendingOrderSettingsDialog');
    const order = pendingOrdersData.find(o => o.ticket === selectedPendingOrderTicket);
    if (order) {
        document.getElementById('dialogPendingPrice').value = order.price;
        document.getElementById('dialogPendingSL').value = order.sl || '';
        document.getElementById('dialogPendingTP').value = order.tp || '';
    }
    dialog.classList.add('active');
}
function closePendingOrderSettings() {
    const dialog = document.getElementById('pendingOrderSettingsDialog');
    if (dialog) {
        dialog.classList.remove('active');
    }
    selectedPendingOrderTicket = null;
}
function applyPendingOrderSettings() {
    if (!selectedPendingOrderTicket) return;
    
    const newPrice = parseFloat(document.getElementById('dialogPendingPrice').value);
    const newSL = parseFloat(document.getElementById('dialogPendingSL').value) || 0;
    const newTP = parseFloat(document.getElementById('dialogPendingTP').value) || 0;
    
    const trailing = document.getElementById('dialogPendingTrailing').checked;
    const trailingProfit = parseFloat(document.getElementById('dialogPendingTrailingProfit').value);
    const breakeven = document.getElementById('dialogPendingBreakeven').checked;
    const breakevenProfit = parseFloat(document.getElementById('dialogPendingBreakevenProfit').value);
    
    if (ws && ws.readyState === WebSocket.OPEN) {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—é –æ—Ä–¥–µ—Ä–∞
        ws.send(JSON.stringify({
            type: 'modifyPending',
            ticket: selectedPendingOrderTicket,
            price: newPrice,
            sl: newSL,
            tp: newTP,
            automation: {
                trailing: trailing,
                trailingProfit: trailingProfit,
                breakeven: breakeven,
                breakevenProfit: breakevenProfit
            }
        }));
    }
    
    closePendingOrderSettings();
    showNotification('Pending order modification sent', 'info');
}
function switchPositionsTab(tab) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
    document.querySelectorAll('.positions-panel-tab').forEach(t => {
        t.classList.remove('active');
    });
    document.querySelectorAll('.positions-panel-tab-content').forEach(c => {
        c.classList.remove('active');
    });

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É
    if (tab === 'positions') {
        const posTab = document.querySelector('.positions-panel-tab:first-child');
        if (posTab) posTab.classList.add('active');
        const posContent = document.getElementById('positions-tab');
        if (posContent) posContent.classList.add('active');
    } else if (tab === 'pending') {
        const pendTab = document.querySelector('.positions-panel-tab:last-child');
        if (pendTab) pendTab.classList.add('active');
        const pendContent = document.getElementById('pending-tab');
        if (pendContent) pendContent.classList.add('active');
    }
}
// Calculate dollar value from pips - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
function calculateDollarValueFromPriceDiff(openPrice, stopPrice, volume, symbol) {
    const priceDiff = Math.abs(openPrice - stopPrice);

    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–ª—è –∑–æ–ª–æ—Ç–∞
    if (symbol.includes('XAU') || symbol.includes('GOLD')) {
        // –î–ª—è –∑–æ–ª–æ—Ç–∞: –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –Ω–∞ $1 –ø—Ä–∏ 0.01 –ª–æ—Ç–µ = $1 –ø—Ä–æ—Ñ–∏—Ç–∞
        return priceDiff * volume * 100;
    }
    
    // –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã - –ø—Ä—è–º–æ–π —Ä–∞—Å—á–µ—Ç
    if (symbol.includes('BTC') || symbol.includes('ETH')) {
        return priceDiff * volume;
    }

    // –†–∞—Å—á–µ—Ç –¥–ª—è JPY –ø–∞—Ä (3 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏)
    if (symbol.includes('JPY')) {
        const points = priceDiff / 0.001;  // –î–ª—è JPY point = 0.001
        return points * volume;  // 100 points = $1 –ø—Ä–∏ 0.01 –ª–æ—Ç–µ
    }

    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–ª—è Forex –ø–∞—Ä (EURUSD, GBPUSD –∏ —Ç.–¥.)
    // –ü–æ –ª–æ–≥–∏–∫–µ –±—Ä–æ–∫–µ—Ä–∞: –¥–≤–∏–∂–µ–Ω–∏–µ –Ω–∞ 0.001 (100 points) = $1 –ø—Ä–∏ 0.01 –ª–æ—Ç–µ
    // –§–æ—Ä–º—É–ª–∞: priceDiff * volume * 100000
    return priceDiff * volume * 100000;
}

        // Toggle SL unit
        function toggleSLUnit(unit) {
            slUnit = unit;
            document.getElementById('slUnitPips').classList.toggle('active', unit === 'pips');
            document.getElementById('slUnitDollar').classList.toggle('active', unit === 'dollar');
            
            const input = document.getElementById('stopLoss');
            input.placeholder = unit === 'pips' ? 'Points' : 'Dollar amount';
        }

        // Toggle TP unit
        function toggleTPUnit(unit) {
            tpUnit = unit;
            document.getElementById('tpUnitPips').classList.toggle('active', unit === 'pips');
            document.getElementById('tpUnitDollar').classList.toggle('active', unit === 'dollar');
            
            const input = document.getElementById('takeProfit');
            input.placeholder = unit === 'pips' ? 'Points' : 'Dollar amount';
        }

        // Toggle risk mode
        function toggleRiskMode() {
            riskMode = document.getElementById('riskModeToggle').checked;
            document.getElementById('riskInputs').classList.toggle('active', riskMode);
            document.getElementById('calculatedValues').style.display = riskMode ? 'block' : 'none';
            document.getElementById('volumeGroup').style.display = riskMode ? 'none' : 'block';
            
            if (riskMode) {
                calculateRiskValues();
            }
        }

        // Calculate risk values
        function calculateRiskValues() {
            const riskPercent = parseFloat(document.getElementById('riskPercent').value) || 1;
            const rewardRatio = parseFloat(document.getElementById('rewardRatio').value) || 3;
            
            const riskAmount = (balance * riskPercent) / 100;
            const profitAmount = riskAmount * rewardRatio;
            
            document.getElementById('calcRiskAmount').textContent = `$${riskAmount.toFixed(2)}`;
            document.getElementById('calcProfit').textContent = `$${profitAmount.toFixed(2)}`;
            
            // Calculate volume based on risk
            const stopLoss = parseFloat(document.getElementById('stopLoss').value) || 50;
            const stopLossPoints = slUnit === 'dollar' ? calculatePipsFromDollar(stopLoss, 0.01) : stopLoss;
            
            if (stopLossPoints > 0) {
                const calculatedVolume = riskAmount / (stopLossPoints * 10);
                document.getElementById('calcVolume').textContent = calculatedVolume.toFixed(2);
            }
        }

        // Position management functions
        function selectPosition(positionId) {
            selectedPositionId = positionId;
            
            // Update UI selection
            document.querySelectorAll('.positions-table tr').forEach(row => {
                row.classList.remove('selected');
            });
            
            const selectedRow = document.querySelector(`tr[data-position-id="${positionId}"]`);
            if (selectedRow) {
                selectedRow.classList.add('selected');
            }
        }

        function highlightPosition(positionId) {
            hoveredPosition = positionId;
            drawChart();
        }

        function unhighlightPosition() {
            hoveredPosition = null;
            drawChart();
        }

       function openPositionSettings(positionId) {
    selectedPositionId = positionId;
    const pos = positionsData.find(p => p.id === positionId);
    if (!pos) return;
    
    // –ò–°–ü–û–õ–¨–ó–£–ï–ú –ù–û–í–£–Æ –ü–†–ê–í–ò–õ–¨–ù–£–Æ –§–£–ù–ö–¶–ò–Æ –î–õ–Ø –†–ê–°–ß–ï–¢–ê
    document.getElementById('dialogSL').value = pos.sl ? 
        calculateDollarValueFromPriceDiff(pos.openPrice, pos.sl, pos.volume, pos.symbol).toFixed(2) : '';
    document.getElementById('dialogTP').value = pos.tp ? 
        calculateDollarValueFromPriceDiff(pos.openPrice, pos.tp, pos.volume, pos.symbol).toFixed(2) : '';
    
    const settings = positions[positionId] || {};
    document.getElementById('dialogTrailing').checked = settings.trailing || false;
    document.getElementById('dialogTrailingProfit').value = settings.trailingProfit || 10;
    document.getElementById('dialogTrailingDistance').value = settings.trailingDistance || 5;
    document.getElementById('dialogBreakeven').checked = settings.breakeven || false;
    document.getElementById('dialogBreakevenProfit').value = settings.breakevenProfit || 5;
    
    document.getElementById('positionSettingsDialog').classList.add('active');
}

function closePositionSettings() {
    document.getElementById('positionSettingsDialog').classList.remove('active');
}

function applyPositionSettings() {
    if (!selectedPositionId) return;
    
    const pos = positionsData.find(p => p.id === selectedPositionId);
    if (!pos) return;
    
    const slDollar = parseFloat(document.getElementById('dialogSL').value);
    const tpDollar = parseFloat(document.getElementById('dialogTP').value);
    
    if (ws && ws.readyState === WebSocket.OPEN) {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º modify –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ SL –∏–ª–∏ TP
        const hasSlChange = !isNaN(slDollar) && (slDollar > 0 || document.getElementById('dialogSL').value === '0');
        const hasTpChange = !isNaN(tpDollar) && (tpDollar > 0 || document.getElementById('dialogTP').value === '0');
        
        if (hasSlChange || hasTpChange) {
            let modification = { type: 'modify', positionId: selectedPositionId };
            
            if (hasSlChange) {
                if (slDollar > 0) {
                    let priceChange;
                    if (pos.symbol.includes('XAU') || pos.symbol.includes('GOLD')) {
                        priceChange = slDollar / (pos.volume * 100);
                    } else if (pos.symbol.includes('BTC') || pos.symbol.includes('ETH')) {
                        priceChange = slDollar / pos.volume;
                    } else if (pos.symbol.includes('JPY')) {
                        priceChange = (slDollar / pos.volume) * 0.001;
                    } else {
                        priceChange = slDollar / (pos.volume * 100000);
                    }
                    
                    modification.sl_price = pos.type === 'buy' ? 
                        pos.openPrice - priceChange : 
                        pos.openPrice + priceChange;
                } else {
                    modification.sl_price = 0;
                }
            }

            if (hasTpChange) {
                if (tpDollar > 0) {
                    let priceChange;
                    if (pos.symbol.includes('XAU') || pos.symbol.includes('GOLD')) {
                        priceChange = tpDollar / (pos.volume * 100);
                    } else if (pos.symbol.includes('BTC') || pos.symbol.includes('ETH')) {
                        priceChange = tpDollar / pos.volume;
                    } else if (pos.symbol.includes('JPY')) {
                        priceChange = (tpDollar / pos.volume) * 0.001;
                    } else {
                        priceChange = tpDollar / (pos.volume * 100000);
                    }
                    
                    modification.tp_price = pos.type === 'buy' ? 
                        pos.openPrice + priceChange : 
                        pos.openPrice - priceChange;
                } else {
                    modification.tp_price = 0;
                }
            }
            
            ws.send(JSON.stringify(modification));
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–≥–¥–∞
        const trailing = document.getElementById('dialogTrailing').checked;
        const trailingProfit = parseFloat(document.getElementById('dialogTrailingProfit').value);
        const trailingDistance = parseFloat(document.getElementById('dialogTrailingDistance').value);
        const breakeven = document.getElementById('dialogBreakeven').checked;
        const breakevenProfit = parseFloat(document.getElementById('dialogBreakevenProfit').value);
        const partialClose = parseFloat(document.getElementById('dialogPartialClose').value);

        // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        console.log('Partial close value:', partialClose);
        
        ws.send(JSON.stringify({
            type: 'automation',
            positionId: selectedPositionId,
            settings: {
                trailing: trailing,
                trailing_profit: trailingProfit,
                trailing_distance: trailingDistance,
                breakeven: breakeven,
                breakeven_profit: breakevenProfit,
                partial_close: !isNaN(partialClose) && partialClose > 0 ? true : false,
                partial_close_profit: !isNaN(partialClose) && partialClose > 0 ? partialClose : null,
                partial_closed: false
            }
        }));
    }
    
    closePositionSettings();
    showNotification('Position settings updated', 'success');
}

        function toggleTrailing(positionId, enabled) {
            if (!positions[positionId]) {
                positions[positionId] = {};
            }
            positions[positionId].trailing = enabled;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'automation',
                    positionId: positionId,
                    automationType: 'trailing',
                    settings: {
                        enabled: enabled,
                        profitTrigger: positions[positionId].trailingProfit || 10,
                        distance: positions[positionId].trailingDistance || 5
                    }
                }));
            }
            
            showNotification(
                enabled ? `Auto-trailing activated for position #${positionId}` : 
                         `Auto-trailing deactivated for position #${positionId}`,
                enabled ? 'success' : 'info'
            );
        }

        function toggleBreakeven(positionId, enabled) {
            if (!positions[positionId]) {
                positions[positionId] = {};
            }
            positions[positionId].breakeven = enabled;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'automation',
                    positionId: positionId,
                    automationType: 'breakeven',
                    settings: {
                        enabled: enabled,
                        profitTrigger: positions[positionId].breakevenProfit || 5
                    }
                }));
            }
            
            showNotification(
                enabled ? `Auto-breakeven activated for position #${positionId}` : 
                         `Auto-breakeven deactivated for position #${positionId}`,
                enabled ? 'success' : 'info'
            );
        }

      function closeHalfPosition(positionId) {
    if (!isConnected) {
        showNotification('Not connected to server', 'error');
        return;
    }
    
    const pos = positionsData.find(p => p.id === positionId);
    if (!pos) return;
    
    const halfVolume = (pos.volume / 2).toFixed(2);
    
    ws.send(JSON.stringify({
        type: 'closePartial',
        positionId: positionId,
        volume: parseFloat(halfVolume)
    }));
}

function executeTrade(type) {
    if (!isConnected) {
        showNotification('Not connected to server', 'error');
        return;
    }
    
    const volume = parseFloat(document.getElementById('lotSize').value);
    const slValue = parseFloat(document.getElementById('stopLoss').value) || null;
    const tpValue = parseFloat(document.getElementById('takeProfit').value) || null;

    const order = {
        type: 'order',  // –í—Å–µ–≥–¥–∞ 'order' –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ—Ä–¥–µ—Ä–æ–≤
        symbol: getBrokerSymbol(currentSymbol),
        volume: volume,
        action: type,  // 'buy' –∏–ª–∏ 'sell'
        sl: slValue,
        tp: tpValue,
        sl_unit: slUnit,
        tp_unit: tpUnit
    };
    
    // –°–æ–±–∏—Ä–∞–µ–º preset –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
    if (document.getElementById('presetTrailing').checked) {
        order.trailing = true;
        order.trailing_profit = parseFloat(document.getElementById('presetTrailingProfit').value) || 10;
        order.trailing_distance = parseFloat(document.getElementById('presetTrailingDistance').value) || 5;
    }
    
    if (document.getElementById('presetBreakeven').checked) {
        order.breakeven = true;
        order.breakeven_profit = parseFloat(document.getElementById('presetBreakevenProfit').value) || 5;
    }
    
    if (orderType === 'limit') {
        const limitPrice = parseFloat(document.getElementById('limitPrice').value);
        
        if (!limitPrice) {
            showNotification('Please enter limit price', 'error');
            return;
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
        if (type === 'buy' && limitPrice >= currentAsk) {
            showNotification('Buy Limit price must be below current Ask price', 'error');
            return;
        }
        if (type === 'sell' && limitPrice <= currentBid) {
            showNotification('Sell Limit price must be above current Bid price', 'error');
            return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
        order.order_type = type === 'buy' ? 'buy_limit' : 'sell_limit';
        order.price = limitPrice;
    } else {
        order.order_type = 'market';  // –î–ª—è —Ä—ã–Ω–æ—á–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
    }
    
    ws.send(JSON.stringify(order));
}
function handleExecution(data) {
            if (data.success) {
                showNotification(`Order executed: ${data.type} ${data.volume} ${data.symbol}`, 'success');
                
                // Request positions update
                ws.send(JSON.stringify({
                    type: 'request',
                    data: 'positions'
                }));
            } else {
                showNotification(`Order failed: ${data.error}`, 'error');
            }
        }

        // Close position
        function closePosition(positionId) {
            if (!isConnected) {
                showNotification('Not connected to server', 'error');
                return;
            }
            
                     ws.send(JSON.stringify({
                    type: 'close',
                    positionId: positionId
                }));
            }
        
        // Close all positions
        function closeAllPositions() {
            if (!confirm('Close all positions?')) return;
            
            if (!isConnected) {
                showNotification('Not connected to server', 'error');
                return;
            }
            
            ws.send(JSON.stringify({
                type: 'closeAll'
            }));
        }

        // Close all profitable positions
        function closeAllProfitable() {
            if (!confirm('Close all profitable positions?')) return;
            
            if (!isConnected) {
                showNotification('Not connected to server', 'error');
                return;
            }
            
            const profitableIds = positionsData
                .filter(p => p.profit > 0)
                .map(p => p.id);
            
            ws.send(JSON.stringify({
                type: 'closeMultiple',
                positionIds: profitableIds
            }));
        }

        // Close all losing positions
        function closeAllLosing() {
            if (!confirm('Close all losing positions?')) return;
            
            if (!isConnected) {
                showNotification('Not connected to server', 'error');
                return;
            }
            
            const losingIds = positionsData
                .filter(p => p.profit < 0)
                .map(p => p.id);
            
            ws.send(JSON.stringify({
                type: 'closeMultiple',
                positionIds: losingIds
            }));
        }

        // Switch tabs
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-section').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all tab buttons
            document.querySelectorAll('.panel-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Set active button
            event.target.classList.add('active');
        }

        /// Change symbol
function changeSymbol() {
    currentSymbol = document.getElementById('symbolSelect').value;
    SettingsManager.set('terminal.lastSymbol', currentSymbol);
    const brokerSymbol = getBrokerSymbol(currentSymbol);
    
    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –º–∞—Å—à—Ç–∞–±
    chartData = [];
    scrollOffset = 0;
    currentBid = 0;  // –î–û–ë–ê–í–õ–ï–ù–û
    currentAsk = 0;  // –î–û–ë–ê–í–õ–ï–ù–û
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–º–≤–æ–ª–∞
    if (currentSymbol.includes('XAU') || currentSymbol.includes('GOLD')) {
        priceMin = 3600;
        priceMax = 3700;
    } else if (currentSymbol.includes('BTC')) {
        priceMin = 100000;
        priceMax = 120000;
    } else if (currentSymbol.includes('JPY')) {
        priceMin = 140;
        priceMax = 150;
    } else {
        priceMin = 1.0;
        priceMax = 1.1;
    }
    priceRange = priceMax - priceMin;
    
    // –û—á–∏—â–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
    if (ctx) {
        ctx.clearRect(0, 0, chartWidth, chartHeight);
    }
    
    // –î–û–ë–ê–í–õ–ï–ù–û: –°—Ä–∞–∑—É —Ä–∏—Å—É–µ–º –ø—É—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫ —Å –Ω–æ–≤—ã–º –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º
    drawChart();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
    document.getElementById('chartLoader').classList.add('active');
    
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
            type: 'subscribe',
            symbol: brokerSymbol
        }));
        
        requestChartData();
    }
}
function getBrokerSymbol(symbol) {
    // –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã - –ë–ï–ó —Å—É—Ñ—Ñ–∏–∫—Å–∞
    if (symbol.includes('BTC') || symbol.includes('ETH')) {
        return symbol;
    }
    // –§–æ—Ä–µ–∫—Å –∏ –º–µ—Ç–∞–ª–ª—ã - –° —Å—É—Ñ—Ñ–∏–∫—Å–æ–º
    return symbol + '+';
}
        // Change timeframe
        function changeTimeframe(tf) {
            currentTimeframe = tf;
            
            // Update button states
            document.querySelectorAll('.tf-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Request new chart data
            requestChartData();
        }

        // Request chart data
        function requestChartData() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'chart',
                    symbol: currentSymbol,
                    timeframe: currentTimeframe,
                    count: 500
                }));
                
                // Show loader
                document.getElementById('chartLoader').classList.add('active');
            }
        }

        // Update chart with new data
        function updateChart(candles) {
            chartData = candles || generateDemoCandles();
            document.getElementById('chartLoader').classList.remove('active');
            
            // Calculate visible range
            calculatePriceRange();
            
            // Redraw chart
            drawChart();
            // Update indicators with new data
            updateAllIndicators();
        }

        // Generate demo candles (fallback)
        function generateDemoCandles() {
            const candles = [];
            let basePrice = currentSymbol.includes('BTC') ? 115000 : 1.08000;
            let priceVariation = currentSymbol.includes('BTC') ? 1000 : 0.001;
            
            for (let i = 0; i < 200; i++) {
                const open = basePrice + (Math.random() - 0.5) * priceVariation;
                const close = open + (Math.random() - 0.5) * priceVariation;
                const high = Math.max(open, close) + Math.random() * priceVariation * 0.5;
                const low = Math.min(open, close) - Math.random() * priceVariation * 0.5;
                
                candles.push({
                    time: new Date(Date.now() - (200 - i) * 3600000),
                    open: open,
                    high: high,
                    low: low,
                    close: close,
                    volume: Math.random() * 1000
                });
                
                basePrice = close;
            }
            
            return candles;
        }

        // Update last candle with tick data
        function updateLastCandle(tickData) {
            if (chartData.length > 0 && tickData.symbol === currentSymbol) {
                const lastCandle = chartData[chartData.length - 1];
                lastCandle.close = tickData.bid;
                lastCandle.high = Math.max(lastCandle.high, tickData.bid);
                lastCandle.low = Math.min(lastCandle.low, tickData.bid);
                
                // Redraw chart if visible
                if (scrollOffset === 0) {
                    drawChart();
                }
            }
        }

 function calculatePriceRange() {
    if (!chartData || chartData.length === 0) {
        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
        if (currentSymbol.includes('XAU') || currentSymbol.includes('GOLD')) {
            priceMin = 3600;
            priceMax = 3700;
        } else if (currentSymbol.includes('BTC')) {
            priceMin = 100000;
            priceMax = 120000;
        } else if (currentSymbol.includes('JPY')) {
            priceMin = 140;
            priceMax = 150;
        } else {
            priceMin = 1.0;
            priceMax = 1.1;
        }
        priceRange = priceMax - priceMin;
        return;
    }
    
    // Update max scroll
    maxScroll = Math.max(0, chartData.length - visibleCandles);
    
    const startIdx = Math.max(0, chartData.length - visibleCandles - scrollOffset);
    const endIdx = Math.min(chartData.length, startIdx + visibleCandles);
    
    let tempMin = Infinity;
    let tempMax = -Infinity;
    
    for (let i = startIdx; i < endIdx; i++) {
        const candle = chartData[i];
        if (candle && typeof candle.low === 'number' && typeof candle.high === 'number' 
            && !isNaN(candle.low) && !isNaN(candle.high)) {
            tempMin = Math.min(tempMin, candle.low);
            tempMax = Math.max(tempMax, candle.high);
        }
    }
    
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤–∞–ª–∏–¥–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–º–Ω—ã–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
    if (tempMin === Infinity || tempMax === -Infinity) {
        if (currentBid > 0) {
            priceMin = currentBid * 0.99;
            priceMax = currentBid * 1.01;
        } else {
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–µ—Ñ–æ–ª—Ç—ã –¥–ª—è —Å–∏–º–≤–æ–ª–∞
            if (currentSymbol.includes('XAU') || currentSymbol.includes('GOLD')) {
                priceMin = 3600;
                priceMax = 3700;
            } else if (currentSymbol.includes('BTC')) {
                priceMin = 100000;
                priceMax = 120000;
            } else if (currentSymbol.includes('JPY')) {
                priceMin = 140;
                priceMax = 150;
            } else {
                priceMin = 1.0;
                priceMax = 1.1;
            }
        }
    } else {
        priceMin = tempMin;
        priceMax = tempMax;
    }
    
    // Include current price in range
    if (currentBid > 0 && !isNaN(currentBid)) {
        priceMin = Math.min(priceMin, currentBid);
        priceMax = Math.max(priceMax, currentBid);
    }
    
    // Add padding
    const padding = (priceMax - priceMin) * 0.1;
    priceMin -= padding;
    priceMax += padding;
    priceRange = priceMax - priceMin;
    
    // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    if (!isFinite(priceRange) || priceRange <= 0) {
        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π range
        if (currentSymbol.includes('XAU')) {
            priceRange = 100;
        } else if (currentSymbol.includes('BTC')) {
            priceRange = 5000;
        } else {
            priceRange = 0.1;
        }
        priceMax = priceMin + priceRange;
    }
}

// Initialize chart
function initChart() {
    canvas = document.getElementById('tradingChart');
    ctx = canvas.getContext('2d');
    
    // –£–ë–ò–†–ê–ï–ú ResizeObserver - –æ–Ω —Å–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å window.resize
    // –†–∞–∑–º–µ—Ä—ã –±—É–¥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ window.resize –≤ window.load
    
    // Add event listeners for chart
    canvas.addEventListener('mousemove', handleMouseMove);
    canvas.addEventListener('mousedown', handleMouseDown);
    canvas.addEventListener('mouseup', handleMouseUp);
    canvas.addEventListener('mouseleave', handleMouseLeave);
    canvas.addEventListener('wheel', handleMouseWheel);
    canvas.addEventListener('dblclick', handleDoubleClick);
    
    const yAxisHandle = document.getElementById('yAxisHandle');
    const xAxisHandle = document.getElementById('xAxisHandle');
    
    yAxisHandle.addEventListener('mousedown', handleYAxisMouseDown);
    xAxisHandle.addEventListener('mousedown', handleXAxisMouseDown);
    
    document.addEventListener('mousemove', handleAxisMouseMove);
    document.addEventListener('mouseup', handleAxisMouseUp);
}
// Panel resize functionality
function initPanelResize() {
    const resizer = document.getElementById('panelResizer');
    const positionsPanel = document.querySelector('.positions-panel'); // –ò–∑–º–µ–Ω–µ–Ω–æ
    const chartContainer = document.querySelector('.chart-container');
    
    if (!resizer || !positionsPanel) return; // –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞
    
    let isResizing = false;
    let startY = 0;
    let startHeight = 0;
    
    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        startY = e.clientY;
        startHeight = positionsPanel.offsetHeight;
        
        e.preventDefault();
        document.body.style.userSelect = 'none';
        document.body.style.cursor = 'ns-resize';
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const deltaY = startY - e.clientY;
        const newHeight = Math.min(
            Math.max(150, startHeight + deltaY),
            window.innerHeight * 0.6
        );
        
        positionsPanel.style.height = newHeight + 'px';
        positionsPanel.style.flex = 'none'; // –í–∞–∂–Ω–æ!
        
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas
        if (canvas && canvas.parentElement) {
            resizeCanvas();
        }
    });
    
    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.userSelect = '';
            document.body.style.cursor = '';
        }
    });
}
function resizeCanvas() {
    const container = canvas.parentElement;
    if (!container) return;
    
    const newWidth = container.offsetWidth;
    const newHeight = container.offsetHeight;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è —Ä–∞–∑–º–µ—Ä
    if (canvas.width === newWidth && canvas.height === newHeight) {
        return; 
    }
    
    canvas.width = newWidth;
    canvas.height = newHeight;
    
    chartWidth = canvas.width;
    chartHeight = canvas.height;
    
    const availableWidth = chartWidth - 60 - chartPadding;
    visibleCandles = Math.floor(availableWidth / (candleWidth + candleSpacing));
    
    // –í—ã–∑—ã–≤–∞–µ–º drawChart —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
    if (chartData && chartData.length > 0) {
        calculatePriceRange();
        drawChart();
    }
}
// Draw chart
function drawChart() {
    if (!ctx || chartData.length === 0) return;
    
    // Clear canvas
    ctx.clearRect(0, 0, chartWidth, chartHeight);
    
    // Draw background
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary');
    ctx.fillRect(0, 0, chartWidth, chartHeight);
    
    // Draw grid
    drawGrid();
    
    // Draw candles
    drawCandles();
    
    // Draw current price line
    drawCurrentPriceLine();
    
    // Draw positions
    drawPositions();
    
    // Draw drawings
    drawAllDrawings();
    
    // Draw pending orders
    drawPendingOrders();
    
    // Draw price axis
    drawPriceAxis();
    
    // Draw time axis
    drawTimeAxis();
    
    // Draw crosshair if active
    if (selectedTool === 'crosshair') {
        drawCrosshair();
    }
    // Update indicators with current visible range
if (Object.keys(activeIndicators).length > 0) {
    for (const [type, indicator] of Object.entries(activeIndicators)) {
        if (indicator.enabled && indicator.iframe.contentWindow) {
            // Send visible range to indicator
            indicator.iframe.contentWindow.postMessage({
                type: 'updateView',
                startIdx: Math.max(0, chartData.length - visibleCandles - scrollOffset),
                endIdx: chartData.length - scrollOffset,
                priceMin: priceMin,
                priceMax: priceMax,
                width: chartWidth - 60,
                height: chartHeight - 45
            }, '*');
        }
    }
}
}
function drawCurrentPriceLine() {
    if (!document.getElementById('showPriceLine').checked || currentBid <= 0) return;
    
    const y = priceToY(currentBid);
    
    // Draw line
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
    ctx.lineWidth = 2;
    ctx.setLineDash([10, 5]);
    
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(chartWidth - 60, y);
    ctx.stroke();
    
    // Draw price label
    ctx.setLineDash([]);
    const labelWidth = 80;
    const labelHeight = 24;
    
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
    ctx.fillRect(chartWidth - 60, y - labelHeight/2, labelWidth, labelHeight);
    
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary');
    ctx.font = 'bold 12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(formatPrice(currentBid), chartWidth - 20, y + 4);
}

// Draw grid
function drawGrid() {            if (!document.getElementById('showGrid').checked) return;
            
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            
            // Horizontal lines
            for (let i = 0; i <= 10; i++) {
                const y = (chartHeight - 30) * (i / 10) + 15;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(chartWidth - 60, y);
                ctx.stroke();
            }
            
            // Vertical lines
            const gridStep = Math.ceil(visibleCandles / 10);
            for (let i = 0; i < visibleCandles; i += gridStep) {
                const x = i * (candleWidth + candleSpacing) + candleWidth / 2;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, chartHeight - 30);
                ctx.stroke();
            }
        }

       function drawCandles() {
    const startIdx = chartData.length - visibleCandles - scrollOffset;
    const endIdx = startIdx + visibleCandles;
    
    // Get theme colors
    const bullColor = getComputedStyle(document.documentElement).getPropertyValue('--candle-bull');
    const bearColor = getComputedStyle(document.documentElement).getPropertyValue('--candle-bear');
    const wickColor = getComputedStyle(document.documentElement).getPropertyValue('--candle-wick');
    
    for (let i = startIdx; i < endIdx; i++) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏–Ω–¥–µ–∫—Å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–∞–Ω–Ω—ã—Ö
        if (i < 0 || i >= chartData.length) continue;
        
        const candle = chartData[i];
        const x = (i - startIdx) * (candleWidth + candleSpacing);
        
        // Calculate Y positions
        const yOpen = priceToY(candle.open);
        const yClose = priceToY(candle.close);
        const yHigh = priceToY(candle.high);
        const yLow = priceToY(candle.low);
        
        // Set color
        const bullish = candle.close >= candle.open;
        
        // Draw wick
        ctx.strokeStyle = wickColor;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(x + candleWidth / 2, yHigh);
        ctx.lineTo(x + candleWidth / 2, yLow);
        ctx.stroke();
        
        // Draw body
        const bodyHeight = Math.abs(yClose - yOpen) || 1;
        const bodyY = Math.min(yOpen, yClose);
        
        ctx.fillStyle = bullish ? bullColor : bearColor;
        ctx.fillRect(x, bodyY, candleWidth, bodyHeight);
        
        // Add subtle glow for neon/cyberpunk themes
        if (currentTheme === 'neon' || currentTheme === 'cyberpunk') {
            ctx.shadowColor = bullish ? bullColor : bearColor;
            ctx.shadowBlur = 3;
            ctx.fillRect(x, bodyY, candleWidth, bodyHeight);
            ctx.shadowBlur = 0;
        }
    }
    
    // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é –±—É–¥—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    const lastCandleX = (chartData.length - 1 - startIdx) * (candleWidth + candleSpacing) + candleWidth;
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
    ctx.lineWidth = 1;
    ctx.setLineDash([5, 5]);
    ctx.beginPath();
    ctx.moveTo(lastCandleX + candleSpacing, 0);
    ctx.lineTo(lastCandleX + candleSpacing, chartHeight - 30);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Update OHLC display
    if (chartData.length > 0 && scrollOffset >= 0 && scrollOffset < chartData.length) {
        const lastCandle = chartData[chartData.length - 1 - scrollOffset];
        if (lastCandle) {
            document.getElementById('ohlcOpen').textContent = formatPrice(lastCandle.open);
            document.getElementById('ohlcHigh').textContent = formatPrice(lastCandle.high);
            document.getElementById('ohlcLow').textContent = formatPrice(lastCandle.low);
            document.getElementById('ohlcClose').textContent = formatPrice(lastCandle.close);
        }
    }
}
        // Draw positions on chart with profit display
        function drawPositions() {
            const filteredPositions = positionsData.filter(pos => pos.symbol === currentSymbol);
            
            filteredPositions.forEach(pos => {
                const isHovered = hoveredPosition === pos.id;
                const lineWidth = isHovered ? 3 : 2;
                const opacity = isHovered ? 1 : 0.8;
                const entryY = priceToY(pos.openPrice);
                const isBuy = pos.type === 'buy';
                
                // Draw entry line
                ctx.strokeStyle = isBuy ? `rgba(34, 197, 94, ${opacity})` : `rgba(239, 68, 68, ${opacity})`;
                ctx.lineWidth = lineWidth;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(0, entryY);
                ctx.lineTo(chartWidth - 60, entryY);
                ctx.stroke();
                
                // Entry label
                ctx.setLineDash([]);
                ctx.fillStyle = isBuy ? 'rgba(34, 197, 94, 0.9)' : 'rgba(239, 68, 68, 0.9)';
                ctx.fillRect(chartWidth - 60, entryY - 12, 60, 24);
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 11px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(formatPrice(pos.openPrice), chartWidth - 5, entryY + 3);
                
                // Position info with dollar profit
                const profitText = `${isBuy ? 'BUY' : 'SELL'} ${pos.volume} | P/L: $${pos.profit.toFixed(2)}`;
                const textWidth = ctx.measureText(profitText).width + 20;
                ctx.fillStyle = isBuy ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)';
                ctx.fillRect(0, entryY - 12, textWidth, 24);
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 11px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(profitText, 10, entryY + 3);

                // Draw SL line with dollar value
                if (pos.sl) {
                    const slY = priceToY(pos.sl);
                    const slDollar = calculateDollarValueFromPriceDiff(pos.openPrice, pos.sl, pos.volume, pos.symbol);
                    
                    ctx.fillStyle = `rgba(239, 68, 68, 0.05)`;
                    ctx.fillRect(0, Math.min(entryY, slY), chartWidth - 60, Math.abs(slY - entryY));
                    
                    ctx.strokeStyle = `rgba(239, 68, 68, ${opacity * 0.7})`;
                    ctx.lineWidth = 1;
                    ctx.setLineDash([3, 3]);
                    ctx.beginPath();
                    ctx.moveTo(0, slY);
                    ctx.lineTo(chartWidth - 60, slY);
                    ctx.stroke();
                    
                    ctx.setLineDash([]);
                    ctx.fillStyle = 'rgba(239, 68, 68, 0.8)';
                    ctx.fillRect(chartWidth - 100, slY - 10, 90, 20);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(`SL -$${slDollar.toFixed(2)}`, chartWidth - 55, slY + 3);
                }
                
                // Draw TP line with dollar value
                if (pos.tp) {
                    const tpY = priceToY(pos.tp);
                    const tpDollar = calculateDollarValueFromPriceDiff(pos.openPrice, pos.tp, pos.volume, pos.symbol);

                    ctx.fillStyle = `rgba(34, 197, 94, 0.05)`;
                    ctx.fillRect(0, Math.min(entryY, tpY), chartWidth - 60, Math.abs(tpY - entryY));

                    ctx.strokeStyle = `rgba(34, 197, 94, ${opacity * 0.7})`;
                    ctx.lineWidth = 1;
                    ctx.setLineDash([3, 3]);
                    ctx.beginPath();
                    ctx.moveTo(0, tpY);
                    ctx.lineTo(chartWidth - 60, tpY);
                    ctx.stroke();
                    
                    ctx.setLineDash([]);
                    ctx.fillStyle = 'rgba(34, 197, 94, 0.8)';
                    ctx.fillRect(chartWidth - 100, tpY - 10, 90, 20);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(`TP +$${tpDollar.toFixed(2)}`, chartWidth - 55, tpY + 3);
                }
            });
        }

        // Drawing tools functions
        function selectTool(tool) {
    selectedTool = tool;
    drawingTool = null;
    
    const chartMain = document.querySelector('.chart-main');
    if (chartMain) {
        // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã –∫—É—Ä—Å–æ—Ä–æ–≤
        chartMain.classList.remove('crosshair-mode', 'drawing-mode', 'dragging');
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω—É–∂–Ω—ã–π –∫–ª–∞—Å—Å
        if (tool === 'crosshair') {
            chartMain.classList.add('crosshair-mode');
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    document.getElementById('drawingToolsPanel').classList.remove('active');
    
    drawChart();
}

       function selectDrawingTool(tool) {
    const chartMain = document.querySelector('.chart-main');
    if (chartMain) {
        chartMain.classList.remove('crosshair-mode');
        chartMain.classList.add('drawing-mode');
    }
            drawingTool = tool;
            selectedTool = 'drawing';
            
            // Update button states
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show drawing tools panel
            if (tool !== 'clear') {
                document.getElementById('drawingToolsPanel').classList.add('active');
            }
            
            canvas.style.cursor = 'crosshair';
        }

        function selectDrawingColor(color) {
            drawingColor = color;
            
            // Update color selection
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function clearAllDrawings() {
            if (confirm('Clear all drawings?')) {
                drawings = [];
                drawChart();
            }
        }
function startPendingOrder(type) {
    pendingOrderMode = true;
    pendingOrderType = type;
    pendingOrderStep = 'price';
    canvas.style.cursor = 'crosshair';
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    selectedTool = 'pending_order';
    drawingTool = null;
    isDrawing = false;
    currentDrawing = null;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    showNotification(`Click on chart to set ${type === 'buy_limit' ? 'Buy Limit' : 'Sell Limit'} price`, 'info');
}
// –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–µ–Ω—ã –ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
function placePendingOrderOnChart(price) {
    if (!pendingOrderMode || !pendingOrderType) return;
    
    const volume = parseFloat(document.getElementById('lotSize').value) || 0.01;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–Ω—ã –¥–ª—è Buy/Sell Limit
    if (pendingOrderType === 'buy_limit' && price >= currentAsk) {
        showNotification('Buy Limit price must be below current Ask price', 'error');
        return;
    }
    if (pendingOrderType === 'sell_limit' && price <= currentBid) {
        showNotification('Sell Limit price must be above current Bid price', 'error');
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ä–¥–µ—Ä–∞
    pendingOrderPreview = {
        type: pendingOrderType,
        price: price,
        volume: volume,
        sl: null,
        tp: null,
        symbol: currentSymbol,
        id: 'preview_' + Date.now()
    };
    
    pendingOrderStep = 'sl';
    showNotification('Click to set Stop Loss (or press ESC to skip)', 'info');
    drawChart();
}

// –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Stop Loss –¥–ª—è –ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
function setPendingOrderSL(price) {
    if (!pendingOrderPreview) return;
    
    const isBuyLimit = pendingOrderPreview.type === 'buy_limit';
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è SL
    if (isBuyLimit && price >= pendingOrderPreview.price) {
        showNotification('Stop Loss for Buy Limit must be below order price', 'error');
        return;
    }
    if (!isBuyLimit && price <= pendingOrderPreview.price) {
        showNotification('Stop Loss for Sell Limit must be above order price', 'error');
        return;
    }
    
    pendingOrderPreview.sl = price;
    pendingOrderStep = 'tp';
    showNotification('Click to set Take Profit (or press ESC to skip)', 'info');
    drawChart();
}

// –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Take Profit –¥–ª—è –ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
function setPendingOrderTP(price) {
    if (!pendingOrderPreview) return;
    
    const isBuyLimit = pendingOrderPreview.type === 'buy_limit';
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è TP
    if (isBuyLimit && price <= pendingOrderPreview.price) {
        showNotification('Take Profit for Buy Limit must be above order price', 'error');
        return;
    }
    if (!isBuyLimit && price >= pendingOrderPreview.price) {
        showNotification('Take Profit for Sell Limit must be below order price', 'error');
        return;
    }
    
    pendingOrderPreview.tp = price;
    submitPendingOrder();
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
function submitPendingOrder() {
    if (!pendingOrderPreview) return;
    
    const order = {
        type: 'order',  // –ò–∑–º–µ–Ω–µ–Ω–æ —Å 'pending' –Ω–∞ 'order'
        symbol: currentSymbol,
        action: pendingOrderPreview.type === 'buy_limit' ? 'buy' : 'sell',  // –ò–∑–≤–ª–µ–∫–∞–µ–º 'buy' –∏–ª–∏ 'sell'
        order_type: pendingOrderPreview.type,  // 'buy_limit' –∏–ª–∏ 'sell_limit'
        volume: pendingOrderPreview.volume,
        price: pendingOrderPreview.price  // –ò–∑–º–µ–Ω–µ–Ω–æ —Å 'limit_price' –Ω–∞ 'price'
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º SL –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    if (pendingOrderPreview.sl) {
        const slDistance = Math.abs(pendingOrderPreview.price - pendingOrderPreview.sl);
        if (currentSymbol.includes('XAU')) {
            order.sl = slDistance * pendingOrderPreview.volume * 100;
        } else {
            order.sl = slDistance / pendingOrderPreview.volume;
        }
        order.sl_unit = 'dollar';
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º TP –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    if (pendingOrderPreview.tp) {
        const tpDistance = Math.abs(pendingOrderPreview.tp - pendingOrderPreview.price);
        if (currentSymbol.includes('XAU')) {
            order.tp = tpDistance * pendingOrderPreview.volume * 100;
        } else {
            order.tp = tpDistance / pendingOrderPreview.volume;
        }
        order.tp_unit = 'dollar';
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(order));
        showNotification('Limit order sent', 'success');
    }
    
    // –û—á–∏—â–∞–µ–º —Ä–µ–∂–∏–º
    cancelPendingOrderMode();
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã —Ä–µ–∂–∏–º–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
function cancelPendingOrderMode() {
    pendingOrderMode = false;
    pendingOrderType = null;
    pendingOrderPreview = null;
    pendingOrderStep = 'price';
    canvas.style.cursor = 'default';
    
    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.tool-btn').forEach(btn => {
        if (btn.textContent === 'BL' || btn.textContent === 'SL') {
            btn.classList.remove('active');
        }
    });
    
    drawChart();
}
        function drawAllDrawings() {
            ctx.save();
            
            drawings.forEach(drawing => {
                ctx.strokeStyle = drawing.color || drawingColor;
                ctx.fillStyle = drawing.color || drawingColor;
                ctx.lineWidth = 2;
                
                switch (drawing.type) {
                    case 'line':
                        ctx.beginPath();
                        ctx.moveTo(drawing.x1, drawing.y1);
                        ctx.lineTo(drawing.x2, drawing.y2);
                        ctx.stroke();
                        break;
                        
                  case 'horizontal':
    const lineY = priceToY(drawing.price);  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É –≤ Y
    ctx.beginPath();
    ctx.moveTo(0, lineY);  // –ò—Å–ø–æ–ª—å–∑—É–µ–º lineY –≤–º–µ—Å—Ç–æ drawing.y
    ctx.lineTo(chartWidth - 60, lineY);
    ctx.stroke();
    
    // Draw price label
    ctx.fillStyle = drawing.color || drawingColor;
    ctx.fillRect(chartWidth - 60, lineY - 10, 60, 20);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary');
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(formatPrice(drawing.price), chartWidth - 30, lineY + 3);  // –ò—Å–ø–æ–ª—å–∑—É–µ–º drawing.price
    break;
                        
                    case 'rectangle':
                        ctx.globalAlpha = 0.2;
                        ctx.fillRect(
                            Math.min(drawing.x1, drawing.x2),
                            Math.min(drawing.y1, drawing.y2),
                            Math.abs(drawing.x2 - drawing.x1),
                            Math.abs(drawing.y2 - drawing.y1)
                        );
                        ctx.globalAlpha = 1;
                        ctx.strokeRect(
                            Math.min(drawing.x1, drawing.x2),
                            Math.min(drawing.y1, drawing.y2),
                            Math.abs(drawing.x2 - drawing.x1),
                            Math.abs(drawing.y2 - drawing.y1)
                        );
                        break;
                        
                    case 'text':
                        ctx.font = '14px sans-serif';
                        ctx.fillText(drawing.text, drawing.x, drawing.y);
                        break;
                }
            });
            
            ctx.restore();
        }
        function checkDrawingHover() {
    hoveredDrawing = null;
    
    for (let i = drawings.length - 1; i >= 0; i--) {
        const drawing = drawings[i];
        
        if (drawing.type === 'horizontal') {
            const lineY = priceToY(drawing.price);
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ø–∞–¥–∞–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –Ω–∞ –ª–∏–Ω–∏—é (¬±3 –ø–∏–∫—Å–µ–ª—è)
            if (Math.abs(mouseY - lineY) < 3 && mouseX < chartWidth - 60) {
                hoveredDrawing = i;
                canvas.style.cursor = 'pointer';
                return;
            }
        }
    }
}
// –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
// –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
function drawPendingOrders() {
    const style = getComputedStyle(document.documentElement);
    
    // –†–∏—Å—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ pending –æ—Ä–¥–µ—Ä–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
    pendingOrdersData.forEach(order => {
        if (order.symbol !== currentSymbol) return;
        
        const y = priceToY(order.price);
        const isBuyLimit = order.type === 'buy_limit';
        
        // –¶–≤–µ—Ç–∞ –∏–∑ —Ç–µ–º—ã
        const primaryColor = isBuyLimit ? style.getPropertyValue('--success') : style.getPropertyValue('--danger');
        
        // –õ–µ–≥–∫–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ª–∏–Ω–∏–∏
        const gradient = ctx.createLinearGradient(0, y - 2, 0, y + 2);
        gradient.addColorStop(0, `${primaryColor}00`);
        gradient.addColorStop(0.5, `${primaryColor}30`);
        gradient.addColorStop(1, `${primaryColor}00`);
        ctx.fillStyle = gradient;
        ctx.fillRect(0, y - 2, chartWidth - 60, 4);
        
        // –û—Å–Ω–æ–≤–Ω–∞—è –ª–∏–Ω–∏—è –æ—Ä–¥–µ—Ä–∞
        ctx.strokeStyle = primaryColor;
        ctx.lineWidth = 1.5;
        ctx.setLineDash([25, 8]);
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(chartWidth - 60, y);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // –ú–µ—Ç–∫–∞ –ü–û–î –õ–ò–ù–ò–ï–ô (—Å–º–µ—â–µ–Ω–∏–µ –≤–Ω–∏–∑ –Ω–∞ 5px –æ—Ç –ª–∏–Ω–∏–∏)
        const labelY = y + 25; // –ü–æ–∑–∏—Ü–∏—è –º–µ—Ç–∫–∏ –Ω–∏–∂–µ –ª–∏–Ω–∏–∏
        const labelText = `${isBuyLimit ? 'BUY' : 'SELL'} LIMIT`;
        const volumeText = `${order.volume.toFixed(2)} lots`;
        const ticketText = `#${order.ticket}`;
        
        ctx.font = '11px sans-serif';
        const labelWidth = Math.max(
            ctx.measureText(labelText).width,
            ctx.measureText(volumeText).width
        ) + 25;
        
        // –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –º–µ—Ç–∫–∏ –ø–æ–¥ –ª–∏–Ω–∏–µ–π
        ctx.fillStyle = `${style.getPropertyValue('--bg-panel')}ee`;
        ctx.fillRect(10, labelY - 15, labelWidth, 35);
        
        // –¢–æ–Ω–∫–∞—è —Ä–∞–º–∫–∞ –º–µ—Ç–∫–∏
        ctx.strokeStyle = `${primaryColor}bb`;
        ctx.lineWidth = 1;
        ctx.strokeRect(10, labelY - 15, labelWidth, 35);
        
        // –õ–∏–Ω–∏—è-—É–∫–∞–∑–∞—Ç–µ–ª—å –æ—Ç –º–µ—Ç–∫–∏ –∫ –æ—Ä–¥–µ—Ä—É
        ctx.strokeStyle = `${primaryColor}66`;
        ctx.lineWidth = 0.5;
        ctx.beginPath();
        ctx.moveTo(10 + labelWidth/2, labelY - 15);
        ctx.lineTo(10 + labelWidth/2, y);
        ctx.stroke();
        
        // –¢–µ–∫—Å—Ç—ã –≤ –º–µ—Ç–∫–µ
        ctx.fillStyle = primaryColor;
        ctx.font = 'bold 11px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(labelText, 18, labelY);
        
        ctx.fillStyle = style.getPropertyValue('--text-secondary');
        ctx.font = '10px sans-serif';
        ctx.fillText(volumeText, 18, labelY + 12);
        
        ctx.fillStyle = `${primaryColor}99`;
        ctx.font = '9px sans-serif';
        ctx.fillText(ticketText, 18, labelY - 5);
        
        // –¶–ï–ù–ê –°–ü–†–ê–í–ê (—Å–¥–≤–∏–Ω—É—Ç–∞ –ª–µ–≤–µ–µ —á—Ç–æ–±—ã –Ω–µ –æ–±—Ä–µ–∑–∞–ª–∞—Å—å)
        const priceLabel = formatPrice(order.price);
        ctx.font = 'bold 12px sans-serif';
        const priceWidth = ctx.measureText(priceLabel).width + 20;
        
        // –§–æ–Ω –¥–ª—è —Ü–µ–Ω—ã (—Å–¥–≤–∏–Ω—É—Ç –Ω–∞ 70px –æ—Ç –∫—Ä–∞—è)
        ctx.fillStyle = primaryColor;
        ctx.fillRect(chartWidth - 70 - priceWidth, y - 10, priceWidth, 20);
        
        // –¢–µ–∫—Å—Ç —Ü–µ–Ω—ã
        ctx.fillStyle = style.getPropertyValue('--bg-primary');
        ctx.textAlign = 'right';
        ctx.fillText(priceLabel, chartWidth - 75, y + 3);
        ctx.textAlign = 'left';
        
        // SL/TP –ª–∏–Ω–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å (–æ—á–µ–Ω—å —Ç–æ–Ω–∫–∏–µ)
        if (order.sl) {
            const slY = priceToY(order.sl);
            ctx.strokeStyle = `${style.getPropertyValue('--danger')}25`;
            ctx.lineWidth = 0.5;
            ctx.setLineDash([5, 15]);
            ctx.beginPath();
            ctx.moveTo(0, slY);
            ctx.lineTo(chartWidth - 60, slY);
            ctx.stroke();
            ctx.setLineDash([]);
        }
        
        if (order.tp) {
            const tpY = priceToY(order.tp);
            ctx.strokeStyle = `${style.getPropertyValue('--success')}25`;
            ctx.lineWidth = 0.5;
            ctx.setLineDash([5, 15]);
            ctx.beginPath();
            ctx.moveTo(0, tpY);
            ctx.lineTo(chartWidth - 60, tpY);
            ctx.stroke();
            ctx.setLineDash([]);
        }
    });
    
    // –¢–∞–∫–∂–µ —Ä–∏—Å—É–µ–º –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    pendingOrders.forEach(order => {
        if (order.symbol !== currentSymbol) return;
        
        const y = priceToY(order.price);
        const isBuyLimit = order.type === 'buy_limit';
        const primaryColor = isBuyLimit ? style.getPropertyValue('--success') : style.getPropertyValue('--danger');
        
        // –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –ª–∏–Ω–∏—è
        ctx.strokeStyle = primaryColor;
        ctx.lineWidth = 1.5;
        ctx.setLineDash([25, 8]);
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(chartWidth - 60, y);
        ctx.stroke();
        ctx.setLineDash([]);
    });
    
    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–æ–≤–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
    if (pendingOrderPreview) {
        const y = priceToY(pendingOrderPreview.price);
        const isBuyLimit = pendingOrderPreview.type === 'buy_limit';
        const primaryColor = style.getPropertyValue('--accent-primary');
        
        // –ü—É–ª—å—Å–∏—Ä—É—é—â–∞—è –ª–∏–Ω–∏—è
        ctx.strokeStyle = primaryColor;
        ctx.lineWidth = 2;
        ctx.setLineDash([15, 5]);
        ctx.globalAlpha = 0.9;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(chartWidth - 60, y);
        ctx.stroke();
        ctx.globalAlpha = 1;
        ctx.setLineDash([]);
        
        // –ú–µ—Ç–∫–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É
        const labelText = `PLACING ${isBuyLimit ? 'BUY' : 'SELL'} LIMIT`;
        ctx.font = 'bold 12px sans-serif';
        const textWidth = ctx.measureText(labelText).width + 25;
        
        ctx.fillStyle = `${style.getPropertyValue('--bg-panel')}f5`;
        ctx.fillRect(chartWidth/2 - textWidth/2, y + 10, textWidth, 25);
        
        ctx.strokeStyle = primaryColor;
        ctx.lineWidth = 1.5;
        ctx.strokeRect(chartWidth/2 - textWidth/2, y + 10, textWidth, 25);
        
        ctx.fillStyle = primaryColor;
        ctx.textAlign = 'center';
        ctx.fillText(labelText, chartWidth/2, y + 27);
        ctx.textAlign = 'left';
    }
}
        // Handle double click for adding SL/TP
        function handleDoubleClick(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // Check if clicking in chart area
            if (x > chartWidth - 60 || y > chartHeight - 30) return;
            
            // Find nearest position
            const clickedPrice = yToPrice(y);
            const nearestPosition = findNearestPosition(clickedPrice);
            
            if (nearestPosition) {
                const pos = positionsData.find(p => p.id === nearestPosition);
                if (!pos) return;
                
                const isBuy = pos.type === 'buy';
                const isAboveEntry = clickedPrice > pos.openPrice;
                
                // Determine if setting SL or TP based on position
                if ((isBuy && !isAboveEntry) || (!isBuy && isAboveEntry)) {
                    // Set Stop Loss
                    if (confirm(`Set Stop Loss at ${formatPrice(clickedPrice)}?`)) {
                        const slPips = Math.abs(pos.openPrice - clickedPrice) / 0.0001;
                        ws.send(JSON.stringify({
                            type: 'modify',
                            positionId: nearestPosition,
                            sl: slPips,
                            tp: null
                        }));
                    }
                } else {
                    // Set Take Profit
                    if (confirm(`Set Take Profit at ${formatPrice(clickedPrice)}?`)) {
                        const tpPips = Math.abs(clickedPrice - pos.openPrice) / 0.0001;
                        ws.send(JSON.stringify({
                            type: 'modify',
                            positionId: nearestPosition,
                            sl: null,
                            tp: tpPips
                        }));
                    }
                }
            }
        }

        function findNearestPosition(price) {
            const filteredPositions = positionsData.filter(pos => pos.symbol === currentSymbol);
            if (filteredPositions.length === 0) return null;
            
            let nearest = filteredPositions[0].id;
            let minDistance = Math.abs(price - filteredPositions[0].openPrice);
            
            filteredPositions.forEach(pos => {
                const distance = Math.abs(price - pos.openPrice);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = pos.id;
                }
            });
            
            return nearest;
        }

        // Draw price axis
        function drawPriceAxis() {
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'right';
            
            for (let i = 0; i <= 10; i++) {
                const price = priceMin + (priceRange * (1 - i / 10));
                const y = (chartHeight - 30) * (i / 10) + 15;
                
                ctx.fillText(formatPrice(price), chartWidth - 5, y + 3);
            }
        }

        // Draw time axis with correct time formatting
        function drawTimeAxis() {
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            
            const startIdx = Math.max(0, chartData.length - visibleCandles - scrollOffset);
            const endIdx = Math.min(chartData.length, startIdx + visibleCandles);
            const step = Math.ceil(visibleCandles / 10);
            
            for (let i = startIdx; i < endIdx; i += step) {
                const candle = chartData[i];
                if (!candle) continue;
                
                const x = (i - startIdx) * (candleWidth + candleSpacing) + candleWidth / 2;
                const time = new Date(candle.time);
                
                let timeStr;
                // Format time based on timeframe
                if (currentTimeframe === 'M1' || currentTimeframe === 'M5' || currentTimeframe === 'M15' || currentTimeframe === 'M30') {
                    // For minute timeframes, show time
                    timeStr = time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                } else if (currentTimeframe === 'H1' || currentTimeframe === 'H4') {
                    // For hour timeframes, show date and time
                    const month = time.toLocaleDateString('en-US', { month: 'short' });
                    const day = time.getDate();
                    const hour = time.toLocaleTimeString('en-US', { hour: '2-digit', hour12: false });
                    timeStr = `${month} ${day} ${hour}:00`;
                } else if (currentTimeframe === 'D1') {
                    // For daily timeframe, show date
                    timeStr = time.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                } else if (currentTimeframe === 'W1') {
                    // For weekly timeframe, show week start date
                    timeStr = time.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                } else if (currentTimeframe === 'MN') {
                    // For monthly timeframe, show month and year
                    timeStr = time.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                }
                
                ctx.fillText(timeStr, x, chartHeight - 10);
            }
        }

        // Convert price to Y coordinate
        function priceToY(price) {
            return ((priceMax - price) / priceRange) * (chartHeight - 45) + 15;
        }

        // Convert Y coordinate to price
        function yToPrice(y) {
            return priceMax - ((y - 15) / (chartHeight - 45)) * priceRange;
        }

        // Handle Y axis resize (vertical zoom)
        function handleYAxisMouseDown(event) {
            isResizingYAxis = true;
            yAxisStartY = event.clientY;
            priceRangeStart = priceRange;
            event.preventDefault();
        }

        // Handle X axis resize (horizontal zoom)
        function handleXAxisMouseDown(event) {
            isResizingXAxis = true;
            xAxisStartX = event.clientX;
            candleWidthStart = candleWidth;
            event.preventDefault();
        }

        // Handle axis mouse move
        function handleAxisMouseMove(event) {
            if (isResizingYAxis) {
                const deltaY = event.clientY - yAxisStartY;
                const scaleFactor = 1 + (deltaY / 200);
                
                const newRange = priceRangeStart * scaleFactor;
                const center = (priceMax + priceMin) / 2;
                
                priceRange = Math.max(newRange, 0.00001);
                priceMax = center + priceRange / 2;
                priceMin = center - priceRange / 2;
                
                drawChart();
            }
            
            if (isResizingXAxis) {
                const deltaX = event.clientX - xAxisStartX;
                const scaleFactor = 1 - (deltaX / 200);
                
                const newCandleWidth = candleWidthStart * scaleFactor;
                candleWidth = Math.max(2, Math.min(30, newCandleWidth));
                
                const availableWidth = chartWidth - 60 - chartPadding;
                visibleCandles = Math.floor(availableWidth / (candleWidth + candleSpacing));
                
                calculatePriceRange();
                drawChart();
            }
        }

        // Handle axis mouse up
        function handleAxisMouseUp(event) {
            isResizingYAxis = false;
            isResizingXAxis = false;
        }

        // Handle mouse wheel
        function handleMouseWheel(event) {
            event.preventDefault();
            
            const scrollSpeed = 5;
            
            if (event.ctrlKey || event.metaKey) {
                // Vertical zoom (already implemented)
                const delta = event.deltaY > 0 ? -0.1 : 0.1;
                const center = (priceMax + priceMin) / 2;
                const newRange = priceRange * (1 + delta);
                
                priceMax = center + newRange / 2;
                priceMin = center - newRange / 2;
                priceRange = newRange;
                
                drawChart();
            } else if (event.shiftKey) {
                // Horizontal zoom (already implemented)
                const delta = event.deltaY > 0 ? -1 : 1;
                candleWidth = Math.max(2, Math.min(30, candleWidth + delta));
                const availableWidth = chartWidth - 60 - chartPadding;
                visibleCandles = Math.floor(availableWidth / (candleWidth + candleSpacing));
                calculatePriceRange();
                drawChart();
            } else {
                // Scroll
                const delta = event.deltaY > 0 ? scrollSpeed : -scrollSpeed;
                scrollOffset = Math.max(-50, scrollOffset + delta);
                calculatePriceRange();
                drawChart();
            }
        }

       // Handle mouse move
function handleMouseMove(event) {
    const rect = canvas.getBoundingClientRect();
    mouseX = event.clientX - rect.left;
    mouseY = event.clientY - rect.top;
    
    // --- –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---
    // –ï—Å–ª–∏ –º—ã —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π SL/TP, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–∞–Ω—Ç–æ–º–Ω—É—é –ª–∏–Ω–∏—é
    if (draggingLine === 'entry') {
        drawChart(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
        
        // –†–∏—Å—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ª–∏–Ω–∏—é –æ—Ç —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞ –¥–æ –∫—É—Ä—Å–æ—Ä–∞
        const entryY = priceToY(draggedPosition.openPrice);
        const currentPrice = yToPrice(mouseY);
        const isBuy = draggedPosition.type === 'buy';
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —ç—Ç–æ SL –∏–ª–∏ TP, –∏ –∑–∞–¥–∞–µ–º —Ü–≤–µ—Ç
        let isStopLoss = (isBuy && mouseY > entryY) || (!isBuy && mouseY < entryY);
        ctx.strokeStyle = isStopLoss ? 'rgba(239, 68, 68, 0.7)' : 'rgba(34, 197, 94, 0.7)';
        
        ctx.lineWidth = 2;
        ctx.setLineDash([3, 3]);
        ctx.beginPath();
        ctx.moveTo(0, mouseY);
        ctx.lineTo(chartWidth - 60, mouseY);
        ctx.stroke();
        
        // –†–∏—Å—É–µ–º –ø–ª–∞—à–∫—É —Å —Ü–µ–Ω–æ–π
        const dollarValue = calculateDollarValueFromPriceDiff(draggedPosition.openPrice, currentPrice, draggedPosition.volume, draggedPosition.symbol);
        const labelText = isStopLoss ? `SL -$${dollarValue.toFixed(2)}` : `TP +$${dollarValue.toFixed(2)}`;
        
        ctx.setLineDash([]);
        ctx.fillStyle = isStopLoss ? 'rgba(239, 68, 68, 0.8)' : 'rgba(34, 197, 94, 0.8)';
        ctx.fillRect(chartWidth - 100, mouseY - 10, 90, 20);
        ctx.fillStyle = '#ffffff';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(labelText, chartWidth - 55, mouseY + 3);

        return; // –í—ã—Ö–æ–¥–∏–º, —á—Ç–æ–±—ã –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏
    }
    // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---

    if (draggingLine && (draggingLine === 'sl' || draggingLine === 'tp')) {
        updateDraggedLine(yToPrice(mouseY));
        drawChart();
   } else if (isDragging) {
    if (selectedTool === 'cursor') {
        // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
        const deltaX = event.clientX - dragStartX;
        const candlesDelta = Math.floor(deltaX / (candleWidth + candleSpacing));
        scrollOffset = Math.max(-50, Math.min(maxScroll, dragStartOffset + candlesDelta));
        
        // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
        const deltaY = event.clientY - dragStartY;
        const priceDelta = (deltaY / chartHeight) * priceRange;
        const newCenter = dragStartPriceCenter + priceDelta;
        
        priceMax = newCenter + priceRange / 2;
        priceMin = newCenter - priceRange / 2;
        
        drawChart();
    }

    } else if (isDrawing && currentDrawing) {
        // Update current drawing
        switch (currentDrawing.type) {
            case 'line':
            case 'rectangle':
                currentDrawing.x2 = mouseX;
                currentDrawing.y2 = mouseY;
                break;
        }
        drawChart();
        drawCurrentDrawing();
    } else {
        checkHandleHover();
        checkDrawingHover();
        if (selectedTool === 'crosshair') {
            drawChart();
        }
    }
}

        function drawCurrentDrawing() {
            if (!currentDrawing) return;
            
            ctx.save();
            ctx.strokeStyle = drawingColor;
            ctx.fillStyle = drawingColor;
            ctx.lineWidth = 2;
            
            switch (currentDrawing.type) {
                case 'line':
                    ctx.beginPath();
                    ctx.moveTo(currentDrawing.x1, currentDrawing.y1);
                    ctx.lineTo(currentDrawing.x2, currentDrawing.y2);
                    ctx.stroke();
                    break;
                    
                case 'rectangle':
                    ctx.globalAlpha = 0.2;
                    ctx.fillRect(
                        Math.min(currentDrawing.x1, currentDrawing.x2),
                        Math.min(currentDrawing.y1, currentDrawing.y2),
                        Math.abs(currentDrawing.x2 - currentDrawing.x1),
                        Math.abs(currentDrawing.y2 - currentDrawing.y1)
                    );
                    ctx.globalAlpha = 1;
                    ctx.strokeRect(
                        Math.min(currentDrawing.x1, currentDrawing.x2),
                        Math.min(currentDrawing.y1, currentDrawing.y2),
                        Math.abs(currentDrawing.x2 - currentDrawing.x1),
                        Math.abs(currentDrawing.y2 - currentDrawing.y1)
                    );
                    break;
            }
            
            ctx.restore();
        }

        // Check if hovering over TP/SL handles or potential creation zones
        function checkHandleHover() {
            let cursorChanged = false;
            
            positionsData.filter(pos => pos.symbol === currentSymbol).forEach(pos => {
                const entryY = priceToY(pos.openPrice);
                
                // Check SL handle
                if (pos.sl) {
                    const slY = priceToY(pos.sl);
                    if (mouseX > chartWidth - 100 && mouseX < chartWidth - 60 &&
                        mouseY > slY - 10 && mouseY < slY + 10) {
                        canvas.style.cursor = 'ns-resize';
                        cursorChanged = true;
                    }
                }
                
                // Check TP handle
                if (pos.tp) {
                    const tpY = priceToY(pos.tp);
                    if (mouseX > chartWidth - 100 && mouseX < chartWidth - 60 &&
                        mouseY > tpY - 10 && mouseY < tpY + 10) {
                        canvas.style.cursor = 'ns-resize';
                        cursorChanged = true;
                    }
                }
                
                // Check potential SL/TP creation zones if hovering position
                if (hoveredPosition === pos.id) {
                    if (!pos.sl) {
                        const isBuy = pos.type === 'buy';
                        const potentialSlY = isBuy ? entryY + 50 : entryY - 50;
                        if (mouseX > chartWidth - 100 && mouseX < chartWidth - 60 &&
                            mouseY > potentialSlY - 20 && mouseY < potentialSlY + 20) {
                            canvas.style.cursor = 'grab';
                            cursorChanged = true;
                        }
                    }
                    
                    if (!pos.tp) {
                        const isBuy = pos.type === 'buy';
                        const potentialTpY = isBuy ? entryY - 50 : entryY + 50;
                        if (mouseX > chartWidth - 100 && mouseX < chartWidth - 60 &&
                            mouseY > potentialTpY - 20 && mouseY < potentialTpY + 20) {
                            canvas.style.cursor = 'grab';
                            cursorChanged = true;
                        }
                    }
                }
            });
            
            if (!cursorChanged && !isDragging && !isDrawing) {
                if (selectedTool === 'crosshair' || drawingTool) {
                    canvas.style.cursor = 'crosshair';
                } else {
                    canvas.style.cursor = 'default';
                }
            }
        }

        // Handle mouse down
function handleMouseDown(event) {
    const rect = canvas.getBoundingClientRect();
    mouseX = event.clientX - rect.left;
    mouseY = event.clientY - rect.top;
    
   if (event.detail === 2) { // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫
        for (let order of pendingOrders) {
            if (order.symbol !== currentSymbol) continue;
            
            const orderY = priceToY(order.price);
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ –æ–±–ª–∞—Å—Ç—å –æ—Ä–¥–µ—Ä–∞
            if (mouseY > orderY - 15 && mouseY < orderY + 15 && mouseX < 400) {
                if (confirm(`Cancel ${order.type.replace('_', ' ')} order #${order.ticket}?`)) {
                    ws.send(JSON.stringify({
                        type: 'cancelOrder',
                        ticket: order.ticket
                    }));
                }
                event.preventDefault();
                return;
            }
        }
    }
    if (pendingOrderMode) {
        const clickedPrice = yToPrice(mouseY);
        
        if (pendingOrderStep === 'price') {
            placePendingOrderOnChart(clickedPrice);
        } else if (pendingOrderStep === 'sl') {
            setPendingOrderSL(clickedPrice);
        } else if (pendingOrderStep === 'tp') {
            setPendingOrderTP(clickedPrice);
        }
        
        event.preventDefault();
        return;
    }
    
    // Handle drawing tools
    if (drawingTool) {
        isDrawing = true;
        switch (drawingTool) {
            case 'line':
            case 'rectangle':
                currentDrawing = { type: drawingTool, x1: mouseX, y1: mouseY, x2: mouseX, y2: mouseY, color: drawingColor };
                break;
            case 'horizontal':
    drawings.push({ 
        type: 'horizontal', 
        price: yToPrice(mouseY),  // –ò–∑–º–µ–Ω–∏–ª–∏ y –Ω–∞ price
        color: drawingColor,
        id: Date.now()  // –î–æ–±–∞–≤–∏–ª–∏ ID –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
    });
    drawChart();
    break;
            case 'text':
                const textOverlay = document.getElementById('textInputOverlay');
                const textField = document.getElementById('textInputField');
                textOverlay.style.left = mouseX + 'px';
                textOverlay.style.top = mouseY + 'px';
                textOverlay.classList.add('active');
                textField.value = '';
                textField.focus();
                textField.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        drawings.push({ type: 'text', text: textField.value, x: mouseX, y: mouseY, color: drawingColor });
                        textOverlay.classList.remove('active');
                        drawChart();
                    } else if (e.key === 'Escape') {
                        textOverlay.classList.remove('active');
                    }
                };
                break;
        }
        return;
    }
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    
    let handleClicked = false;
    
    // Check if clicking on existing TP/SL handles
    positionsData.filter(pos => pos.symbol === currentSymbol).forEach(pos => {
        if (handleClicked) return;
        
        if (pos.sl) {
            const slY = priceToY(pos.sl);
            if (mouseX > chartWidth - 100 && mouseX < chartWidth - 10 && mouseY > slY - 10 && mouseY < slY + 10) {
                draggingLine = 'sl';
                draggedPosition = pos;
                handleClicked = true;
            }
        }
        
        if (pos.tp) {
            const tpY = priceToY(pos.tp);
            if (mouseX > chartWidth - 100 && mouseX < chartWidth - 10 && mouseY > tpY - 10 && mouseY < tpY + 10) {
                draggingLine = 'tp';
                draggedPosition = pos;
                handleClicked = true;
            }
        }
    });

    // --- –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---
    // Check if clicking on an entry line to CREATE a new SL/TP
    if (!handleClicked) {
        positionsData.filter(pos => pos.symbol === currentSymbol).forEach(pos => {
            if (handleClicked) return;

            const entryY = priceToY(pos.openPrice);
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫—É—Ä—Å–æ—Ä –æ—á–µ–Ω—å –±–ª–∏–∑–∫–æ –∫ –ª–∏–Ω–∏–∏ –≤—Ö–æ–¥–∞ (–ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏)
            if (mouseY > entryY - 5 && mouseY < entryY + 5) {
                // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π —Ç–∏–ø –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è SL/TP
                draggingLine = 'entry'; 
                draggedPosition = pos;
                handleClicked = true;
                canvas.style.cursor = 'ns-resize'; // –ú–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä –Ω–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
            }
        });
    }
    // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---

    if (!handleClicked && selectedTool === 'cursor') {
    isDragging = true;
    if (isDragging) {
    const chartMain = document.querySelector('.chart-main');
    if (chartMain) chartMain.classList.add('dragging');
}
    dragStartX = event.clientX;
    dragStartY = event.clientY;  // –î–û–ë–ê–í–ò–¢–¨
    dragStartOffset = scrollOffset;
    dragStartPriceCenter = (priceMax + priceMin) / 2;  // –î–û–ë–ê–í–ò–¢–¨
    canvas.style.cursor = 'grabbing';
}
}

    // Handle mouse up
function handleMouseUp(event) {
    if (isDrawing && currentDrawing) {
        if (currentDrawing.type === 'line' || currentDrawing.type === 'rectangle') {
            drawings.push(currentDrawing);
            currentDrawing = null;
        }
        isDrawing = false;
        drawChart();
        const chartMain = document.querySelector('.chart-main');
if (chartMain) chartMain.classList.remove('dragging');
    }
    
    // --- –ù–ê–ß–ê–õ–û –û–ë–ù–û–í–õ–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê ---
    if (draggingLine && draggedPosition) {
        const newPrice = yToPrice(mouseY);
        
        if (ws && ws.readyState === WebSocket.OPEN) {
            let modification = { type: 'modify', positionId: draggedPosition.id };
            
            if (draggingLine === 'entry') {
                // –õ–æ–≥–∏–∫–∞ –¥–ª—è –°–û–ó–î–ê–ù–ò–Ø –Ω–æ–≤–æ–≥–æ SL/TP
                const entryPrice = draggedPosition.openPrice;
                const isBuy = draggedPosition.type === 'buy';

                if ((isBuy && newPrice < entryPrice) || (!isBuy && newPrice > entryPrice)) {
                    // –≠—Ç–æ Stop Loss
                    modification.sl_price = newPrice;
                } else {
                    // –≠—Ç–æ Take Profit
                    modification.tp_price = newPrice;
                }

            } else if (draggingLine === 'sl') {
                // –õ–æ–≥–∏–∫–∞ –¥–ª—è –ò–ó–ú–ï–ù–ï–ù–ò–Ø —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ SL
                modification.sl_price = newPrice;
            } else if (draggingLine === 'tp') {
                // –õ–æ–≥–∏–∫–∞ –¥–ª—è –ò–ó–ú–ï–ù–ï–ù–ò–Ø —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ TP
                modification.tp_price = newPrice;
            }
            
            ws.send(JSON.stringify(modification));
        }
        
        draggingLine = null;
        draggedPosition = null;
    }
    // --- –ö–û–ù–ï–¶ –û–ë–ù–û–í–õ–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê ---
    
    isDragging = false;
    isDrawing = false;
    canvas.style.cursor = selectedTool === 'crosshair' ? 'crosshair' : 'default';
}

        // Handle mouse leave
function handleMouseLeave(event) {
    isDragging = false;
    isDrawing = false;
    currentDrawing = null;
    
    // --- –î–û–ë–ê–í–õ–ï–ù–ù–´–ô –ö–û–î ---
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –ª–∏–Ω–∏–π, –µ—Å–ª–∏ –º—ã—à—å —É—à–ª–∞ —Å —Ö–æ–ª—Å—Ç–∞
    draggingLine = null;
    draggedPosition = null;
    // --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ù–û–ì–û –ö–û–î–ê ---

    canvas.style.cursor = 'default';
}

        // Update dragged line preview
        function updateDraggedLine(newPrice) {
            if (draggedPosition && draggingLine) {
                // Calculate dollar value for display
                const pips = Math.abs(draggedPosition.openPrice - newPrice) / 0.0001;
                const dollarValue = calculateDollarFromPips(pips, draggedPosition.volume);
                
                // Show preview in real-time (this will be drawn in drawPositions)
                if (draggingLine === 'sl' || draggingLine === 'sl-create') {
                    draggedPosition.sl = newPrice;
                } else if (draggingLine === 'tp' || draggingLine === 'tp-create') {
                    draggedPosition.tp = newPrice;
                }
            }
        }

        // Draw crosshair
        function drawCrosshair() {
            if (mouseX < 0 || mouseX > chartWidth - 60 || mouseY < 15 || mouseY > chartHeight - 30) {
                return;
            }
            
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            
            // Horizontal line
            ctx.beginPath();
            ctx.moveTo(0, mouseY);
            ctx.lineTo(chartWidth - 60, mouseY);
            ctx.stroke();
            
            // Vertical line
            ctx.beginPath();
            ctx.moveTo(mouseX, 15);
            ctx.lineTo(mouseX, chartHeight - 30);
            ctx.stroke();
            
            ctx.setLineDash([]);
            
            // Price label
            const price = yToPrice(mouseY);
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-secondary');
            ctx.fillRect(chartWidth - 60, mouseY - 10, 60, 20);
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(formatPrice(price), chartWidth - 5, mouseY + 3);
        }

        // Set lot size
        function setLot(value) {
            document.getElementById('lotSize').value = value;
                SettingsManager.set('terminal.defaultVolume', value);

        }
// –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –æ—Ä–¥–µ—Ä–∞
function selectOrderType(type) {
    orderType = type;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    document.getElementById('marketOrderBtn').classList.toggle('active', type === 'market');
    document.getElementById('limitOrderBtn').classList.toggle('active', type === 'limit');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è –ª–∏–º–∏—Ç–Ω–æ–π —Ü–µ–Ω—ã
    const limitPriceGroup = document.getElementById('limitPriceGroup');
    limitPriceGroup.style.display = type === 'limit' ? 'block' : 'none';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö
    const buyButton = document.getElementById('buyButton');
    const sellButton = document.getElementById('sellButton');
    
    if (type === 'limit') {
        document.getElementById('buyButtonText').textContent = 'BUY LIMIT';
        document.getElementById('sellButtonText').textContent = 'SELL LIMIT';
        buyButton.classList.add('limit-order');
        sellButton.classList.add('limit-order');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ª–∏–º–∏—Ç–Ω—É—é —Ü–µ–Ω—É
        setInitialLimitPrice();
    } else {
        document.getElementById('buyButtonText').textContent = 'BUY';
        document.getElementById('sellButtonText').textContent = 'SELL';
        buyButton.classList.remove('limit-order');
        sellButton.classList.remove('limit-order');
    }
}
// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π –ª–∏–º–∏—Ç–Ω–æ–π —Ü–µ–Ω—ã
function setInitialLimitPrice() {
    const limitPriceInput = document.getElementById('limitPrice');
    if (currentBid > 0) {
        limitPriceInput.value = formatPrice(currentBid);
        updateLimitPriceDistance();
    }
}
// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–∏–º–∏—Ç–Ω–æ–π —Ü–µ–Ω—ã –æ—Ç —Ç–µ–∫—É—â–µ–π
function setLimitPriceFromCurrent(priceType) {
    const limitPriceInput = document.getElementById('limitPrice');
    if (priceType === 'bid' && currentBid > 0) {
        limitPriceInput.value = formatPrice(currentBid);
    } else if (priceType === 'ask' && currentAsk > 0) {
        limitPriceInput.value = formatPrice(currentAsk);
    }
    updateLimitPriceDistance();
}
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –æ—Ç —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
function updateLimitPriceDistance() {
    const limitPrice = parseFloat(document.getElementById('limitPrice').value);
    if (!limitPrice || !currentBid) return;
    
    const distance = Math.abs(limitPrice - currentBid);
    const pips = calculatePipsFromPrice(distance);
    
    const distanceElement = document.getElementById('limitPriceDistance');
    if (limitPrice > currentBid) {
        distanceElement.textContent = `+${pips.toFixed(1)} pips above`;
        distanceElement.style.color = 'var(--success)';
    } else if (limitPrice < currentBid) {
        distanceElement.textContent = `${pips.toFixed(1)} pips below`;
        distanceElement.style.color = 'var(--danger)';
    } else {
        distanceElement.textContent = 'At current price';
        distanceElement.style.color = 'var(--text-secondary)';
    }
}
// –†–∞—Å—á–µ—Ç –ø–∏–ø—Å–æ–≤ –∏–∑ —Ä–∞–∑–Ω–∏—Ü—ã —Ü–µ–Ω
function calculatePipsFromPrice(priceDiff) {
    if (currentSymbol.includes('JPY')) {
        return priceDiff / 0.001; // –î–ª—è JPY –ø–∞—Ä
    } else if (currentSymbol.includes('BTC') || currentSymbol.includes('XAU')) {
        return priceDiff; // –î–ª—è –∫—Ä–∏–ø—Ç—ã –∏ –∑–æ–ª–æ—Ç–∞ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö
    } else {
        return priceDiff / 0.00001; // –î–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –≤–∞–ª—é—Ç–Ω—ã—Ö –ø–∞—Ä (5 –∑–Ω–∞–∫–æ–≤)
    }
}
        function changeTheme(themeName) {
    if (!themes[themeName]) return;
    
    const theme = themes[themeName];
    const root = document.documentElement;
    
    // Apply theme colors
    for (const [key, value] of Object.entries(theme)) {
        root.style.setProperty(key, value);
    }
    
    // Update active theme button
    document.querySelectorAll('.theme-option').forEach(btn => {
        btn.classList.remove('active');
        btn.style.border = '2px solid var(--border)';
    });
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ event
    if (typeof event !== 'undefined' && event && event.target) {
        event.target.classList.add('active');
        event.target.style.border = '2px solid var(--accent-primary)';
    } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç event, –∏—â–µ–º –∫–Ω–æ–ø–∫—É –ø–æ —Ç–µ–∫—Å—Ç—É
        document.querySelectorAll('.theme-option').forEach(btn => {
            if (btn.textContent.toLowerCase() === themeName.toLowerCase()) {
                btn.classList.add('active');
                btn.style.border = '2px solid var(--accent-primary)';
            }
        });
    }
    
    // Save preference
    currentTheme = themeName;
    localStorage.setItem('currentTheme', themeName);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ SettingsManager
    if (typeof SettingsManager !== 'undefined') {
        SettingsManager.set('chart.theme', themeName);
    }
    
    // Apply theme class for candle colors
    document.body.className = 'theme-' + themeName;
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–º—É –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º
    for (const type of Object.keys(activeIndicators)) {
        const indicator = activeIndicators[type];
        if (indicator.iframe && indicator.iframe.contentWindow) {
            indicator.iframe.contentWindow.postMessage({
                type: 'themeChange',
                theme: themeName
            }, '*');
        }
    }
    
    // Redraw chart with new colors
    drawChart();
    
    showNotification(`Theme changed to ${themeName}`, 'success');
}

        function updateChartSettings() {
            drawChart();
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                dot.classList.remove('disconnected');
                dot.classList.add('connected');
                text.textContent = 'Connected';
            } else {
                dot.classList.remove('connected');
                dot.classList.add('disconnected');
                text.textContent = 'Disconnected';
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Update server time
        function updateServerTime() {
            const now = new Date();
            document.getElementById('serverTime').textContent = now.toTimeString().split(' ')[0];
        }
// –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã –ª–∏–º–∏—Ç–∞
document.addEventListener('DOMContentLoaded', () => {
    const limitPriceInput = document.getElementById('limitPrice');
    if (limitPriceInput) {
        limitPriceInput.addEventListener('input', updateLimitPriceDistance);
    }
});

 // Initialize on load
window.addEventListener('load', () => {
    // ========== –ó–ê–ì–†–£–ó–ö–ê –°–û–•–†–ê–ù–ï–ù–ù–´–• –ù–ê–°–¢–†–û–ï–ö ==========
    if (typeof SettingsManager !== 'undefined') {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª
        const savedSymbol = SettingsManager.get('terminal.lastSymbol');
        if (savedSymbol) {
            document.getElementById('symbolSelect').value = savedSymbol;
            currentSymbol = savedSymbol;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ–±—ä–µ–º
        const savedVolume = SettingsManager.get('terminal.defaultVolume');
        if (savedVolume) {
            document.getElementById('lotSize').value = savedVolume;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ä—Ç–∞
        const showGrid = SettingsManager.get('chart.showGrid');
        if (showGrid !== null) {
            document.getElementById('showGrid').checked = showGrid;
        }
        
        const showPriceLine = SettingsManager.get('chart.showPriceLine');
        if (showPriceLine !== null) {
            document.getElementById('showPriceLine').checked = showPriceLine;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–º—É –∏–∑ SettingsManager
        const savedTheme = SettingsManager.get('chart.theme') || 'cyberpunk';
        if (savedTheme && themes[savedTheme]) {
            const theme = themes[savedTheme];
            const root = document.documentElement;
            for (const [key, value] of Object.entries(theme)) {
                root.style.setProperty(key, value);
            }
            currentTheme = savedTheme;
            document.body.className = 'theme-' + savedTheme;
            
            // Set active theme button
            document.querySelectorAll('.theme-option').forEach(btn => {
                if (btn.textContent.toLowerCase() === savedTheme) {
                    btn.classList.add('active');
                    btn.style.border = '2px solid var(--accent-primary)';
                }
            });
        }
    }
    // ========== –ö–û–ù–ï–¶ –ó–ê–ì–†–£–ó–ö–ò –ù–ê–°–¢–†–û–ï–ö ==========
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–Ω–≤–∞—Å–∞
    canvas = document.getElementById('tradingChart');
    ctx = canvas.getContext('2d');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
    const container = canvas.parentElement;
    if (container) {
        canvas.width = container.offsetWidth;
        canvas.height = container.offsetHeight;
        chartWidth = canvas.width;
        chartHeight = canvas.height;
        
        const availableWidth = chartWidth - 60 - chartPadding;
        visibleCandles = Math.floor(availableWidth / (candleWidth + candleSpacing));
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ —Å –¥–µ–±–∞—É–Ω—Å–æ–º
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            const container = canvas.parentElement;
            if (container) {
                const newWidth = container.offsetWidth;
                const newHeight = container.offsetHeight;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è —Ä–∞–∑–º–µ—Ä
                if (canvas.width !== newWidth || canvas.height !== newHeight) {
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    chartWidth = canvas.width;
                    chartHeight = canvas.height;
                    
                    const availableWidth = chartWidth - 60 - chartPadding;
                    visibleCandles = Math.floor(availableWidth / (candleWidth + candleSpacing));
                    
                    if (chartData && chartData.length > 0) {
                        calculatePriceRange();
                        drawChart();
                    }
                }
            }
        }, 150); // –ó–∞–¥–µ—Ä–∂–∫–∞ 150–º—Å –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    });
    
    // Initialize chart event listeners
    initChart();
    
    // Load demo data initially
    chartData = generateDemoCandles();
    calculatePriceRange();
    drawChart();
    
    // Initialize WebSocket
    initWebSocket();
    
    // Start server time update
    setInterval(updateServerTime, 1000);
    
    // Start animation for price line
    setInterval(() => {
        if (document.getElementById('showPriceLine').checked) {
            drawChart();
        }
    }, 1000);
    
    // Initialize panel resize functionality
    if (typeof initPanelResize === 'function') {
        initPanelResize();
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à Delete –∏ ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Delete' && hoveredDrawing !== null) {
            drawings.splice(hoveredDrawing, 1);
            hoveredDrawing = null;
            drawChart();
            return;
        }
        
        if (e.key === 'Escape') {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞
            const historyModal = document.getElementById('historyModal');
            if (historyModal && historyModal.style.display === 'block') {
                closeHistory();
                return;
            }
            
            if (pendingOrderMode || pendingOrderPreview) {
                cancelPendingOrderMode();
                showNotification('Order placement cancelled', 'info');
            }
        }
    });
    
    updatePendingOrders([]);
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏ (–í–´–ù–ï–°–ï–ù–´ –ó–ê –ü–†–ï–î–ï–õ–´ window.addEventListener)
function openHistory() {
    const modal = document.getElementById('historyModal');
    const iframe = document.getElementById('historyFrame');
    
    if (!iframe.src) {
        iframe.src = window.location.origin + '/history';
    }
    
    modal.style.display = 'block';
}

function closeHistory() {
    const modal = document.getElementById('historyModal');
    modal.style.display = 'none';
}
// BPFX Settings - –∂–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    if (document.getElementById('bpfxSensitivity')) {
        document.getElementById('bpfxSensitivity').addEventListener('input', function(e) {
            document.getElementById('bpfxSensitivityValue').textContent = e.target.value;
        });
    }
    
    if (document.getElementById('bpfxChannelWidth')) {
        document.getElementById('bpfxChannelWidth').addEventListener('input', function(e) {
            document.getElementById('bpfxChannelWidthValue').textContent = e.target.value;
        });
    }
    
    if (document.getElementById('bpfxLookback')) {
        document.getElementById('bpfxLookback').addEventListener('input', function(e) {
            document.getElementById('bpfxLookbackValue').textContent = e.target.value;
        });
    }
    
    if (document.getElementById('bpfxSLPoints')) {
        document.getElementById('bpfxSLPoints').addEventListener('input', function(e) {
            document.getElementById('bpfxSLPointsValue').textContent = e.target.value;
        });
    }
    
    if (document.getElementById('bpfxTP1')) {
        document.getElementById('bpfxTP1').addEventListener('input', function(e) {
            document.getElementById('bpfxTP1Value').textContent = parseFloat(e.target.value).toFixed(1);
        });
    }
    
    if (document.getElementById('bpfxTP2')) {
        document.getElementById('bpfxTP2').addEventListener('input', function(e) {
            document.getElementById('bpfxTP2Value').textContent = parseFloat(e.target.value).toFixed(1);
        });
    }
    
    if (document.getElementById('bpfxTP3')) {
        document.getElementById('bpfxTP3').addEventListener('input', function(e) {
            document.getElementById('bpfxTP3Value').textContent = parseFloat(e.target.value).toFixed(1);
        });
    }
});

// –§—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–Ω–µ DOMContentLoaded
// BPFX Settings - Real-time update
document.addEventListener('DOMContentLoaded', function() {
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò
    function sendBPFXSettingsToIndicator() {
        const settings = {
            sensitivity: parseInt(document.getElementById('bpfxSensitivity').value),
            channelWidth: parseFloat(document.getElementById('bpfxChannelWidth').value),
            lookback: parseInt(document.getElementById('bpfxLookback').value),
            glowEffect: document.getElementById('bpfxGlowEffect').checked,
            showSignals: document.getElementById('bpfxShowSignals').checked,
            channelFill: document.getElementById('bpfxChannelFill').checked,
            showTPSL: document.getElementById('bpfxShowTPSL').checked,
            slPoints: parseInt(document.getElementById('bpfxSLPoints').value),
            tp1Ratio: parseFloat(document.getElementById('bpfxTP1').value),
            tp2Ratio: parseFloat(document.getElementById('bpfxTP2').value),
            tp3Ratio: parseFloat(document.getElementById('bpfxTP3').value)
        };
        
        const indicatorFrame = document.getElementById('indicator-bpfx');
        if (indicatorFrame && indicatorFrame.contentWindow) {
            indicatorFrame.contentWindow.postMessage({
                type: 'updateSettings',
                settings: settings
            }, '*');
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å –†–ï–ê–õ–¨–ù–´–ú –í–†–ï–ú–ï–ù–ï–ú
    if (document.getElementById('bpfxSensitivity')) {
        document.getElementById('bpfxSensitivity').addEventListener('input', function(e) {
            document.getElementById('bpfxSensitivityValue').textContent = e.target.value;
            sendBPFXSettingsToIndicator(); // <-- –î–û–ë–ê–í–õ–ï–ù–û
        });
    }
    
    if (document.getElementById('bpfxChannelWidth')) {
        document.getElementById('bpfxChannelWidth').addEventListener('input', function(e) {
            document.getElementById('bpfxChannelWidthValue').textContent = e.target.value;
            sendBPFXSettingsToIndicator(); // <-- –î–û–ë–ê–í–õ–ï–ù–û
        });
    }
    
    if (document.getElementById('bpfxLookback')) {
        document.getElementById('bpfxLookback').addEventListener('input', function(e) {
            document.getElementById('bpfxLookbackValue').textContent = e.target.value;
            sendBPFXSettingsToIndicator(); // <-- –î–û–ë–ê–í–õ–ï–ù–û
        });
    }
    
    if (document.getElementById('bpfxSLPoints')) {
        document.getElementById('bpfxSLPoints').addEventListener('input', function(e) {
            document.getElementById('bpfxSLPointsValue').textContent = e.target.value;
            sendBPFXSettingsToIndicator(); // <-- –î–û–ë–ê–í–õ–ï–ù–û
        });
    }
    
    if (document.getElementById('bpfxTP1')) {
        document.getElementById('bpfxTP1').addEventListener('input', function(e) {
            document.getElementById('bpfxTP1Value').textContent = parseFloat(e.target.value).toFixed(1);
            sendBPFXSettingsToIndicator(); // <-- –î–û–ë–ê–í–õ–ï–ù–û
        });
    }
    
    if (document.getElementById('bpfxTP2')) {
        document.getElementById('bpfxTP2').addEventListener('input', function(e) {
            document.getElementById('bpfxTP2Value').textContent = parseFloat(e.target.value).toFixed(1);
            sendBPFXSettingsToIndicator(); // <-- –î–û–ë–ê–í–õ–ï–ù–û
        });
    }
    
    if (document.getElementById('bpfxTP3')) {
        document.getElementById('bpfxTP3').addEventListener('input', function(e) {
            document.getElementById('bpfxTP3Value').textContent = parseFloat(e.target.value).toFixed(1);
            sendBPFXSettingsToIndicator(); // <-- –î–û–ë–ê–í–õ–ï–ù–û
        });
    }
    
    // –ß–µ–∫–±–æ–∫—Å—ã —Ç–æ–∂–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    const checkboxes = ['bpfxGlowEffect', 'bpfxShowSignals', 'bpfxChannelFill', 'bpfxShowTPSL'];
    checkboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
            checkbox.addEventListener('change', function() {
                sendBPFXSettingsToIndicator(); // <-- –î–û–ë–ê–í–õ–ï–ù–û
            });
        }
    });
});

function resetBPFXSettings() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
    document.getElementById('bpfxSensitivity').value = 50;
    document.getElementById('bpfxSensitivityValue').textContent = 50;
    document.getElementById('bpfxChannelWidth').value = 2.5;
    document.getElementById('bpfxChannelWidthValue').textContent = 2.5;
    document.getElementById('bpfxLookback').value = 100;
    document.getElementById('bpfxLookbackValue').textContent = 100;
    document.getElementById('bpfxSLPoints').value = 20;
    document.getElementById('bpfxSLPointsValue').textContent = 20;
    document.getElementById('bpfxTP1').value = 1;
    document.getElementById('bpfxTP1Value').textContent = '1.0';
    document.getElementById('bpfxTP2').value = 2;
    document.getElementById('bpfxTP2Value').textContent = '2.0';
    document.getElementById('bpfxTP3').value = 3;
    document.getElementById('bpfxTP3Value').textContent = '3.0';
    document.getElementById('bpfxGlowEffect').checked = true;
    document.getElementById('bpfxShowSignals').checked = true;
    document.getElementById('bpfxChannelFill').checked = true;
    document.getElementById('bpfxShowTPSL').checked = true;
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–±—Ä–æ—à–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –°–†–ê–ó–£
    const settings = {
        sensitivity: 50,
        channelWidth: 2.5,
        lookback: 100,
        glowEffect: true,
        showSignals: true,
        channelFill: true,
        showTPSL: true,
        slPoints: 20,
        tp1Ratio: 1,
        tp2Ratio: 2,
        tp3Ratio: 3
    };
    
    const indicatorFrame = document.getElementById('indicator-bpfx');
    if (indicatorFrame && indicatorFrame.contentWindow) {
        indicatorFrame.contentWindow.postMessage({
            type: 'updateSettings',
            settings: settings
        }, '*');
    }
}
function applyBPFXSettings() {
    const settings = {
        sensitivity: parseInt(document.getElementById('bpfxSensitivity').value),
        channelWidth: parseFloat(document.getElementById('bpfxChannelWidth').value),
        lookback: parseInt(document.getElementById('bpfxLookback').value),
        glowEffect: document.getElementById('bpfxGlowEffect').checked,
        showSignals: document.getElementById('bpfxShowSignals').checked,
        channelFill: document.getElementById('bpfxChannelFill').checked,
        showTPSL: document.getElementById('bpfxShowTPSL').checked,
        slPoints: parseInt(document.getElementById('bpfxSLPoints').value),
        tp1Ratio: parseFloat(document.getElementById('bpfxTP1').value),
        tp2Ratio: parseFloat(document.getElementById('bpfxTP2').value),
        tp3Ratio: parseFloat(document.getElementById('bpfxTP3').value)
    };
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    localStorage.setItem('bpfxSettings', JSON.stringify(settings));
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
    document.getElementById('bpfxSettingsModal').style.display = 'none';
    showNotification('BPFX settings saved', 'success');
}
// –ü–û–õ–ù–´–ô –∫–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤ - –∑–∞–º–µ–Ω–∏ –∏–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–¥

function setupAutoTranslations() {
    if (typeof t !== 'function') {
        console.log('Translation function not ready, retrying...');
        setTimeout(setupAutoTranslations, 500);
        return;
    }

    const textToKeyMap = {
        // Trading panel
        'Trading': 'trading.title',
        'Settings': 'trading.settings',
        'Risk Management Mode': 'risk.title',
        'Risk %': 'risk.riskPercent', 
        'Reward Ratio': 'risk.rewardRatio',
        'Risk Amount:': 'risk.riskAmount',
        'Potential Profit:': 'risk.potentialProfit',
        'Calculated Volume:': 'risk.calculatedVolume',
        'Volume (Lots)': 'trading.volume',
        'Stop Loss': 'trading.stopLoss',
        'Take Profit': 'trading.takeProfit',
        'Order Type': 'trading.orderType',
        'Market Order': 'trading.marketOrder',
        'Limit Order': 'trading.limitOrder',
        'Limit Price': 'trading.limitPrice',
        'BUY': 'trading.buy',
        'SELL': 'trading.sell',
        'BUY LIMIT': 'trading.buyLimit',
        'SELL LIMIT': 'trading.sellLimit',
        'Automation Settings': 'automation.title',
        'Trailing Stop': 'automation.trailing',
        'Auto Breakeven': 'automation.breakeven',
        'Activation ($)': 'automation.activation',
        'Distance ($)': 'automation.distance',
        
        // Positions tabs
        'Open Positions': 'positions.title',
        'Pending Orders': 'positions.pending',
        'Limit Orders': 'positions.pending', // –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
        'No open positions': 'positions.noOpen',
        'No pending orders': 'positions.noPending',
        
        // Table headers
        'Symbol': 'positions.symbol',
        'Type': 'positions.type',
        'Volume': 'positions.volume',
        'Open Price': 'positions.openPrice',
        'Current Price': 'positions.currentPrice',
        'Price': 'positions.openPrice',
        'S/L ($)': 'trading.stopLoss',
        'T/P ($)': 'trading.takeProfit',
        'Profit': 'positions.profit',
        'Profit ($)': 'positions.profit',
        'Trailing': 'automation.trailing',
        'Breakeven': 'automation.breakeven',
        'Actions': 'positions.actions',
        'Ticket': 'positions.ticket',
        'Distance': 'positions.distance',
        'Time': 'positions.time',
        
        // Action buttons
        'Close': 'positions.close',
        'Close All': 'positions.closeAll',
        'Close Profitable': 'positions.closeProfitable',
        'Close Losing': 'positions.closeLosing',
        'Settings': 'positions.settings',
        'Close 50%': 'positions.closeHalf',
        'Modify': 'positions.modify',
        'Cancel': 'positions.cancel',
        'Cancel All': 'positions.cancelAll',
        'Total': 'positions.total',
        
        // Chart Settings - –î–û–ë–ê–í–õ–ï–ù–û
        'Chart Settings': 'chart.settings',
        'Grid Lines': 'chart.gridLines',
        'Price Line': 'chart.priceLine',
        'Theme': 'chart.theme',
        
        // Status
        'Connected': 'status.connected',
        'Disconnected': 'status.disconnected',
        'Spread': 'status.spread',
        'Server Time': 'status.serverTime',
        
        // Chart info
        'Open:': 'chart.open',
        'High:': 'chart.high', 
        'Low:': 'chart.low',
        'Close:': 'chart.close',
        
        // Themes
        'Cyberpunk': 'theme.cyberpunk',
        'Matrix': 'theme.matrix',
        'Dark': 'theme.dark',
        'Light': 'theme.light',
        'Ocean': 'theme.ocean',
        'Sunset': 'theme.sunset',
        'Neon': 'theme.neon',
        'Royal': 'theme.royal',
        
        // Header
        'Balance': 'header.balance',
        'Equity': 'header.equity',
        'Margin': 'header.margin',
        'Free Margin': 'header.freeMargin',
        'Margin Level': 'header.marginLevel',
        'History': 'header.history',
        'DEMO': 'header.demo',
        
        // History page - –î–û–ë–ê–í–õ–ï–ù–û –ë–û–õ–¨–®–ï
        'BluePrint History': 'history.title',
        'Trading History & Analytics': 'history.title',
        'Trade History Filter': 'history.filter',
        'From:': 'history.from',
        'To:': 'history.to',
        'Load History': 'history.loadHistory',
        'Today': 'history.today',
        'Yesterday': 'history.yesterday',
        'This Week': 'history.thisWeek',
        'This Month': 'history.thisMonth',
        'Last 3 Months': 'history.last3Months',
        'This Year': 'history.thisYear',
        'All Time': 'history.allTime',
        'Total Trades': 'history.totalTrades',
        'Win Rate': 'history.winRate',
        'Net Profit': 'history.netProfit',
        'Average Win': 'history.averageWin',
        'Average Loss': 'history.averageLoss',
        'Profit Factor': 'history.profitFactor',
        'Best Trade': 'history.bestTrade',
        'Worst Trade': 'history.worstTrade',
        'Cumulative Profit': 'history.cumulativeProfit',
        'Trade Distribution': 'history.tradeDistribution',
        'Profitable Trades': 'history.profitableTrades',
        'Losing Trades': 'history.losingTrades',
        'Breakeven': 'history.breakeven',
        'Closed by TP': 'history.closedByTP',
        'Closed by SL': 'history.closedBySL',
        'Trade Details': 'history.tradeDetails',
        'Date/Time': 'history.dateTime',
        'Entry Price': 'history.entryPrice',
        'Exit Price': 'history.exitPrice',
        'Exit Type': 'history.exitType',
        'Commission': 'history.commission',
        'Swap': 'history.swap',
        'Net P/L': 'history.netPL',
        'Duration': 'history.duration',
        'Export CSV': 'history.exportCSV',
        'Refresh': 'history.refresh',
        'Back to Terminal': 'history.backToTerminal',
        'Search trades...': 'history.searchTrades',
        'No trades found': 'history.noTradesFound',
        'No data to display': 'history.noDataToDisplay'
    };
    
    function addTranslationAttributes() {
        try {
            document.querySelectorAll('*').forEach(element => {
                if (element.hasAttribute('data-i18n')) return;
                
                const text = element.textContent?.trim();
                if (text && textToKeyMap[text] && element.children.length === 0) {
                    element.setAttribute('data-i18n', textToKeyMap[text]);
                }
                
                const placeholder = element.placeholder?.trim();
                if (placeholder && textToKeyMap[placeholder]) {
                    element.setAttribute('data-i18n-placeholder', textToKeyMap[placeholder]);
                }
            });
            
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–∞–±—ã –ø–æ–∑–∏—Ü–∏–π
            document.querySelectorAll('.positions-panel-tab').forEach(tab => {
                const text = tab.textContent.replace(/\d+/g, '').trim(); // —É–±–∏—Ä–∞–µ–º —Ü–∏—Ñ—Ä—ã —Å—á–µ—Ç—á–∏–∫–æ–≤
                if (textToKeyMap[text]) {
                    tab.setAttribute('data-i18n', textToKeyMap[text]);
                }
            });
            
        } catch (error) {
            console.log('Translation setup error:', error);
        }
    }
    
    addTranslationAttributes();
    
    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏
    if (typeof window.closeAllPositions === 'function') {
        const originalCloseAll = window.closeAllPositions;
        window.closeAllPositions = function() {
            if (!confirm(t('confirm.closeAll'))) return;
            return originalCloseAll.call(this);
        };
    }
    
    if (typeof window.closeAllProfitable === 'function') {
        const originalCloseProfitable = window.closeAllProfitable;
        window.closeAllProfitable = function() {
            if (!confirm(t('confirm.closeProfitable'))) return;
            return originalCloseProfitable.call(this);
        };
    }
    
    if (typeof window.closeAllLosing === 'function') {
        const originalCloseLosing = window.closeAllLosing;
        window.closeAllLosing = function() {
            if (!confirm(t('confirm.closeLosing'))) return;
            return originalCloseLosing.call(this);
        };
    }
    
    console.log('Complete auto translations setup completed');
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
function updatePositionsTranslations() {
    setTimeout(() => {
        // –ü–µ—Ä–µ–≤–æ–¥–∏–º —Ç–∞–±—ã –ø–æ–∑–∏—Ü–∏–π
        document.querySelectorAll('.positions-panel-tab').forEach(tab => {
            const text = tab.textContent;
            if (text.includes('Open Positions')) {
                const badge = tab.querySelector('.pending-orders-badge');
                const count = badge ? badge.textContent : '';
                tab.innerHTML = `${t('positions.title')}${badge ? ' <span class="pending-orders-badge">' + count + '</span>' : ''}`;
            } else if (text.includes('Pending Orders') || text.includes('Limit Orders')) {
                const badge = tab.querySelector('.pending-orders-badge');
                const count = badge ? badge.textContent : '';
                tab.innerHTML = `${t('positions.pending')}${badge ? ' <span class="pending-orders-badge">' + count + '</span>' : ''}`;
            }
        });
        
        // –ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        document.querySelectorAll('.action-btn, .control-btn').forEach(btn => {
            const text = btn.textContent.trim();
            const key = {
                'Close': 'positions.close',
                'Settings': 'positions.settings',
                'Close 50%': 'positions.closeHalf',
                'Close All': 'positions.closeAll',
                'Close Profitable': 'positions.closeProfitable',
                'Close Losing': 'positions.closeLosing',
                'Cancel All': 'positions.cancelAll',
                'Modify': 'positions.modify',
                'Cancel': 'positions.cancel'
            }[text];
            
            if (key) {
                btn.textContent = t(key);
            }
        });
        
    }, 200);
}

// –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
setTimeout(() => {
    setupAutoTranslations();
    updatePositionsTranslations();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–π
    const originalUpdatePositions = window.updatePositions;
    if (originalUpdatePositions) {
        window.updatePositions = function(data) {
            const result = originalUpdatePositions.call(this, data);
            updatePositionsTranslations();
            return result;
        };
    }
    
}, 2000);
// –ê–í–¢–û–°–û–•–†–ê–ù–ï–ù–ò–ï –í–°–ï–ì–û
setInterval(() => {
    if (typeof SettingsManager === 'undefined') return;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    SettingsManager.set('terminal.lastSymbol', currentSymbol);
    SettingsManager.set('terminal.lastTimeframe', currentTimeframe);
    SettingsManager.set('terminal.defaultVolume', document.getElementById('lotSize').value);
    SettingsManager.set('chart.theme', currentTheme);
    SettingsManager.set('chart.showGrid', document.getElementById('showGrid').checked);
    SettingsManager.set('chart.showPriceLine', document.getElementById('showPriceLine').checked);
    
    // Quick Trade
    const qtw = document.getElementById('quickTradeWidget');
    if (qtw) {
        SettingsManager.set('windows.quickTrade.visible', qtw.style.display !== 'none');
        SettingsManager.set('windows.quickTrade.settings.volume', document.getElementById('qtwVolume')?.value);
        SettingsManager.set('windows.quickTrade.settings.sl', document.getElementById('qtwStopLoss')?.value);
        SettingsManager.set('windows.quickTrade.settings.tp', document.getElementById('qtwTakeProfit')?.value);
        SettingsManager.set('windows.quickTrade.settings.trailing', document.getElementById('qtwTrailing')?.checked);
        SettingsManager.set('windows.quickTrade.settings.breakeven', document.getElementById('qtwBreakeven')?.checked);
    }
    
    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏ –ï–ì–û –ù–ê–°–¢–†–û–ô–ö–ò
    SettingsManager.set('indicators.bpfx', Object.keys(activeIndicators).includes('bpfx'));
    
    // –ù–ê–°–¢–†–û–ô–ö–ò BPFX
    if (document.getElementById('bpfxSensitivity')) {
        SettingsManager.set('bpfx.sensitivity', document.getElementById('bpfxSensitivity').value);
        SettingsManager.set('bpfx.channelWidth', document.getElementById('bpfxChannelWidth').value);
        SettingsManager.set('bpfx.lookback', document.getElementById('bpfxLookback').value);
        SettingsManager.set('bpfx.glowEffect', document.getElementById('bpfxGlowEffect').checked);
        SettingsManager.set('bpfx.showSignals', document.getElementById('bpfxShowSignals').checked);
        SettingsManager.set('bpfx.channelFill', document.getElementById('bpfxChannelFill').checked);
        SettingsManager.set('bpfx.showTPSL', document.getElementById('bpfxShowTPSL').checked);
        SettingsManager.set('bpfx.slPoints', document.getElementById('bpfxSLPoints').value);
        SettingsManager.set('bpfx.tp1Ratio', document.getElementById('bpfxTP1').value);
        SettingsManager.set('bpfx.tp2Ratio', document.getElementById('bpfxTP2').value);
        SettingsManager.set('bpfx.tp3Ratio', document.getElementById('bpfxTP3').value);
    }
    
    // SL/TP units
    SettingsManager.set('terminal.slUnit', slUnit);
    SettingsManager.set('terminal.tpUnit', tpUnit);
    
    // Order type
    SettingsManager.set('terminal.lastOrderType', orderType);
    
}, 5000);

// –ê–í–¢–û–ó–ê–ì–†–£–ó–ö–ê –í–°–ï–ì–û –ü–†–ò –°–¢–ê–†–¢–ï
setTimeout(() => {
    // –¢–∞–π–º—Ñ—Ä–µ–π–º
    const savedTF = SettingsManager.get('terminal.lastTimeframe');
    if (savedTF) {
        currentTimeframe = savedTF;
        document.querySelectorAll('.tf-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent === savedTF);
        });
    }
    
    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä
    if (SettingsManager.get('indicators.bpfx')) {
        addIndicator('bpfx');
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ BPFX
    const bpfxSettings = SettingsManager.get('bpfx');
    if (bpfxSettings && document.getElementById('bpfxSensitivity')) {
        document.getElementById('bpfxSensitivity').value = bpfxSettings.sensitivity || 50;
        document.getElementById('bpfxSensitivityValue').textContent = bpfxSettings.sensitivity || 50;
        document.getElementById('bpfxChannelWidth').value = bpfxSettings.channelWidth || 2.5;
        document.getElementById('bpfxChannelWidthValue').textContent = bpfxSettings.channelWidth || 2.5;
        document.getElementById('bpfxLookback').value = bpfxSettings.lookback || 100;
        document.getElementById('bpfxLookbackValue').textContent = bpfxSettings.lookback || 100;
        document.getElementById('bpfxSLPoints').value = bpfxSettings.slPoints || 20;
        document.getElementById('bpfxSLPointsValue').textContent = bpfxSettings.slPoints || 20;
        document.getElementById('bpfxTP1').value = bpfxSettings.tp1Ratio || 1;
        document.getElementById('bpfxTP1Value').textContent = (bpfxSettings.tp1Ratio || 1).toFixed(1);
        document.getElementById('bpfxTP2').value = bpfxSettings.tp2Ratio || 2;
        document.getElementById('bpfxTP2Value').textContent = (bpfxSettings.tp2Ratio || 2).toFixed(1);
        document.getElementById('bpfxTP3').value = bpfxSettings.tp3Ratio || 3;
        document.getElementById('bpfxTP3Value').textContent = (bpfxSettings.tp3Ratio || 3).toFixed(1);
        document.getElementById('bpfxGlowEffect').checked = bpfxSettings.glowEffect !== false;
        document.getElementById('bpfxShowSignals').checked = bpfxSettings.showSignals !== false;
        document.getElementById('bpfxChannelFill').checked = bpfxSettings.channelFill !== false;
        document.getElementById('bpfxShowTPSL').checked = bpfxSettings.showTPSL !== false;
    }
    
    // SL/TP units
    slUnit = SettingsManager.get('terminal.slUnit') || 'pips';
    tpUnit = SettingsManager.get('terminal.tpUnit') || 'pips';
    
    // Order type
    orderType = SettingsManager.get('terminal.lastOrderType') || 'market';
    
}, 3000);
</script>
<!-- Quick Trade Widget -->
<div class="quick-trade-widget" id="quickTradeWidget" style="display: none;">
    <div class="qtw-header">
        <div class="qtw-title">‚ö° QUICK TRADE</div>
        <div class="qtw-controls">
            <button class="qtw-minimize" onclick="minimizeQuickTrade()">‚îÄ</button>
            <button class="qtw-close" onclick="closeQuickTrade()">‚úï</button>
        </div>
    </div>
    
    <div class="qtw-body">
        <div class="qtw-price-ticker">
            <span class="qtw-symbol" id="qtwSymbol">EUR/USD</span>
            <span class="qtw-price" id="qtwPrice">-</span>
            <span class="qtw-change" id="qtwChange">-</span>
        </div>
        
        <div class="qtw-volume-section">
    <div class="qtw-volume-label">VOLUME (LOTS)</div>
    <div class="qtw-input-row">
        <input type="number" id="qtwVolume" class="qtw-volume-input" value="0.01" min="0.01" max="100" step="0.01">
    </div>
    <div class="qtw-quick-lots">
        <button class="qtw-lot-btn" onclick="setQtwLot(0.01)">0.01</button>
        <button class="qtw-lot-btn" onclick="setQtwLot(0.05)">0.05</button>
        <button class="qtw-lot-btn" onclick="setQtwLot(0.10)">0.10</button>
        <button class="qtw-lot-btn" onclick="setQtwLot(0.50)">0.50</button>
        <button class="qtw-lot-btn" onclick="setQtwLot(1.00)">1.00</button>
    </div>
</div>
        
        <div class="qtw-input-row">
            <div class="qtw-input-group">
                <label>STOP LOSS ($)</label>
                <input type="number" id="qtwStopLoss" value="10" min="0" step="1">
            </div>
            <div class="qtw-input-group">
                <label>TAKE PROFIT ($)</label>
                <input type="number" id="qtwTakeProfit" value="30" min="0" step="1">
            </div>
        </div>
        
        <div class="qtw-trade-buttons">
            <button class="qtw-btn qtw-btn-buy" onclick="quickTradeBuy()">
                BUY
                <span class="qtw-btn-price" id="qtwBuyPrice">-</span>
            </button>
            <button class="qtw-btn qtw-btn-sell" onclick="quickTradeSell()">
                SELL
                <span class="qtw-btn-price" id="qtwSellPrice">-</span>
            </button>
        </div>
        
        <button class="qtw-expand-toggle" onclick="toggleQuickTradeAdvanced()">
            <span>ADVANCED</span>
            <span class="qtw-expand-icon" id="qtwExpandIcon">‚ñº</span>
        </button>
        
        <div class="qtw-advanced" id="qtwAdvanced">
            <div class="qtw-automation-group">
                <div class="qtw-automation-header">
                    <label class="qtw-checkbox-label">
                        <input type="checkbox" id="qtwTrailing" onchange="toggleQtwTrailing()">
                        <span>Trailing Stop</span>
                    </label>
                </div>
                <div class="qtw-automation-inputs" id="qtwTrailingInputs" style="display: none;">
                    <div class="qtw-mini-input">
                        <label>Activation ($)</label>
                        <input type="number" id="qtwTrailingProfit" value="10" min="1" step="1">
                    </div>
                    <div class="qtw-mini-input">
                        <label>Distance ($)</label>
                        <input type="number" id="qtwTrailingDistance" value="5" min="1" step="1">
                    </div>
                </div>
            </div>
            
            <div class="qtw-automation-group">
                <div class="qtw-automation-header">
                    <label class="qtw-checkbox-label">
                        <input type="checkbox" id="qtwBreakeven" onchange="toggleQtwBreakeven()">
                        <span>Auto Breakeven</span>
                    </label>
                </div>
                <div class="qtw-automation-inputs" id="qtwBreakevenInputs" style="display: none;">
                    <div class="qtw-mini-input">
                        <label>Activation ($)</label>
                        <input type="number" id="qtwBreakevenProfit" value="5" min="1" step="1">
                    </div>
                </div>
            </div>
            
            <div class="qtw-order-type">
                <label>Order Type</label>
                <div class="qtw-radio-group">
                    <label class="qtw-radio">
                        <input type="radio" name="qtwOrderType" value="market" checked onchange="toggleQtwOrderType()">
                        <span>Market</span>
                    </label>
                    <label class="qtw-radio">
                        <input type="radio" name="qtwOrderType" value="limit" onchange="toggleQtwOrderType()">
                        <span>Limit</span>
                    </label>
                </div>
            </div>
            
            <div class="qtw-limit-price" id="qtwLimitPriceGroup" style="display: none;">
                <label>Limit Price</label>
                <input type="number" id="qtwLimitPrice" step="0.00001">
                <div class="qtw-limit-info">
                    <span id="qtwLimitDistance">-</span> pips from current
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* –ö—É—Ä—Å–æ—Ä—ã –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
button, .btn-buy, .btn-sell, .tool-btn, .tf-btn, .panel-tab, 
.control-btn, .action-btn, .quick-btn, .qtw-btn, .tc-tab,
.theme-option, .positions-panel-tab, select, input[type="checkbox"] {
    cursor: pointer !important;
    transition: all 0.3s;
}

/* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫—É—Ä—Å–æ—Ä –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã */
.theme-cyberpunk button:hover,
.theme-cyberpunk .tool-btn:hover {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><circle cx="12" cy="12" r="10" fill="none" stroke="%2300ffff" stroke-width="2"/><circle cx="12" cy="12" r="3" fill="%23ff00ff"/></svg>') 12 12, pointer;
}

.theme-matrix button:hover {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><rect x="4" y="4" width="16" height="16" fill="none" stroke="%2300ff00" stroke-width="2"/><circle cx="12" cy="12" r="2" fill="%2300ff00"/></svg>') 12 12, pointer;
}

.theme-neon button:hover {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><polygon points="12,2 14,8 20,9 15,13 17,20 12,16 7,20 9,13 4,9 10,8" fill="%23ff00ff" opacity="0.8"/></svg>') 12 12, pointer;
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è –∏–Ω–ø—É—Ç–æ–≤ */
input[type="text"], input[type="number"], textarea, select {
    cursor: text;
}

input[type="text"]:hover, input[type="number"]:hover {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><line x1="10" y1="3" x2="10" y2="17" stroke="%2300ffff" stroke-width="2"/></svg>') 10 10, text;
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è —Ä–µ—Å–∞–π–∑–∞ */
.panel-resizer, .axis-resize-handle {
    cursor: ns-resize !important;
}

.axis-resize-handle.x-axis {
    cursor: ew-resize !important;
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è */
.dialog-close, .qtw-close, .tc-close-btn {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><line x1="5" y1="5" x2="15" y2="15" stroke="%23ff0000" stroke-width="3"/><line x1="15" y1="5" x2="5" y2="15" stroke="%23ff0000" stroke-width="3"/></svg>') 10 10, pointer !important;
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
.qtw-header, .tc-header, .dialog-header {
    cursor: move !important;
}

.qtw-header:active, .tc-header:active {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M12,2 L12,22 M2,12 L22,12" stroke="%2300ffff" stroke-width="2"/><circle cx="12" cy="12" r="3" fill="%23ff00ff"/></svg>') 12 12, grabbing !important;
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è disabled —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
button:disabled, input:disabled, select:disabled {
    cursor: not-allowed !important;
    opacity: 0.5;
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è —Å—Å—ã–ª–æ–∫ */
a, .link {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path d="M10,3 L17,10 L10,17 L10,13 L3,13 L3,7 L10,7 Z" fill="%2300ffff"/></svg>') 10 10, pointer;
}
/* Quick Trade Widget Styles */
.quick-trade-widget {
    position: fixed;
    top: 100px;
    right: 370px;
    width: 280px;
    background: var(--bg-panel);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.5),
        0 0 60px rgba(0, 255, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    z-index: 1500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.qtw-header {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(0, 255, 255, 0.05));
    padding: 10px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
    cursor: move;
    border-radius: 12px 12px 0 0;
}

.qtw-title {
    font-size: 11px;
    font-weight: 600;
    color: var(--accent-primary);
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
}

.qtw-controls {
    display: flex;
    gap: 5px;
}

.qtw-minimize, .qtw-close {
    width: 22px;
    height: 22px;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 12px;
}

.qtw-minimize:hover, .qtw-close:hover {
    background: rgba(139, 92, 246, 0.2);
    border-color: var(--accent-primary);
    color: var(--accent-primary);
}

.qtw-body {
    padding: 15px;
}

.qtw-price-ticker {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    background: var(--bg-secondary);
    border-radius: 6px;
    margin-bottom: 12px;
    border: 1px solid var(--border);
}

.qtw-symbol {
    font-size: 12px;
    font-weight: 600;
    color: var(--accent-primary);
}

.qtw-price {
    font-size: 13px;
    font-weight: bold;
    color: var(--text-primary);
}

.qtw-change {
    font-size: 11px;
    color: var(--success);
}

.qtw-change.negative {
    color: var(--danger);
}

.qtw-input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
}

.qtw-input-group {
    flex: 1;
    position: relative;
}

.qtw-input-group label {
    position: absolute;
    top: -8px;
    left: 10px;
    background: var(--bg-panel);
    padding: 0 5px;
    font-size: 9px;
    color: var(--accent-tertiary);
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
}

.qtw-input-group input,
.qtw-select {
    width: 100%;
    padding: 8px 10px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    color: var(--text-primary);
    border-radius: 6px;
    font-size: 13px;
    transition: all 0.2s;
}

.qtw-input-group input:focus,
.qtw-select:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
}

.qtw-trade-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin: 15px 0;
}

.qtw-btn {
    padding: 10px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}

.qtw-btn-price {
    font-size: 10px;
    font-weight: normal;
    opacity: 0.9;
}

.qtw-btn-buy {
    background: linear-gradient(135deg, var(--success), #16a34a);
    color: white;
    box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
}

.qtw-btn-buy:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(34, 197, 94, 0.5);
}

.qtw-btn-sell {
    background: linear-gradient(135deg, var(--danger), #dc2626);
    color: white;
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
}

.qtw-btn-sell:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(239, 68, 68, 0.5);
}

.qtw-expand-toggle {
    width: 100%;
    padding: 8px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--accent-tertiary);
    font-size: 11px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    transition: all 0.2s;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
}

.qtw-expand-toggle:hover {
    background: rgba(139, 92, 246, 0.1);
    border-color: var(--accent-tertiary);
}

.qtw-expand-icon {
    transition: transform 0.3s;
}

.qtw-expanded .qtw-expand-icon {
    transform: rotate(180deg);
}

.qtw-advanced {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
    margin-top: 12px;
    padding-top: 0;
    border-top: 1px solid var(--border);
}

.qtw-expanded .qtw-advanced {
    max-height: 400px;
    padding-top: 12px;
}

.qtw-automation-group {
    margin-bottom: 12px;
    padding: 10px;
    background: var(--bg-secondary);
    border-radius: 6px;
    border: 1px solid var(--border);
}

.qtw-automation-header {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.qtw-checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
}

.qtw-checkbox-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
}

.qtw-automation-inputs {
    display: flex;
    gap: 10px;
    margin-top: 8px;
}

.qtw-mini-input {
    flex: 1;
}

.qtw-mini-input label {
    display: block;
    font-size: 9px;
    color: var(--accent-primary);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.qtw-mini-input input {
    width: 100%;
    padding: 6px 8px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    color: var(--text-primary);
    border-radius: 4px;
    font-size: 12px;
}

.qtw-order-type {
    margin-top: 12px;
}

.qtw-order-type > label {
    display: block;
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.qtw-radio-group {
    display: flex;
    gap: 15px;
}

.qtw-radio {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    font-size: 12px;
    color: var(--text-secondary);
}

.qtw-radio input[type="radio"] {
    cursor: pointer;
}

.qtw-limit-price {
    margin-top: 10px;
    padding: 10px;
    background: var(--bg-secondary);
    border-radius: 6px;
    border: 1px solid var(--border);
}

.qtw-limit-price label {
    display: block;
    font-size: 10px;
    color: var(--accent-primary);
    margin-bottom: 6px;
    text-transform: uppercase;
}

.qtw-limit-price input {
    width: 100%;
    padding: 6px 8px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    color: var(--text-primary);
    border-radius: 4px;
    font-size: 12px;
    margin-bottom: 6px;
}

.qtw-limit-info {
    font-size: 10px;
    color: var(--text-secondary);
}

.quick-trade-widget.minimized {
    height: auto;
}

.quick-trade-widget.minimized .qtw-body {
    display: none;
}
.qtw-quick-lots {
    display: flex;
    gap: 5px;
    margin-top: 8px;
}

.qtw-lot-btn {
    flex: 1;
    padding: 5px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    transition: all 0.2s;
}

.qtw-lot-btn:hover {
    background: var(--accent-tertiary);
    color: white;
    transform: translateY(-1px);
}
.qtw-volume-section {
    margin-bottom: 12px;
}

.qtw-volume-label {
    font-size: 9px;
    color: var(--accent-tertiary);
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 6px;
    text-align: center;
}

.qtw-volume-input {
    width: 100%;
    padding: 8px 10px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    color: var(--text-primary);
    border-radius: 6px;
    font-size: 13px;
    text-align: center;
    transition: all 0.2s;
}

.qtw-volume-input:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
}

</style>

<script>
// ================ QUICK TRADE WIDGET FUNCTIONS ================

// Initialize Quick Trade Widget
function initQuickTradeWidget() {
    // Make widget draggable
    makeQuickTradeDraggable();
    
    // Update prices in widget
    setInterval(updateQuickTradePrices, 500);
    
    // Set current symbol
    const symbolEl = document.getElementById('qtwSymbol');
    if (symbolEl) {
        symbolEl.textContent = currentSymbol;
    }
    
    // Load saved position
    const savedPosition = localStorage.getItem('qtwPosition');
    if (savedPosition) {
        const pos = JSON.parse(savedPosition);
        const widget = document.getElementById('quickTradeWidget');
        if (widget) {
            widget.style.left = pos.x + 'px';
            widget.style.top = pos.y + 'px';
        }
    }
    
    // Add event listener for limit price
    const limitPriceInput = document.getElementById('qtwLimitPrice');
    if (limitPriceInput) {
        limitPriceInput.addEventListener('input', updateQtwLimitDistance);
    }
}

// Show/Hide Quick Trade Widget
function showQuickTrade() {
    const widget = document.getElementById('quickTradeWidget');
    if (widget) {
        widget.style.display = 'block';
        updateQuickTradePrices();
    }
}

function closeQuickTrade() {
    const widget = document.getElementById('quickTradeWidget');
    if (widget) {
        widget.style.display = 'none';
            SettingsManager.set('windows.quickTrade.visible', false);

    }
}

function minimizeQuickTrade() {
    const widget = document.getElementById('quickTradeWidget');
    if (widget) {
        widget.classList.toggle('minimized');
    }
}

// Toggle Advanced Section
function toggleQuickTradeAdvanced() {
    const widget = document.getElementById('quickTradeWidget');
    widget.classList.toggle('qtw-expanded');
    
    const icon = document.getElementById('qtwExpandIcon');
    icon.textContent = widget.classList.contains('qtw-expanded') ? '‚ñ≤' : '‚ñº';
}

// Toggle Trailing Settings
function toggleQtwTrailing() {
    const isChecked = document.getElementById('qtwTrailing').checked;
    const inputs = document.getElementById('qtwTrailingInputs');
    inputs.style.display = isChecked ? 'flex' : 'none';
}

// Toggle Breakeven Settings  
function toggleQtwBreakeven() {
    const isChecked = document.getElementById('qtwBreakeven').checked;
    const inputs = document.getElementById('qtwBreakevenInputs');
    inputs.style.display = isChecked ? 'flex' : 'none';
}

// Toggle Order Type
function toggleQtwOrderType() {
    const orderType = document.querySelector('input[name="qtwOrderType"]:checked').value;
    const limitGroup = document.getElementById('qtwLimitPriceGroup');
    
    if (orderType === 'limit') {
        limitGroup.style.display = 'block';
        // Set initial limit price
        if (currentBid > 0) {
            document.getElementById('qtwLimitPrice').value = formatPrice(currentBid);
            updateQtwLimitDistance();
        }
    } else {
        limitGroup.style.display = 'none';
    }
}

// Update Limit Price Distance
function updateQtwLimitDistance() {
    const limitPrice = parseFloat(document.getElementById('qtwLimitPrice').value);
    if (!limitPrice || !currentBid) return;
    
    const distance = Math.abs(limitPrice - currentBid);
    const pips = calculatePipsFromPrice(distance);
    
    const distanceElement = document.getElementById('qtwLimitDistance');
    if (limitPrice > currentBid) {
        distanceElement.textContent = `+${pips.toFixed(1)}`;
        distanceElement.style.color = 'var(--success)';
    } else if (limitPrice < currentBid) {
        distanceElement.textContent = `-${pips.toFixed(1)}`;
        distanceElement.style.color = 'var(--danger)';
    } else {
        distanceElement.textContent = '0';
        distanceElement.style.color = 'var(--text-secondary)';
    }
}

// Update prices in widget
function updateQuickTradePrices() {
    if (document.getElementById('quickTradeWidget').style.display === 'none') return;
    
    // Update symbol
    document.getElementById('qtwSymbol').textContent = currentSymbol;
    
    // Update current price
    if (currentBid > 0) {
        document.getElementById('qtwPrice').textContent = formatPrice(currentBid);
        document.getElementById('qtwBuyPrice').textContent = formatPrice(currentAsk);
        document.getElementById('qtwSellPrice').textContent = formatPrice(currentBid);
    }
    
    // Update price change
    const changeEl = document.getElementById('qtwChange');
    const priceChangeEl = document.getElementById('priceChange');
    if (priceChangeEl) {
        changeEl.textContent = priceChangeEl.textContent;
        changeEl.className = priceChangeEl.className.includes('price-up') ? 'qtw-change' : 'qtw-change negative';
    }
}

// Execute Buy Trade from Widget
function quickTradeBuy() {
    executeQuickTrade('buy');
}

// Execute Sell Trade from Widget
function quickTradeSell() {
    executeQuickTrade('sell');
}

// Main trade execution function
function executeQuickTrade(type) {
    if (!isConnected) {
        showNotification('Not connected to server', 'error');
        return;
    }
    
    const volume = parseFloat(document.getElementById('qtwVolume').value);
    const slValue = parseFloat(document.getElementById('qtwStopLoss').value) || null;
    const tpValue = parseFloat(document.getElementById('qtwTakeProfit').value) || null;
    const orderType = document.querySelector('input[name="qtwOrderType"]:checked').value;
    
    const order = {
        type: 'order',
        symbol: getBrokerSymbol(currentSymbol),
        volume: volume,
        action: type,
        sl: slValue,
        tp: tpValue,
        sl_unit: 'dollar',  // Quick Trade –≤—Å–µ–≥–¥–∞ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö!
        tp_unit: 'dollar'
    };
    
    // –¢—Ä–µ–π–ª–∏–Ω–≥ –∏ –±–µ–∑—É–±—ã—Ç–æ–∫ - –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô, –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
    if (document.getElementById('qtwTrailing').checked) {
        order.trailing = true;
        order.trailing_profit = parseFloat(document.getElementById('qtwTrailingProfit').value) || 10;
        order.trailing_distance = parseFloat(document.getElementById('qtwTrailingDistance').value) || 5;
    }
    
    if (document.getElementById('qtwBreakeven').checked) {
        order.breakeven = true;
        order.breakeven_profit = parseFloat(document.getElementById('qtwBreakevenProfit').value) || 5;
    }
    
    // Limit orders
    if (orderType === 'limit') {
        const limitPrice = parseFloat(document.getElementById('qtwLimitPrice').value);
        
        if (!limitPrice) {
            showNotification('Please enter limit price', 'error');
            return;
        }
        
        if (type === 'buy' && limitPrice >= currentAsk) {
            showNotification('Buy Limit price must be below current Ask price', 'error');
            return;
        }
        if (type === 'sell' && limitPrice <= currentBid) {
            showNotification('Sell Limit price must be above current Bid price', 'error');
            return;
        }
        
        order.order_type = type === 'buy' ? 'buy_limit' : 'sell_limit';
        order.price = limitPrice;
    } else {
        order.order_type = 'market';
    }
    
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(order));
        showNotification(`${type.toUpperCase()} order sent`, 'info');
        console.log('Quick Trade Order sent:', order);
    }
}
// Set lot size in Quick Trade
function setQtwLot(value) {
    document.getElementById('qtwVolume').value = value.toFixed(2);
}

// Make widget draggable
function makeQuickTradeDraggable() {
    const widget = document.getElementById('quickTradeWidget');
    const header = widget.querySelector('.qtw-header');
    
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let initialX = 0;
    let initialY = 0;
    
    header.addEventListener('mousedown', startDragging);
    
    function startDragging(e) {
        if (e.target.classList.contains('qtw-minimize') || e.target.classList.contains('qtw-close')) {
            return;
        }
        
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        
        const rect = widget.getBoundingClientRect();
        initialX = rect.left;
        initialY = rect.top;
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDragging);
        
        widget.style.transition = 'none';
        e.preventDefault();
    }
    
    function drag(e) {
        if (!isDragging) return;
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        let newX = initialX + deltaX;
        let newY = initialY + deltaY;
        
        // Keep widget within viewport
        newX = Math.max(0, Math.min(window.innerWidth - widget.offsetWidth, newX));
        newY = Math.max(0, Math.min(window.innerHeight - widget.offsetHeight, newY));
        
        widget.style.left = newX + 'px';
        widget.style.top = newY + 'px';
        widget.style.right = 'auto';
    }
    
    function stopDragging() {
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', stopDragging);
        
        widget.style.transition = '';
        
        // Save position
        const rect = widget.getBoundingClientRect();
        localStorage.setItem('qtwPosition', JSON.stringify({
            x: rect.left,
            y: rect.top
        }));
    }
}

// Initialize on page load
window.addEventListener('DOMContentLoaded', function() {
    initQuickTradeWidget();
});
</script>
<!-- Theme Customizer Modal -->
<div class="theme-customizer" id="themeCustomizer" style="display: none;">
    <div class="tc-header">
        <div class="tc-title">
            <span class="tc-title-icon">üé®</span>
            <span>THEME STUDIO</span>
            <span class="tc-title-badge">PRO</span>
        </div>
        <div class="tc-header-controls">
            <button class="tc-preset-btn" onclick="openPresetMenu()">Presets</button>
            <button class="tc-save-btn" onclick="saveCustomTheme()">Save Theme</button>
            <button class="tc-close-btn" onclick="closeThemeCustomizer()">‚úï</button>
        </div>
    </div>
    
    <div class="tc-body">
        <!-- Live Preview -->
        <div class="tc-preview">
            <div class="tc-preview-header">LIVE PREVIEW</div>
            <div class="tc-preview-content">
                <div class="tc-preview-chart">
                    <canvas id="tcPreviewCanvas"></canvas>
                </div>
                <div class="tc-preview-ui">
                    <div class="tc-preview-panel">
                        <div class="tc-preview-price">1.08452</div>
                        <button class="tc-preview-buy">BUY</button>
                        <button class="tc-preview-sell">SELL</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Color Controls -->
        <div class="tc-controls">
            <div class="tc-tabs">
                <button class="tc-tab active" onclick="switchCustomizerTab('general')">General</button>
                <button class="tc-tab" onclick="switchCustomizerTab('chart')">Chart</button>
                <button class="tc-tab" onclick="switchCustomizerTab('buttons')">Buttons</button>
                <button class="tc-tab" onclick="switchCustomizerTab('effects')">Effects</button>
            </div>
            
            <!-- General Tab -->
            <div class="tc-tab-content active" id="tc-general">
                <div class="tc-section">
                    <div class="tc-section-title">BACKGROUNDS</div>
                    
                    <div class="tc-color-control">
                        <label>Primary Background</label>
                        <div class="tc-color-input-group">
                            <input type="color" id="tc-bg-primary" onchange="updateThemeColor('--bg-primary', this.value)">
                            <input type="text" class="tc-hex-input" id="tc-bg-primary-hex" onchange="updateThemeColorHex('--bg-primary', this.value)">
                            <div class="tc-color-preview" id="preview-bg-primary"></div>
                        </div>
                    </div>
                    
                    <div class="tc-color-control">
                        <label>Secondary Background</label>
                        <div class="tc-color-input-group">
                            <input type="color" id="tc-bg-secondary" onchange="updateThemeColor('--bg-secondary', this.value)">
                            <input type="text" class="tc-hex-input" id="tc-bg-secondary-hex" onchange="updateThemeColorHex('--bg-secondary', this.value)">
                            <div class="tc-color-preview" id="preview-bg-secondary"></div>
                        </div>
                    </div>
                    
                    <div class="tc-color-control">
                        <label>Panel Background</label>
                        <div class="tc-color-input-group">
                            <input type="color" id="tc-bg-panel" onchange="updateThemeColor('--bg-panel', this.value)">
                            <input type="text" class="tc-hex-input" id="tc-bg-panel-hex" onchange="updateThemeColorHex('--bg-panel', this.value)">
                            <div class="tc-color-preview" id="preview-bg-panel"></div>
                        </div>
                    </div>
                </div>
                
                <div class="tc-section">
                    <div class="tc-section-title">ACCENT COLORS</div>
                    
                    <div class="tc-color-control">
                        <label>Primary Accent (Cyan)</label>
                        <div class="tc-color-input-group">
                            <input type="color" id="tc-accent-primary" onchange="updateThemeColor('--accent-primary', this.value)">
                            <input type="text" class="tc-hex-input" id="tc-accent-primary-hex" onchange="updateThemeColorHex('--accent-primary', this.value)">
                            <div class="tc-color-preview" id="preview-accent-primary"></div>
                        </div>
                    </div>
                    
                    <div class="tc-color-control">
                        <label>Secondary Accent (Magenta)</label>
                        <div class="tc-color-input-group">
                            <input type="color" id="tc-accent-secondary" onchange="updateThemeColor('--accent-secondary', this.value)">
                            <input type="text" class="tc-hex-input" id="tc-accent-secondary-hex" onchange="updateThemeColorHex('--accent-secondary', this.value)">
                            <div class="tc-color-preview" id="preview-accent-secondary"></div>
                        </div>
                    </div>
                    
                    <div class="tc-color-control">
                        <label>Tertiary Accent (Purple)</label>
                        <div class="tc-color-input-group">
                            <input type="color" id="tc-accent-tertiary" onchange="updateThemeColor('--accent-tertiary', this.value)">
                            <input type="text" class="tc-hex-input" id="tc-accent-tertiary-hex" onchange="updateThemeColorHex('--accent-tertiary', this.value)">
                            <div class="tc-color-preview" id="preview-accent-tertiary"></div>
                        </div>
                    </div>
                </div>
                
                <div class="tc-section">
                    <div class="tc-section-title">TEXT COLORS</div>
                    
                    <div class="tc-color-control">
                        <label>Primary Text</label>
                        <div class="tc-color-input-group">
                            <input type="color" id="tc-text-primary" onchange="updateThemeColor('--text-primary', this.value)">
                            <input type="text" class="tc-hex-input" id="tc-text-primary-hex" onchange="updateThemeColorHex('--text-primary', this.value)">
                            <div class="tc-color-preview" id="preview-text-primary"></div>
                        </div>
                    </div>
                    
                    <div class="tc-color-control">
                        <label>Secondary Text</label>
                        <div class="tc-color-input-group">
                            <input type="color" id="tc-text-secondary" onchange="updateThemeColor('--text-secondary', this.value)">
                            <input type="text" class="tc-hex-input" id="tc-text-secondary-hex" onchange="updateThemeColorHex('--text-secondary', this.value)">
                            <div class="tc-color-preview" id="preview-text-secondary"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chart Tab -->
            <div class="tc-tab-content" id="tc-chart">
                <div class="tc-section">
                    <div class="tc-section-title">CANDLE COLORS</div>
                    
                    <div class="tc-color-control">
                        <label>Bullish Candles</label>
                        <div class="tc-color-input-group">
                            <input type="color" id="tc-candle-bull" onchange="updateThemeColor('--candle-bull', this.value)">
                            <input type="text" class="tc-hex-input" id="tc-candle-bull-hex" onchange="updateThemeColorHex('--candle-bull', this.value)">
                            <div class="tc-color-preview" id="preview-candle-bull"></div>
                        </div>
                    </div>
                    
                    <div class="tc-color-control">
                        <label>Bearish Candles</label>
                        <div class="tc-color-input-group">
                            <input type="color" id="tc-candle-bear" onchange="updateThemeColor('--candle-bear', this.value)">
                            <input type="text" class="tc-hex-input" id="tc-candle-bear-hex" onchange="updateThemeColorHex('--candle-bear', this.value)">
                            <div class="tc-color-preview" id="preview-candle-bear"></div>
                        </div>
                    </div>
                    
                    <div class="tc-color-control">
                        <label>Candle Wicks</label>
                        <div class="tc-color-input-group">
                            <input type="color" id="tc-candle-wick" onchange="updateThemeColor('--candle-wick', this.value)">
                            <input type="text" class="tc-hex-input" id="tc-candle-wick-hex" onchange="updateThemeColorHex('--candle-wick', this.value)">
                            <div class="tc-color-preview" id="preview-candle-wick"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Buttons Tab -->
            <div class="tc-tab-content" id="tc-buttons">
                <div class="tc-section">
                    <div class="tc-section-title">ACTION BUTTONS</div>
                    
                    <div class="tc-color-control">
                        <label>Success (Buy)</label>
                        <div class="tc-color-input-group">
                            <input type="color" id="tc-success" onchange="updateThemeColor('--success', this.value)">
                            <input type="text" class="tc-hex-input" id="tc-success-hex" onchange="updateThemeColorHex('--success', this.value)">
                            <div class="tc-color-preview" id="preview-success"></div>
                        </div>
                    </div>
                    
                    <div class="tc-color-control">
                        <label>Danger (Sell)</label>
                        <div class="tc-color-input-group">
                            <input type="color" id="tc-danger" onchange="updateThemeColor('--danger', this.value)">
                            <input type="text" class="tc-hex-input" id="tc-danger-hex" onchange="updateThemeColorHex('--danger', this.value)">
                            <div class="tc-color-preview" id="preview-danger"></div>
                        </div>
                    </div>
                    
                    <div class="tc-color-control">
                        <label>Warning</label>
                        <div class="tc-color-input-group">
                            <input type="color" id="tc-warning" onchange="updateThemeColor('--warning', this.value)">
                            <input type="text" class="tc-hex-input" id="tc-warning-hex" onchange="updateThemeColorHex('--warning', this.value)">
                            <div class="tc-color-preview" id="preview-warning"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Effects Tab -->
            <div class="tc-tab-content" id="tc-effects">
                <div class="tc-section">
                    <div class="tc-section-title">VISUAL EFFECTS</div>
                    
                    <div class="tc-slider-control">
                        <label>Glow Intensity</label>
                        <input type="range" min="0" max="100" value="50" id="tc-glow-intensity" oninput="updateGlowIntensity(this.value)">
                        <span id="tc-glow-value">50%</span>
                    </div>
                    
                    <div class="tc-slider-control">
                        <label>Blur Amount</label>
                        <input type="range" min="0" max="30" value="10" id="tc-blur-amount" oninput="updateBlurAmount(this.value)">
                        <span id="tc-blur-value">10px</span>
                    </div>
                    
                    <div class="tc-slider-control">
                        <label>Border Opacity</label>
                        <input type="range" min="0" max="100" value="30" id="tc-border-opacity" oninput="updateBorderOpacity(this.value)">
                        <span id="tc-border-value">30%</span>
                    </div>
                    
                    <div class="tc-toggle-control">
                        <label>Neon Mode</label>
                        <input type="checkbox" id="tc-neon-mode" onchange="toggleNeonMode(this.checked)">
                    </div>
                    
                    <div class="tc-toggle-control">
                        <label>Glass Effect</label>
                        <input type="checkbox" id="tc-glass-effect" onchange="toggleGlassEffect(this.checked)">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="tc-footer">
        <button class="tc-reset-btn" onclick="resetToDefault()">Reset to Default</button>
        <button class="tc-export-btn" onclick="exportTheme()">Export Theme</button>
        <button class="tc-import-btn" onclick="importTheme()">Import Theme</button>
    </div>
</div>

<!-- Preset Menu -->
<div class="tc-preset-menu" id="tcPresetMenu" style="display: none;">
    <div class="tc-preset-header">
        <span>Choose Preset</span>
        <button onclick="closePresetMenu()">‚úï</button>
    </div>
    <div class="tc-preset-grid">
        <div class="tc-preset-item" onclick="loadPresetTheme('cyberpunk')">
            <div class="tc-preset-preview" style="background: linear-gradient(135deg, #00ffff, #ff00ff);"></div>
            <span>Cyberpunk</span>
        </div>
        <div class="tc-preset-item" onclick="loadPresetTheme('matrix')">
            <div class="tc-preset-preview" style="background: linear-gradient(135deg, #00ff00, #003300);"></div>
            <span>Matrix</span>
        </div>
        <div class="tc-preset-item" onclick="loadPresetTheme('ocean')">
            <div class="tc-preset-preview" style="background: linear-gradient(135deg, #00bcd4, #001f3f);"></div>
            <span>Ocean</span>
        </div>
        <div class="tc-preset-item" onclick="loadPresetTheme('sunset')">
            <div class="tc-preset-preview" style="background: linear-gradient(135deg, #ff6b6b, #330066);"></div>
            <span>Sunset</span>
        </div>
        <div class="tc-preset-item" onclick="loadPresetTheme('neon')">
            <div class="tc-preset-preview" style="background: linear-gradient(135deg, #ff00ff, #00ffff);"></div>
            <span>Neon</span>
        </div>
        <div class="tc-preset-item" onclick="loadPresetTheme('royal')">
            <div class="tc-preset-preview" style="background: linear-gradient(135deg, #ffd700, #9370db);"></div>
            <span>Royal</span>
        </div>
    </div>
</div>

<style>
/* Theme Customizer Styles */
.theme-customizer {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 900px;
    max-width: 95vw;
    height: 650px;
    max-height: 90vh;
    background: linear-gradient(135deg, rgba(20, 24, 36, 0.98), rgba(10, 14, 26, 0.98));
    backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(139, 92, 246, 0.5);
    border-radius: 20px;
    box-shadow: 
        0 25px 60px rgba(0, 0, 0, 0.7),
        0 0 100px rgba(139, 92, 246, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    animation: tcFadeIn 0.3s ease-out;
}

@keyframes tcFadeIn {
    from {
        opacity: 0;
        transform: translate(-50%, -45%) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
}

.tc-header {
    padding: 20px 25px;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(0, 255, 255, 0.08));
    border-bottom: 1px solid rgba(139, 92, 246, 0.3);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 20px 20px 0 0;
}

.tc-title {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 16px;
    font-weight: 700;
    color: var(--accent-primary);
    text-transform: uppercase;
    letter-spacing: 3px;
}

.tc-title-icon {
    font-size: 24px;
    animation: rotate 10s linear infinite;
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.tc-title-badge {
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 600;
    color: var(--bg-primary);
}

.tc-header-controls {
    display: flex;
    gap: 10px;
}

.tc-preset-btn, .tc-save-btn {
    padding: 8px 20px;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(0, 255, 255, 0.1));
    border: 1px solid var(--border);
    border-radius: 25px;
    color: var(--text-primary);
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.3s;
}

.tc-preset-btn:hover, .tc-save-btn:hover {
    background: linear-gradient(135deg, var(--accent-tertiary), var(--accent-primary));
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(139, 92, 246, 0.4);
}

.tc-close-btn {
    width: 35px;
    height: 35px;
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 50%;
    color: var(--danger);
    font-size: 18px;
    cursor: pointer;
    transition: all 0.3s;
}

.tc-close-btn:hover {
    background: var(--danger);
    color: white;
    transform: rotate(90deg);
}

.tc-body {
    flex: 1;
    display: flex;
    padding: 25px;
    gap: 25px;
    overflow: hidden;
}

.tc-preview {
    width: 350px;
    display: flex;
    flex-direction: column;
}

.tc-preview-header {
    padding: 10px;
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid var(--border);
    border-radius: 10px 10px 0 0;
    text-align: center;
    font-size: 12px;
    font-weight: 600;
    color: var(--accent-primary);
    letter-spacing: 2px;
}

.tc-preview-content {
    flex: 1;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-top: none;
    border-radius: 0 0 10px 10px;
    padding: 15px;
}

.tc-preview-chart {
    height: 200px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 15px;
    position: relative;
    overflow: hidden;
}

.tc-preview-ui {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.tc-preview-panel {
    background: var(--bg-panel);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid var(--border);
}

.tc-preview-price {
    font-size: 24px;
    font-weight: bold;
    color: var(--text-primary);
    text-align: center;
    margin-bottom: 15px;
}

.tc-preview-buy, .tc-preview-sell {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.tc-preview-buy {
    background: var(--success);
    color: white;
}

.tc-preview-sell {
    background: var(--danger);
    color: white;
}

.tc-controls {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.tc-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.tc-tab {
    padding: 10px 20px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 25px;
    color: var(--text-secondary);
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.3s;
}

.tc-tab.active {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(0, 255, 255, 0.1));
    color: var(--accent-primary);
    border-color: var(--accent-primary);
}

.tc-tab:hover {
    transform: translateY(-2px);
}

.tc-tab-content {
    display: none;
    flex: 1;
    overflow-y: auto;
    padding-right: 10px;
}

.tc-tab-content.active {
    display: block;
}

.tc-section {
    margin-bottom: 25px;
}

.tc-section-title {
    font-size: 11px;
    font-weight: 700;
    color: var(--accent-tertiary);
    letter-spacing: 2px;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(139, 92, 246, 0.2);
}

.tc-color-control {
    margin-bottom: 15px;
}

.tc-color-control label {
    display: block;
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 8px;
    font-weight: 500;
}

.tc-color-input-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.tc-color-input-group input[type="color"] {
    width: 50px;
    height: 35px;
    border: 2px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    background: transparent;
}

.tc-hex-input {
    flex: 1;
    padding: 8px 12px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 12px;
    font-family: 'Monaco', 'Courier New', monospace;
    text-transform: uppercase;
}

.tc-color-preview {
    width: 35px;
    height: 35px;
    border-radius: 8px;
    border: 2px solid var(--border);
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
}

.tc-slider-control {
    margin-bottom: 20px;
}

.tc-slider-control label {
    display: block;
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.tc-slider-control input[type="range"] {
    width: 100%;
    margin-bottom: 5px;
}

.tc-slider-control span {
    display: inline-block;
    padding: 4px 10px;
    background: rgba(139, 92, 246, 0.2);
    border-radius: 15px;
    font-size: 11px;
    color: var(--accent-primary);
    font-weight: 600;
}

.tc-toggle-control {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 8px;
    margin-bottom: 10px;
}

.tc-toggle-control label {
    font-size: 12px;
    color: var(--text-secondary);
}

.tc-toggle-control input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.tc-footer {
    padding: 20px 25px;
    background: rgba(139, 92, 246, 0.05);
    border-top: 1px solid var(--border);
    display: flex;
    gap: 10px;
    border-radius: 0 0 20px 20px;
}

.tc-reset-btn, .tc-export-btn, .tc-import-btn {
    padding: 10px 20px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-secondary);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.tc-reset-btn:hover {
    background: var(--danger);
    color: white;
    border-color: var(--danger);
}

.tc-export-btn:hover, .tc-import-btn:hover {
    background: var(--accent-tertiary);
    color: white;
    border-color: var(--accent-tertiary);
}

/* Preset Menu */
.tc-preset-menu {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 500px;
    background: var(--bg-panel);
    border: 2px solid var(--accent-primary);
    border-radius: 15px;
    padding: 20px;
    z-index: 10001;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
}

.tc-preset-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    font-size: 14px;
    font-weight: 600;
    color: var(--accent-primary);
}

.tc-preset-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}

.tc-preset-item {
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.tc-preset-item:hover {
    transform: translateY(-5px);
}

.tc-preset-preview {
    width: 100%;
    height: 80px;
    border-radius: 10px;
    margin-bottom: 8px;
    border: 2px solid var(--border);
}

.tc-preset-item span {
    font-size: 12px;
    color: var(--text-secondary);
}

/* Custom scrollbar for theme customizer */
.tc-tab-content::-webkit-scrollbar {
    width: 6px;
}

.tc-tab-content::-webkit-scrollbar-track {
    background: var(--bg-secondary);
    border-radius: 3px;
}

.tc-tab-content::-webkit-scrollbar-thumb {
    background: var(--accent-tertiary);
    border-radius: 3px;
}

.tc-tab-content::-webkit-scrollbar-thumb:hover {
    background: var(--accent-primary);
}
</style>

<script>
// ================ THEME CUSTOMIZER FUNCTIONS ================

let customTheme = {};
let previewCanvas, previewCtx;

// Initialize Theme Customizer
function initThemeCustomizer() {
    // Get current theme values
    loadCurrentTheme();
    
    // Initialize preview canvas
    previewCanvas = document.getElementById('tcPreviewCanvas');
    if (previewCanvas) {
        previewCtx = previewCanvas.getContext('2d');
        previewCanvas.width = 320;
        previewCanvas.height = 180;
        drawPreviewChart();
    }
    
    // Make customizer draggable
    makeCustomizerDraggable();
}

// Open Theme Customizer
function openThemeCustomizer() {
    document.getElementById('themeCustomizer').style.display = 'flex';
    initThemeCustomizer();
}

// Close Theme Customizer
function closeThemeCustomizer() {
    document.getElementById('themeCustomizer').style.display = 'none';
}

// Load current theme values into customizer
function loadCurrentTheme() {
    const root = document.documentElement;
    const themeVars = [
        '--bg-primary', '--bg-secondary', '--bg-panel',
        '--accent-primary', '--accent-secondary', '--accent-tertiary',
        '--text-primary', '--text-secondary',
        '--success', '--danger', '--warning',
        '--candle-bull', '--candle-bear', '--candle-wick'
    ];
    
    themeVars.forEach(varName => {
        const value = getComputedStyle(root).getPropertyValue(varName).trim();
        customTheme[varName] = value;
        
        // Update color inputs
        const inputId = 'tc' + varName.replace(/-/g, '-');
        const colorInput = document.getElementById(inputId);
        const hexInput = document.getElementById(inputId + '-hex');
        const preview = document.getElementById('preview' + varName.replace(/-/g, '-'));
        
        if (colorInput && value) {
            // Convert to hex if needed
            const hexValue = rgbToHex(value);
            colorInput.value = hexValue;
            if (hexInput) hexInput.value = hexValue;
            if (preview) preview.style.background = value;
        }
    });
}

// Update theme color in real-time
function updateThemeColor(varName, value) {
    document.documentElement.style.setProperty(varName, value);
    customTheme[varName] = value;
    
    // Update hex input
    const hexInputId = 'tc' + varName.replace(/-/g, '-') + '-hex';
    const hexInput = document.getElementById(hexInputId);
    if (hexInput) hexInput.value = value;
    
    // Update preview
    const previewId = 'preview' + varName.replace(/-/g, '-');
    const preview = document.getElementById(previewId);
    if (preview) preview.style.background = value;
    
    // Redraw preview chart if candle colors changed
    if (varName.includes('candle')) {
        drawPreviewChart();
    }
    
    // Redraw main chart
    if (typeof drawChart === 'function') {
        drawChart();
    }
}

// Update theme color from hex input
function updateThemeColorHex(varName, hexValue) {
    if (!hexValue.startsWith('#')) {
        hexValue = '#' + hexValue;
    }
    
    const colorInputId = 'tc' + varName.replace(/-/g, '-');
    const colorInput = document.getElementById(colorInputId);
    if (colorInput) colorInput.value = hexValue;
    
    updateThemeColor(varName, hexValue);
}

// Switch customizer tabs
function switchCustomizerTab(tabName) {
    // Update tabs
    document.querySelectorAll('.tc-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Update content
    document.querySelectorAll('.tc-tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById('tc-' + tabName).classList.add('active');
}

// Draw preview chart
function drawPreviewChart() {
    if (!previewCtx) return;
    
    const width = previewCanvas.width;
    const height = previewCanvas.height;
    
    // Clear canvas
    previewCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary');
    previewCtx.fillRect(0, 0, width, height);
    
    // Draw sample candles
    const candleWidth = 15;
    const spacing = 8;
    const numCandles = 10;
    
    const bullColor = getComputedStyle(document.documentElement).getPropertyValue('--candle-bull');
    const bearColor = getComputedStyle(document.documentElement).getPropertyValue('--candle-bear');
    const wickColor = getComputedStyle(document.documentElement).getPropertyValue('--candle-wick');
    
    for (let i = 0; i < numCandles; i++) {
        const x = i * (candleWidth + spacing) + 20;
        const isBull = Math.random() > 0.5;
        
        // Random heights
        const bodyHeight = Math.random() * 60 + 20;
        const bodyY = Math.random() * (height - bodyHeight - 40) + 20;
        const wickTop = bodyY - Math.random() * 20;
        const wickBottom = bodyY + bodyHeight + Math.random() * 20;
        
        // Draw wick
        previewCtx.strokeStyle = wickColor;
        previewCtx.lineWidth = 1;
        previewCtx.beginPath();
        previewCtx.moveTo(x + candleWidth/2, wickTop);
        previewCtx.lineTo(x + candleWidth/2, wickBottom);
        previewCtx.stroke();
        
        // Draw body
        previewCtx.fillStyle = isBull ? bullColor : bearColor;
        previewCtx.fillRect(x, bodyY, candleWidth, bodyHeight);
    }
}

// Update effects
function updateGlowIntensity(value) {
    document.getElementById('tc-glow-value').textContent = value + '%';
    // Apply glow effect logic here
}

function updateBlurAmount(value) {
    document.getElementById('tc-blur-value').textContent = value + 'px';
    // Apply blur effect logic here
}

function updateBorderOpacity(value) {
    document.getElementById('tc-border-value').textContent = value + '%';
    const opacity = value / 100;
    document.documentElement.style.setProperty('--border', `rgba(139, 92, 246, ${opacity})`);
}

function toggleNeonMode(enabled) {
    if (enabled) {
        document.body.classList.add('neon-mode');
    } else {
        document.body.classList.remove('neon-mode');
    }
}

function toggleGlassEffect(enabled) {
    if (enabled) {
        document.body.classList.add('glass-effect');
    } else {
        document.body.classList.remove('glass-effect');
    }
}

// Save custom theme
function saveCustomTheme() {
    const themeName = prompt('Enter theme name:');
    if (!themeName) return;
    
    const savedThemes = JSON.parse(localStorage.getItem('customThemes') || '{}');
    savedThemes[themeName] = customTheme;
    localStorage.setItem('customThemes', JSON.stringify(savedThemes));
    
    showNotification(`Theme "${themeName}" saved successfully!`, 'success');
}

// Load preset theme
function loadPresetTheme(themeName) {
    if (!themes[themeName]) return;
    
    const theme = themes[themeName];
    for (const [key, value] of Object.entries(theme)) {
        document.documentElement.style.setProperty(key, value);
        customTheme[key] = value;
    }
    
    loadCurrentTheme();
    drawPreviewChart();
    if (typeof drawChart === 'function') {
        drawChart();
    }
    
    closePresetMenu();
    showNotification(`Loaded ${themeName} theme`, 'success');
}

// Open/Close preset menu
function openPresetMenu() {
    document.getElementById('tcPresetMenu').style.display = 'block';
}

function closePresetMenu() {
    document.getElementById('tcPresetMenu').style.display = 'none';
}

// Reset to default theme
function resetToDefault() {
    if (confirm('Reset all colors to default theme?')) {
        loadPresetTheme('cyberpunk');
    }
}

// Export theme
function exportTheme() {
    const themeData = JSON.stringify(customTheme, null, 2);
    const blob = new Blob([themeData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'blueprint-theme.json';
    a.click();
    
    URL.revokeObjectURL(url);
    showNotification('Theme exported successfully!', 'success');
}

// Import theme
function importTheme() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedTheme = JSON.parse(event.target.result);
                
                // Apply imported theme
                for (const [key, value] of Object.entries(importedTheme)) {
                    document.documentElement.style.setProperty(key, value);
                    customTheme[key] = value;
                }
                
                loadCurrentTheme();
                drawPreviewChart();
                if (typeof drawChart === 'function') {
                    drawChart();
                }
                
                showNotification('Theme imported successfully!', 'success');
            } catch (error) {
                showNotification('Invalid theme file!', 'error');
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

// Make customizer draggable
function makeCustomizerDraggable() {
    const customizer = document.getElementById('themeCustomizer');
    const header = customizer.querySelector('.tc-header');
    
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let initialX = 0;
    let initialY = 0;
    
    header.addEventListener('mousedown', startDragging);
    
    function startDragging(e) {
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') {
            return;
        }
        
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        
        const rect = customizer.getBoundingClientRect();
        initialX = rect.left + rect.width/2;
        initialY = rect.top + rect.height/2;
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDragging);
        
        e.preventDefault();
    }
    
    function drag(e) {
        if (!isDragging) return;
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        const newX = initialX + deltaX;
        const newY = initialY + deltaY;
        
        customizer.style.left = newX + 'px';
        customizer.style.top = newY + 'px';
        customizer.style.transform = 'translate(-50%, -50%)';
    }
    
    function stopDragging() {
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', stopDragging);
    }
}

// RGB to Hex converter
function rgbToHex(rgb) {
    if (rgb.startsWith('#')) return rgb;
    if (rgb.startsWith('rgba')) {
        const values = rgb.match(/[\d.]+/g);
        if (values && values.length >= 3) {
            const r = parseInt(values[0]);
            const g = parseInt(values[1]);
            const b = parseInt(values[2]);
            return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
    }
    return rgb;
}
</script>
<!-- History Modal -->
<div id="historyModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-primary); z-index: 3000; display: none;">
    <div style="position: absolute; top: 0; left: 0; right: 0; height: 60px; background: var(--bg-panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 30px;">
        <div style="font-size: 20px; font-weight: bold; color: var(--accent-primary);">Trading History</div>
        <button onclick="closeHistory()" style="width: 40px; height: 40px; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); border-radius: 8px; cursor: pointer; font-size: 20px;">‚úï</button>
    </div>
    <iframe id="historyFrame" style="position: absolute; top: 60px; left: 0; width: 100%; height: calc(100% - 60px); border: none;"></iframe>
</div>
<!-- BPFX Settings Modal -->
<div class="bpfx-settings-modal" id="bpfxSettingsModal" style="
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 450px;
    max-height: 80vh;
    background: var(--bg-panel);
    border: 2px solid var(--accent-primary);
    border-radius: 20px;
    padding: 25px;
    z-index: 10001;
    display: none;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.7), 0 0 60px rgba(0, 255, 255, 0.3);
    overflow-y: auto;
">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--accent-tertiary);">
        <h3 style="color: var(--accent-primary); font-size: 18px; font-weight: bold;"> BPFX Neural Configuration</h3>
        <button onclick="document.getElementById('bpfxSettingsModal').style.display='none'" 
                style="background: var(--danger); color: white; border: none; 
                       width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 16px;">‚úï</button>
    </div>
    
    <!-- CHANNEL SETTINGS -->
    <div style="margin-bottom: 25px;">
        <h4 style="color: var(--accent-primary); margin-bottom: 15px; font-size: 14px;"> CHANNEL SETTINGS</h4>
        
        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 10px;">
            <label style="color: var(--text-secondary); font-size: 12px;">Neural Sensitivity</label>
            <input type="range" id="bpfxSensitivity" min="1" max="100" value="50" style="width: 100%; margin: 10px 0;">
            <div style="text-align: right; color: var(--accent-primary);">Value: <span id="bpfxSensitivityValue">50</span></div>
        </div>
        
        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 10px;">
            <label style="color: var(--text-secondary); font-size: 12px;">Channel Width</label>
            <input type="range" id="bpfxChannelWidth" min="0.5" max="5" step="0.1" value="2.5" style="width: 100%; margin: 10px 0;">
            <div style="text-align: right; color: var(--accent-primary);">Value: <span id="bpfxChannelWidthValue">2.5</span></div>
        </div>
        
        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 10px;">
            <label style="color: var(--text-secondary); font-size: 12px;">Lookback Period</label>
            <input type="range" id="bpfxLookback" min="10" max="500" value="100" style="width: 100%; margin: 10px 0;">
            <div style="text-align: right; color: var(--accent-primary);">Value: <span id="bpfxLookbackValue">100</span></div>
        </div>
    </div>
    
    <!-- VISUAL SETTINGS -->
    <div style="margin-bottom: 25px;">
        <h4 style="color: var(--accent-primary); margin-bottom: 15px; font-size: 14px;"> VISUAL SETTINGS</h4>
        
        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <label style="color: var(--text-secondary); font-size: 12px;">Glow Effect</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="bpfxGlowEffect" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <label style="color: var(--text-secondary); font-size: 12px;">Show Buy/Sell Signals</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="bpfxShowSignals" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <label style="color: var(--text-secondary); font-size: 12px;">Channel Fill</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="bpfxChannelFill" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <label style="color: var(--text-secondary); font-size: 12px;">Show TP/SL Levels</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="bpfxShowTPSL" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>
    
    <!-- RISK MANAGEMENT -->
    <div style="margin-bottom: 25px;">
        <h4 style="color: var(--accent-primary); margin-bottom: 15px; font-size: 14px;"> RISK MANAGEMENT</h4>
        
        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 10px;">
            <label style="color: var(--text-secondary); font-size: 12px;">Stop Loss (Points)</label>
            <input type="range" id="bpfxSLPoints" min="5" max="100" value="20" style="width: 100%; margin: 10px 0;">
            <div style="text-align: right; color: var(--danger);">SL: <span id="bpfxSLPointsValue">20</span> points</div>
        </div>
        
        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 10px;">
            <label style="color: var(--text-secondary); font-size: 12px;">TP1 Ratio</label>
            <input type="range" id="bpfxTP1" min="0.5" max="5" step="0.1" value="1" style="width: 100%; margin: 10px 0;">
            <div style="text-align: right; color: var(--success);">TP1: <span id="bpfxTP1Value">1.0</span>x</div>
        </div>
        
        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 10px;">
            <label style="color: var(--text-secondary); font-size: 12px;">TP2 Ratio</label>
            <input type="range" id="bpfxTP2" min="1" max="10" step="0.1" value="2" style="width: 100%; margin: 10px 0;">
            <div style="text-align: right; color: var(--success);">TP2: <span id="bpfxTP2Value">2.0</span>x</div>
        </div>
        
        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 10px;">
            <label style="color: var(--text-secondary); font-size: 12px;">TP3 Ratio</label>
            <input type="range" id="bpfxTP3" min="2" max="15" step="0.1" value="3" style="width: 100%; margin: 10px 0;">
            <div style="text-align: right; color: var(--success);">TP3: <span id="bpfxTP3Value">3.0</span>x</div>
        </div>
    </div>
    
    <!-- Buttons -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button onclick="resetBPFXSettings()" style="
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--danger);
            border-radius: 10px;
            color: var(--danger);
            cursor: pointer;
        ">Reset</button>
        
        <button onclick="applyBPFXSettings()" style="
            padding: 12px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        ">Apply Settings</button>
    </div>
    <script>
// –î–µ–ª–∞–µ–º BPFX –æ–∫–Ω–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–º
(function() {
    const modal = document.getElementById('bpfxSettingsModal');
    const header = modal.querySelector('div'); // –ü–µ—Ä–≤—ã–π div - —ç—Ç–æ header
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let modalX = 0;
    let modalY = 0;
    
    header.style.cursor = 'move';
    
    header.addEventListener('mousedown', function(e) {
        // –ù–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
        if (e.target.tagName === 'BUTTON') return;
        
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        
        const rect = modal.getBoundingClientRect();
        modalX = rect.left;
        modalY = rect.top;
        
        modal.style.position = 'fixed';
        modal.style.left = modalX + 'px';
        modal.style.top = modalY + 'px';
        modal.style.transform = 'none';
        
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        modal.style.left = (modalX + deltaX) + 'px';
        modal.style.top = (modalY + deltaY) + 'px';
    });
    
    document.addEventListener('mouseup', function() {
        isDragging = false;
    });
})();
</script>
</div>

</body>
</html>